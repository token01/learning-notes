import{_ as o}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as l,c,a as n,b as a,d as s,e as t,r as i}from"./app.9ce56bba.js";const p={},r=n("h2",{id:"parity-wallet-multisig-hack",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#parity-wallet-multisig-hack","aria-hidden":"true"},"#"),a(" Parity Wallet Multisig Hack")],-1),d=n("h2",{id:"第一次攻击",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#第一次攻击","aria-hidden":"true"},"#"),a(" 第一次攻击")],-1),u=n("p",null,"2017年7月19日，Parity multisig Contract 发生黑客事件。",-1),h=n("p",null,"攻击者从 Parity 多重签名合约中转走153,037 ETH",-1),b=n("br",null,null,-1),_={href:"https://etherscan.io/tx/0x9dbf0326a03a2a3719c27be4fa69aacc9857fd231a8d9dcaede4bb083def75ec",target:"_blank",rel:"noopener noreferrer"},f=n("br",null,null,-1),k={href:"https://etherscan.io/tx/0xeef10fc5170f669b86c4cd0444882a96087221325f8bf2f55d6188633aa7be7c",target:"_blank",rel:"noopener noreferrer"},m=n("br",null,null,-1),g={href:"https://etherscan.io/tx/0x97f7662322d56e1c54bd1bab39bccf98bc736fcb9c7e61640e6ff1f633637d38",target:"_blank",rel:"noopener noreferrer"},v=n("br",null,null,-1),x={href:"https://etherscan.io/tx/0x0e0d16475d2ac6a4802437a35a21776e5c9b681a77fef1693b0badbb6afdb083",target:"_blank",rel:"noopener noreferrer"},y={href:"https://github.com/paritytech/parity/blob/4d08e7b0aec46443bf26547b17d10cb302672835/js/src/contracts/snippets/enhanced-wallet.sol#L216",target:"_blank",rel:"noopener noreferrer"},w=n("code",null,"initWallet",-1),j=t(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token comment">// constructor - just pass on the owner array to the multiowned and</span>
  <span class="token comment">// the limit to daylimit</span>
  <span class="token keyword">function</span> <span class="token function">initWallet</span><span class="token punctuation">(</span><span class="token parameter">address<span class="token punctuation">[</span><span class="token punctuation">]</span> _owners<span class="token punctuation">,</span> uint _required<span class="token punctuation">,</span> uint _daylimit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initDaylimit</span><span class="token punctuation">(</span>_daylimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initMultiowned</span><span class="token punctuation">(</span>_owners<span class="token punctuation">,</span> _required<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),W=n("code",null,"initWallet",-1),z={href:"https://solidity.readthedocs.io/en/v0.6.1/types.html#members-of-addresses",target:"_blank",rel:"noopener noreferrer"},E=n("code",null,"delegatecall",-1),B=n("br",null,null,-1),H=n("code",null,"delegatecall",-1),L=n("code",null,"initWallet",-1),N=t(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> payable <span class="token punctuation">{</span>
    <span class="token comment">// just being sent some cash?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token function">Deposit</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      _walletLibrary<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案" aria-hidden="true">#</a> 解决方案</h3><p>解决方案也非常简单，添加了一个修饰限制 <code>initWallet</code> 方法，确保它只能在构建过程中被调用一次。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>modifier only_uninitialized { if (m_numOwners &gt; 0) throw; _; }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="第二次攻击" tabindex="-1"><a class="header-anchor" href="#第二次攻击" aria-hidden="true">#</a> 第二次攻击</h2><p>2017年11月7号，事隔4个月又一次攻击，估计损失可能超过500,000 ETH (1.5亿美元) ，其中包括来自 Web3基金会团队的300,000 ETH。</p><p>最新的攻击并不是针对单个的钱包合同，而是袭击了库合约，这将影响所有依赖于它的钱包合同。</p>`,7),P={href:"https://github.com/paritytech/parity-ethereum/issues/6995",target:"_blank",rel:"noopener noreferrer"},T=n("p",null,"这导致所有依赖于它的钱包合约，将所有调用指向了一个没有代码的合约地址（因为合约已经被 suicide），从而变得无法执行任何操作，因为它们的所有逻辑都依赖于库合约。 换句话说所有的钱包合同立即冻结。",-1),V=n("h2",{id:"最后",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#最后","aria-hidden":"true"},"#"),a(" 最后")],-1),q=n("p",null,[a("其实将逻辑抽象到一个库合约中的技术非常有用。有助于提高代码的可重用性，并降低气体部署成本。但是 bug 无处不在，学习历史，知道历史,是为了少踩坑。"),n("strong",null,"前辈们的成功我们可能无法复制，但学习他们的失败可以帮助我们绕开那些坑")],-1),C=n("hr",null,null,-1),D=n("p",null,"相关报道",-1),I={href:"https://blog.openzeppelin.com/on-the-parity-wallet-multisig-hack-405a8c12e8f7/",target:"_blank",rel:"noopener noreferrer"},M={href:"https://blog.openzeppelin.com/parity-wallet-hack-reloaded/",target:"_blank",rel:"noopener noreferrer"},G={href:"https://blog.springrole.com/parity-multi-sig-wallets-funds-frozen-explained-768ac072763c",target:"_blank",rel:"noopener noreferrer"};function O(S,A){const e=i("ExternalLinkIcon");return l(),c("div",null,[r,d,u,h,n("blockquote",null,[n("p",null,[a("相关交易"),b,n("a",_,[a("https://etherscan.io/tx/0x9dbf0326a03a2a3719c27be4fa69aacc9857fd231a8d9dcaede4bb083def75ec"),s(e)]),f,n("a",k,[a("https://etherscan.io/tx/0xeef10fc5170f669b86c4cd0444882a96087221325f8bf2f55d6188633aa7be7c"),s(e)]),m,n("a",g,[a("https://etherscan.io/tx/0x97f7662322d56e1c54bd1bab39bccf98bc736fcb9c7e61640e6ff1f633637d38"),s(e)]),v,n("a",x,[a("https://etherscan.io/tx/0x0e0d16475d2ac6a4802437a35a21776e5c9b681a77fef1693b0badbb6afdb083"),s(e)])])]),n("p",null,[a("可以看到第一个交易从 "),n("a",y,[w,s(e)]),a(" 开始，它可以更改合约的所有者。")]),j,n("p",null,[a("攻击者调用了合约的 "),W,a(" 方法，为什么呢？主要是这个"),n("a",z,[E,s(e)]),a("。"),B,a(" 合约使用 "),H,a(" 将所有不匹配的函数调用转发给库，这使得来自库的所有公共函数都可以被任何人调用，包括 "),L]),N,n("p",null,[a("11月7号一名 Github 用户 devops199 创建了一个"),n("a",P,[a("issues#6995"),s(e)]),a("ー“任何人都可以取消你的合同”。用户声称，他意外地杀死了合同。")]),T,V,q,C,D,n("ul",null,[n("li",null,[n("a",I,[a("https://blog.openzeppelin.com/on-the-parity-wallet-multisig-hack-405a8c12e8f7/"),s(e)])]),n("li",null,[n("a",M,[a("https://blog.openzeppelin.com/parity-wallet-hack-reloaded/"),s(e)])]),n("li",null,[n("a",G,[a("https://blog.springrole.com/parity-multi-sig-wallets-funds-frozen-explained-768ac072763c"),s(e)])])])])}const K=o(p,[["render",O],["__file","blackchain-bug-parity-wallets.html.vue"]]);export{K as default};
