import{_ as n}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as s,c as a,f as t}from"./app.9b1ca880.js";const p={},e=t(`<h1 id="\u540E\u53F0\u7BA1\u7406-oss\u5BF9\u8C61\u5B58\u50A8\u9002\u914D" tabindex="-1"><a class="header-anchor" href="#\u540E\u53F0\u7BA1\u7406-oss\u5BF9\u8C61\u5B58\u50A8\u9002\u914D" aria-hidden="true">#</a> \u540E\u53F0\u7BA1\u7406 - OSS\u5BF9\u8C61\u5B58\u50A8\u9002\u914D</h1><h2 id="_1-\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-\u6D41\u7A0B" aria-hidden="true">#</a> 1. \u6D41\u7A0B</h2><h3 id="_1-1-\u901A\u8FC7applicationrunner-\u5728\u9879\u76EE\u542F\u52A8\u7684\u65F6\u5019\u3001\u521D\u59CB\u5316" tabindex="-1"><a class="header-anchor" href="#_1-1-\u901A\u8FC7applicationrunner-\u5728\u9879\u76EE\u542F\u52A8\u7684\u65F6\u5019\u3001\u521D\u59CB\u5316" aria-hidden="true">#</a> 1.1 \u901A\u8FC7ApplicationRunner \u5728\u9879\u76EE\u542F\u52A8\u7684\u65F6\u5019\u3001\u521D\u59CB\u5316</h3><ol><li>\u4ECE\u6570\u636E\u5E93\u4E2D\u53D6\u51FA\u4E2D\u5B58\u50A8\u72B6\u6001\u6B63\u5E38\u7684oos\u914D\u7F6E\u3001\u5E76\u8BBE\u7F6E\u5230redis\u4E2D</li><li>\u901A\u8FC7redis \u7684\u53D1\u5E03\u8BA2\u9605\u3001\u901A\u77E5\u5176\u4ED6\u670D\u52A1\u5668\u5237\u65B0\u914D\u7F6E</li><li>\u521D\u59CB\u5316OSS\u5DE5\u5382\u3001\u5B9E\u4F8B\u5316OssClient</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceApplicationRunner</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ISysOssConfigService</span> ossConfigService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ossConfigService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u521D\u59CB\u5316OSS\u914D\u7F6E\u6210\u529F&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * \u9879\u76EE\u542F\u52A8\u65F6\uFF0C\u521D\u59CB\u5316\u53C2\u6570\u5230\u7F13\u5B58\uFF0C\u52A0\u8F7D\u914D\u7F6E\u7C7B
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssConfig</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u52A0\u8F7DOSS\u521D\u59CB\u5316\u914D\u7F6E</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysOssConfig</span> config <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> configKey <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CONFIG_KEY</span><span class="token punctuation">,</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">setConfigCache</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u521D\u59CB\u5316OSS\u5DE5\u5382</span>
        <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**
     * \u5982\u679C\u64CD\u4F5C\u6210\u529F \u5219\u66F4\u65B0\u7F13\u5B58
     *
     * <span class="token keyword">@param</span> <span class="token parameter">flag</span>   \u64CD\u4F5C\u72B6\u6001
     * <span class="token keyword">@param</span> <span class="token parameter">config</span> \u914D\u7F6E
     * <span class="token keyword">@return</span> \u8FD4\u56DE\u64CD\u4F5C\u72B6\u6001
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setConfigCache</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> flag<span class="token punctuation">,</span> <span class="token class-name">SysOssConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CacheUtils</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheNames</span><span class="token punctuation">.</span><span class="token constant">SYS_OSS_CONFIG</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CONFIG_KEY</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u53D1\u5E03\u5237\u65B0OSS\u914D\u7F6E =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OssFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OssClient</span><span class="token punctuation">&gt;</span></span> <span class="token constant">CLIENT_CACHE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u521D\u59CB\u5316\u5DE5\u5382
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u521D\u59CB\u5316OSS\u5DE5\u5382&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CONFIG_KEY</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> configKey <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">OssClient</span> client <span class="token operator">=</span> <span class="token function">getClient</span><span class="token punctuation">(</span>configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u672A\u521D\u59CB\u5316\u4E0D\u5904\u7406</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">refresh</span><span class="token punctuation">(</span>configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BA2\u9605\u5237\u65B0OSS\u914D\u7F6E =&gt; &quot;</span> <span class="token operator">+</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token class-name">String</span> configKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">CacheUtils</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CacheNames</span><span class="token punctuation">.</span><span class="token constant">SYS_OSS_CONFIG</span><span class="token punctuation">,</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OssException</span><span class="token punctuation">(</span><span class="token string">&quot;\u7CFB\u7EDF\u5F02\u5E38, &#39;&quot;</span> <span class="token operator">+</span> configKey <span class="token operator">+</span> <span class="token string">&quot;&#39;\u914D\u7F6E\u4FE1\u606F\u4E0D\u5B58\u5728!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">OssProperties</span> properties <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">OssProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">CLIENT_CACHE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configKey<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OssClient</span><span class="token punctuation">(</span>configKey<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u521B\u5EFAOssClient,\u521B\u5EFA\u6876\u4E0E\u54CD\u5E94\u7684\u534F\u8BAE</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">OssClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> configKey<span class="token punctuation">,</span> <span class="token class-name">OssProperties</span> ossProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>configKey <span class="token operator">=</span> configKey<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> ossProperties<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">AwsClientBuilder<span class="token punctuation">.</span>EndpointConfiguration</span> endpointConfig <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">AwsClientBuilder<span class="token punctuation">.</span>EndpointConfiguration</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AWSCredentials</span> credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicAWSCredentials</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getAccessKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">getSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AWSCredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWSStaticCredentialsProvider</span><span class="token punctuation">(</span>credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClientConfiguration</span> clientConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">IS_HTTPS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getIsHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            clientConfig<span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token constant">HTTPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            clientConfig<span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token constant">HTTP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">AmazonS3ClientBuilder</span> build <span class="token operator">=</span> <span class="token class-name">AmazonS3Client</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withEndpointConfiguration</span><span class="token punctuation">(</span>endpointConfig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withClientConfiguration</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withCredentials</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">disableChunkedEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsAny</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">CLOUD_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// minio \u4F7F\u7528https\u9650\u5236\u4F7F\u7528\u57DF\u540D\u8BBF\u95EE \u9700\u8981\u6B64\u914D\u7F6E \u7AD9\u70B9\u586B\u57DF\u540D</span>
            build<span class="token punctuation">.</span><span class="token function">enablePathStyleAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">createBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">OssException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OssException</span><span class="token punctuation">(</span><span class="token string">&quot;\u914D\u7F6E\u9519\u8BEF! \u8BF7\u68C0\u67E5\u7CFB\u7EDF\u914D\u7F6E:[&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> bucketName <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getBucketName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">doesBucketExistV2</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">CreateBucketRequest</span> createBucketRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateBucketRequest</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AccessPolicyType</span> accessPolicy <span class="token operator">=</span> <span class="token function">getAccessPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        createBucketRequest<span class="token punctuation">.</span><span class="token function">setCannedAcl</span><span class="token punctuation">(</span>accessPolicy<span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">createBucket</span><span class="token punctuation">(</span>createBucketRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">setBucketPolicy</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">,</span> <span class="token function">getPolicy</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">,</span> accessPolicy<span class="token punctuation">.</span><span class="token function">getPolicyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OssException</span><span class="token punctuation">(</span><span class="token string">&quot;\u521B\u5EFABucket\u5931\u8D25, \u8BF7\u6838\u5BF9\u914D\u7F6E\u4FE1\u606F:[&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u5F53\u524D\u6876\u6743\u9650\u7C7B\u578B
     *
     * <span class="token keyword">@return</span> \u5F53\u524D\u6876\u6743\u9650\u7C7B\u578Bcode
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">AccessPolicyType</span> <span class="token function">getAccessPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessPolicyType</span><span class="token punctuation">.</span><span class="token function">getByType</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getAccessPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getPolicy</span><span class="token punctuation">(</span><span class="token class-name">String</span> bucketName<span class="token punctuation">,</span> <span class="token class-name">PolicyType</span> policyType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;{\\n\\&quot;Statement\\&quot;: [\\n{\\n\\&quot;Action\\&quot;: [\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>policyType <span class="token operator">==</span> <span class="token class-name">PolicyType</span><span class="token punctuation">.</span><span class="token constant">WRITE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;s3:GetBucketLocation\\&quot;,\\n\\&quot;s3:ListBucketMultipartUploads\\&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>policyType <span class="token operator">==</span> <span class="token class-name">PolicyType</span><span class="token punctuation">.</span><span class="token constant">READ_WRITE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;s3:GetBucketLocation\\&quot;,\\n\\&quot;s3:ListBucket\\&quot;,\\n\\&quot;s3:ListBucketMultipartUploads\\&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;s3:GetBucketLocation\\&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;],\\n\\&quot;Effect\\&quot;: \\&quot;Allow\\&quot;,\\n\\&quot;Principal\\&quot;: \\&quot;*\\&quot;,\\n\\&quot;Resource\\&quot;: \\&quot;arn:aws:s3:::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;\\n},\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>policyType <span class="token operator">==</span> <span class="token class-name">PolicyType</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;{\\n\\&quot;Action\\&quot;: [\\n\\&quot;s3:ListBucket\\&quot;\\n],\\n\\&quot;Effect\\&quot;: \\&quot;Deny\\&quot;,\\n\\&quot;Principal\\&quot;: \\&quot;*\\&quot;,\\n\\&quot;Resource\\&quot;: \\&quot;arn:aws:s3:::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;\\n},\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;{\\n\\&quot;Action\\&quot;: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>policyType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">WRITE</span><span class="token operator">:</span>
                builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;[\\n\\&quot;s3:AbortMultipartUpload\\&quot;,\\n\\&quot;s3:DeleteObject\\&quot;,\\n\\&quot;s3:ListMultipartUploadParts\\&quot;,\\n\\&quot;s3:PutObject\\&quot;\\n],\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">READ_WRITE</span><span class="token operator">:</span>
                builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;[\\n\\&quot;s3:AbortMultipartUpload\\&quot;,\\n\\&quot;s3:DeleteObject\\&quot;,\\n\\&quot;s3:GetObject\\&quot;,\\n\\&quot;s3:ListMultipartUploadParts\\&quot;,\\n\\&quot;s3:PutObject\\&quot;\\n],\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;s3:GetObject\\&quot;,\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;Effect\\&quot;: \\&quot;Allow\\&quot;,\\n\\&quot;Principal\\&quot;: \\&quot;*\\&quot;,\\n\\&quot;Resource\\&quot;: \\&quot;arn:aws:s3:::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;/*\\&quot;\\n}\\n],\\n\\&quot;Version\\&quot;: \\&quot;2012-10-17\\&quot;\\n}\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-\u4E0A\u4F20\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_1-2-\u4E0A\u4F20\u6587\u4EF6" aria-hidden="true">#</a> 1.2 \u4E0A\u4F20\u6587\u4EF6</h3><ol><li>\u4E0A\u4F20oss</li><li>\u4FDD\u5B58\u6587\u4EF6\u4FE1\u606F\u5230\u6570\u636E\u5E93</li><li>\u8FD4\u56DE\u6587\u4EF6\u7B80\u5355VO</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u6587\u4EF6\u670D\u52A1
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RemoteFileService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * \u4E0A\u4F20\u6587\u4EF6
     *
     * <span class="token keyword">@param</span> <span class="token parameter">file</span> \u6587\u4EF6\u4FE1\u606F
     * <span class="token keyword">@return</span> \u7ED3\u679C
     */</span>
    <span class="token class-name">SysFile</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> originalFilename<span class="token punctuation">,</span> <span class="token class-name">String</span> contentType<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServiceException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RemoteFileServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RemoteFileService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysOssMapper</span> sysOssMapper<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u6587\u4EF6\u4E0A\u4F20\u8BF7\u6C42
     */</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SysFile</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> originalFilename<span class="token punctuation">,</span> <span class="token class-name">String</span> contentType<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServiceException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> suffix <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">,</span> originalFilename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalFilename<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">OssClient</span> storage <span class="token operator">=</span> <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UploadResult</span> uploadResult <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">uploadSuffix</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u4FDD\u5B58\u6587\u4EF6\u4FE1\u606F</span>
            <span class="token class-name">SysOss</span> oss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysOss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            oss<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            oss<span class="token punctuation">.</span><span class="token function">setFileSuffix</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oss<span class="token punctuation">.</span><span class="token function">setFileName</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            oss<span class="token punctuation">.</span><span class="token function">setOriginalName</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oss<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sysOssMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>oss<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SysFile</span> sysFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sysFile<span class="token punctuation">.</span><span class="token function">setOssId</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getOssId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sysFile<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sysFile<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sysFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-\u67E5\u8BE2\u8D44\u6E90" tabindex="-1"><a class="header-anchor" href="#_1-3-\u67E5\u8BE2\u8D44\u6E90" aria-hidden="true">#</a> 1.3 \u67E5\u8BE2\u8D44\u6E90</h3><p>\u5982\u679C\u662F\u79C1\u6709\u8D44\u6E90\u3001\u9700\u8981\u5BF9\u8D44\u6E90\u8BBE\u7F6E\u4E34\u65F6\u8BBF\u95EE\u6743\u9650</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TableDataInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryPageList</span><span class="token punctuation">(</span><span class="token class-name">SysOssBo</span> bo<span class="token punctuation">,</span> <span class="token class-name">PageQuery</span> pageQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOss</span><span class="token punctuation">&gt;</span></span> lqw <span class="token operator">=</span> <span class="token function">buildQueryWrapper</span><span class="token punctuation">(</span>bo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectVoPage</span><span class="token punctuation">(</span>pageQuery<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lqw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> filterResult <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">matchingUrl</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>filterResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">TableDataInfo</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u5339\u914DUrl
 *
 * <span class="token keyword">@param</span> <span class="token parameter">oss</span> OSS\u5BF9\u8C61
 * <span class="token keyword">@return</span> oss \u5339\u914DUrl\u7684OSS\u5BF9\u8C61
 */</span>
<span class="token keyword">private</span> <span class="token class-name">SysOssVo</span> <span class="token function">matchingUrl</span><span class="token punctuation">(</span><span class="token class-name">SysOssVo</span> oss<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OssClient</span> storage <span class="token operator">=</span> <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u4EC5\u4FEE\u6539\u6876\u7C7B\u578B\u4E3A private \u7684URL\uFF0C\u4E34\u65F6URL\u65F6\u957F\u4E3A120s</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AccessPolicyType</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span> <span class="token operator">==</span> storage<span class="token punctuation">.</span><span class="token function">getAccessPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oss<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getPrivateUrl</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oss<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPrivateUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> objectKey<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">GeneratePresignedUrlRequest</span> generatePresignedUrlRequest <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">GeneratePresignedUrlRequest</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getBucketName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objectKey<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withMethod</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000L</span> <span class="token operator">*</span> second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URL</span> url <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">generatePresignedUrl</span><span class="token punctuation">(</span>generatePresignedUrlRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,18),o=[e];function c(l,i){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","manage-system-oos.html.vue"]]);export{r as default};
