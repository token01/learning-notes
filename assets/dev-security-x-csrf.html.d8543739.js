import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o,c,a as n,b as s,d as t,f as e,r as l}from"./app.5777c881.js";const i={},u=e('<h1 id="\u5F00\u53D1\u5B89\u5168-csrf\u8BE6\u89E3" tabindex="-1"><a class="header-anchor" href="#\u5F00\u53D1\u5B89\u5168-csrf\u8BE6\u89E3" aria-hidden="true">#</a> \u5F00\u53D1\u5B89\u5168 - CSRF\u8BE6\u89E3</h1><blockquote><p>CSRF(Cross-site request forgery\u8DE8\u7AD9\u8BF7\u6C42\u4F2A\u9020\uFF0C\u4E5F\u88AB\u79F0\u6210\u4E3A\u201Cone click attack\u201D\u6216\u8005session riding\uFF0C\u901A\u5E38\u7F29\u5199\u4E3ACSRF\u6216\u8005XSRF\uFF0C\u662F\u4E00\u79CD\u5BF9\u7F51\u7AD9\u7684\u6076\u610F\u5229\u7528\u3002</p></blockquote><blockquote><p>\u524D\u7F6E\u77E5\u8BC6\uFF1A</p><p>\u5982\u679C\u5BA2\u6237\u7AEF\u53D1\u9001\u7684http\u8BF7\u6C42\u662F\u540C\u57DF\u7684\uFF0C<strong>\u6D4F\u89C8\u5668</strong>\u4F1A<strong>\u81EA\u52A8</strong>\u5E2E\u6211\u4EEC\u628A<strong>\u540C\u57DF</strong>\u4E0B\u7684cookie\u6DFB\u52A0\u5230\u8BF7\u6C42\u7684<strong>request header</strong>\u4E2D<strong>Cookie\u5B57\u6BB5</strong>\u4E2D\uFF0C\u670D\u52A1\u7AEF\u5C31\u4F1A\u4ECE\u63A5\u6536\u5230\u7684request header\u4E2D\u63D0\u53D6cookie\u4E2D\u7684token</p></blockquote><blockquote><p>\u6211\u53C2\u4E0E\u7684\u9879\u76EE\u4E2D\u5927\u90E8\u5206\u90FD\u4F7F\u7528token \u4F20\u9012\u7528\u6237\u4FE1\u606F\uFF0C\u4E0D\u4F7F\u7528session\uFF0C\u6240\u4EE5\u53EF\u4EE5\u76F4\u63A5\u7981\u6B62CSRF\u3002</p></blockquote><h2 id="_1-csrf-\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#_1-csrf-\u7B80\u4ECB" aria-hidden="true">#</a> 1. CSRF \u7B80\u4ECB</h2><p>\u653B\u51FB\u8005\u76D7\u7528\u4F60\u7684\u8EAB\u4EFD\uFF0C\u4EE5\u4F60\u7684\u540D\u4E49\u53D1\u9001\u6076\u610F\u8BF7\u6C42\u3002</p><blockquote><p>CSRF\uFF08Cross Site Request Forgery, \u8DE8\u7AD9\u57DF\u8BF7\u6C42\u4F2A\u9020\uFF09\u662F\u4E00\u79CD\u7F51\u7EDC\u7684\u653B\u51FB\u65B9\u5F0F\uFF0C\u5B83\u5728 2007 \u5E74\u66FE\u88AB\u5217\u4E3A\u4E92\u8054\u7F51 20 \u5927\u5B89\u5168\u9690\u60A3\u4E4B\u4E00\u3002\u5176\u4ED6\u5B89\u5168\u9690\u60A3\uFF0C\u6BD4\u5982 SQL \u811A\u672C\u6CE8\u5165\uFF0C\u8DE8\u7AD9\u57DF\u811A\u672C\u653B\u51FB\u7B49\u5728\u8FD1\u5E74\u6765\u5DF2\u7ECF\u9010\u6E10\u4E3A\u4F17\u4EBA\u719F\u77E5\uFF0C\u5F88\u591A\u7F51\u7AD9\u4E5F\u90FD\u9488\u5BF9\u4ED6\u4EEC\u8FDB\u884C\u4E86\u9632\u5FA1\u3002\u7136\u800C\uFF0C\u5BF9\u4E8E\u5927\u591A\u6570\u4EBA\u6765\u8BF4\uFF0CCSRF \u5374\u4F9D\u7136\u662F\u4E00\u4E2A\u964C\u751F\u7684\u6982\u5FF5\u3002\u5373\u4FBF\u662F\u5927\u540D\u9F0E\u9F0E\u7684 Gmail, \u5728 2007 \u5E74\u5E95\u4E5F\u5B58\u5728\u7740 CSRF \u6F0F\u6D1E\uFF0C\u4ECE\u800C\u88AB\u9ED1\u5BA2\u653B\u51FB\u800C\u4F7F Gmail \u7684\u7528\u6237\u9020\u6210\u5DE8\u5927\u7684\u635F\u5931\u3002</p></blockquote><h2 id="_2-csrf-\u5982\u4F55\u653B\u51FB" tabindex="-1"><a class="header-anchor" href="#_2-csrf-\u5982\u4F55\u653B\u51FB" aria-hidden="true">#</a> 2. CSRF \u5982\u4F55\u653B\u51FB</h2><p><strong>\u5148\u770B\u56FE</strong>\uFF1A</p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220705223234175.png" alt="image-20220705223234175"><p>\u4ECE\u4E0A\u56FE\u53EF\u4EE5\u770B\u51FA\uFF0CA\u7F51\u7AD9\u901A\u8FC7cookie\u6765\u8BC6\u522B\u7528\u6237\uFF08C\uFF09\uFF0C\u5F53\u7528\u6237\u6210\u529F\u8FDB\u884C\u8EAB\u4EFD\u9A8C\u8BC1\u4E4B\u540E\u6D4F\u89C8\u5668\u5C31\u4F1A\u5F97\u5230\u4E00\u4E2A\u6807\u8BC6\u5176\u8EAB\u4EFD\u7684cookie\uFF0C\u53EA\u8981\u4E0D\u5173\u95ED\u6D4F\u89C8\u5668\u6216\u8005\u9000\u51FA\u767B\u5F55\uFF0C\u4EE5\u540E\u8BBF\u95EEA\u7F51\u7AD9\u4F1A\u4E00\u76F4\u5E26\u4E0A\u8FD9\u4E2Acookie\u3002\u5982\u679C\u8FD9\u671F\u95F4\u6D4F\u89C8\u5668\u88AB\u4EBA\u63A7\u5236\u7740\u5411A\u7F51\u7AD9\u53D1\u8D77\u8BF7\u6C42\u53BB\u6267\u884C\u4E00\u4E9B\u7528\u6237\u4E0D\u60F3\u505A\u7684\u529F\u80FD\uFF08\u6BD4\u5982\u6DFB\u52A0\u8D26\u53F7\uFF09\uFF0C\u8FD9\u5C31\u662F\u4F1A\u8BDD\u52AB\u6301\u4E86\u3002\u56E0\u4E3A\u8FD9\u4E2A\u4E0D\u662F\u7528\u6237\u771F\u6B63\u60F3\u53D1\u51FA\u7684\u8BF7\u6C42\uFF0C\u8FD9\u5C31\u662F\u6240\u8C13\u7684\u201C\u8BF7\u6C42\u4F2A\u9020\u201D\u3002\u6B64\u5916\uFF0C<strong>\u7531\u4E8E\u8BF7\u6C42\u53EF\u4EE5\u4ECE\u7B2C\u4E09\u65B9\u7F51\u7AD9\u63D0\u4EA4\uFF0C\u6240\u4EE5\u524D\u7F00\u8DE8\u7AD9\u4E8C\u5B57\uFF0C\u5373\u4ECEB\u7F51\u7AD9\u53D1\u8D77\u3002</strong></p><h3 id="_2-1-\u5177\u4F53\u5230\u94F6\u884C\u8F6C\u8D26\u4E3A\u4F8B" tabindex="-1"><a class="header-anchor" href="#_2-1-\u5177\u4F53\u5230\u94F6\u884C\u8F6C\u8D26\u4E3A\u4F8B" aria-hidden="true">#</a> 2.1 <strong>\u5177\u4F53\u5230\u94F6\u884C\u8F6C\u8D26\u4E3A\u4F8B</strong>\uFF1A</h3><blockquote><p>CSRF \u653B\u51FB\u53EF\u4EE5\u5728\u53D7\u5BB3\u8005\u6BEB\u4E0D\u77E5\u60C5\u7684\u60C5\u51B5\u4E0B\u4EE5\u53D7\u5BB3\u8005\u540D\u4E49\u4F2A\u9020\u8BF7\u6C42\u53D1\u9001\u7ED9\u53D7\u653B\u51FB\u7AD9\u70B9\uFF0C\u4ECE\u800C\u5728\u5E76\u672A\u6388\u6743\u7684\u60C5\u51B5\u4E0B\u6267\u884C\u5728\u6743\u9650\u4FDD\u62A4\u4E4B\u4E0B\u7684\u64CD\u4F5C\u3002</p></blockquote>',13),k={href:"http://bank.example/withdraw?account=bob&amount=1000000&for=bob2",target:"_blank",rel:"noopener noreferrer"},r=n("li",null,[n("p",null,"\u901A\u5E38\u60C5\u51B5\u4E0B\uFF0C\u8BE5\u8BF7\u6C42\u53D1\u9001\u5230\u7F51\u7AD9\u540E\uFF0C\u670D\u52A1\u5668\u4F1A\u5148\u9A8C\u8BC1\u8BE5\u8BF7\u6C42\u662F\u5426\u6765\u81EA\u4E00\u4E2A\u5408\u6CD5\u7684 session\uFF0C\u5E76\u4E14\u8BE5 session \u7684\u7528\u6237 Bob \u5DF2\u7ECF\u6210\u529F\u767B\u9646\u3002")],-1),d={href:"http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory%E3%80%82",target:"_blank",rel:"noopener noreferrer"},v=n("blockquote",null,[n("p",null,"\u8FD9\u65F6\u5019\u9ED1\u5BA2\u4FEE\u6539url \u53C2\u6570\uFF0C\u5C06\u8F6C\u8D26\u7684\u6536\u6B3E\u8D26\u6237\u6539\u6210\u81EA\u5DF1")],-1),m={href:"http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory",target:"_blank",rel:"noopener noreferrer"},b=n("strong",null,"\u5E76\u4E14\u901A\u8FC7\u5E7F\u544A\u7B49\u8BF1\u4F7F Bob \u6765\u8BBF\u95EE\u4ED6\u7684\u7F51\u7AD9",-1),f=n("blockquote",null,[n("p",null,"\u7528\u6237\u6253\u5F00\u4E86\u9ED1\u5BA2\u7684\u7F51\u7AD9B")],-1),g=n("li",null,[n("p",null,"\u5F53 Bob \u8BBF\u95EE\u8BE5\u7F51\u7AD9\u65F6\uFF0C\u4E0A\u8FF0 url \u5C31\u4F1A\u4ECE Bob \u7684\u6D4F\u89C8\u5668\u53D1\u5411\u94F6\u884C\uFF0C\u800C\u8FD9\u4E2A\u8BF7\u6C42\u4F1A\u9644\u5E26 Bob \u6D4F\u89C8\u5668\u4E2D\u7684 cookie \u4E00\u8D77\u53D1\u5411\u94F6\u884C\u670D\u52A1\u5668\u3002\u5927\u591A\u6570\u60C5\u51B5\u4E0B\uFF0C\u8BE5\u8BF7\u6C42\u4F1A\u5931\u8D25\uFF0C\u56E0\u4E3A\u4ED6\u8981\u6C42 Bob \u7684\u8BA4\u8BC1\u4FE1\u606F\u3002")],-1),h=n("li",null,[n("p",null,"\u4F46\u662F\uFF0C\u5982\u679C Bob \u5F53\u65F6\u6070\u5DE7\u521A\u8BBF\u95EE\u4ED6\u7684\u94F6\u884C\u540E\u4E0D\u4E45\uFF0C\u4ED6\u7684\u6D4F\u89C8\u5668\u4E0E\u94F6\u884C\u7F51\u7AD9\u4E4B\u95F4\u7684 session \u5C1A\u672A\u8FC7\u671F\uFF0C\u6D4F\u89C8\u5668\u7684 cookie \u4E4B\u4E2D\u542B\u6709 Bob \u7684\u8BA4\u8BC1\u4FE1\u606F\u3002\u8FD9\u65F6\uFF0C\u60B2\u5267\u53D1\u751F\u4E86\uFF0C\u8FD9\u4E2A url \u8BF7\u6C42\u5C31\u4F1A\u5F97\u5230\u54CD\u5E94\uFF0C\u94B1\u5C06\u4ECE Bob \u7684\u8D26\u53F7\u8F6C\u79FB\u5230 Mallory \u7684\u8D26\u53F7\uFF0C\u800C Bob \u5F53\u65F6\u6BEB\u4E0D\u77E5\u60C5\u3002\u7B49\u4EE5\u540E Bob \u53D1\u73B0\u8D26\u6237\u94B1\u5C11\u4E86\uFF0C\u5373\u4F7F\u4ED6\u53BB\u94F6\u884C\u67E5\u8BE2\u65E5\u5FD7\uFF0C\u4ED6\u4E5F\u53EA\u80FD\u53D1\u73B0\u786E\u5B9E\u6709\u4E00\u4E2A\u6765\u81EA\u4E8E\u4ED6\u672C\u4EBA\u7684\u5408\u6CD5\u8BF7\u6C42\u8F6C\u79FB\u4E86\u8D44\u91D1\uFF0C\u6CA1\u6709\u4EFB\u4F55\u88AB\u653B\u51FB\u7684\u75D5\u8FF9\u3002\u800C Mallory \u5219\u53EF\u4EE5\u62FF\u5230\u94B1\u540E\u900D\u9065\u6CD5\u5916\u3002"),n("blockquote",null,[n("p",null,"\u5927\u90E8\u5206\u60C5\u51B5cookie \u8BA4\u8BC1\u4FE1\u606F\u662F\u5931\u6548\u7684\uFF0C\u4F46\u5982\u679C\u6700\u8FD1\u8BBF\u95EE\u8FC7\uFF0C\u5728\u6709\u6548\u671F\u5185\u5C31\u4F1A\u8F6C\u8D26\u6210\u529F")])],-1),y=e(`<h2 id="_3-csrf-\u7406\u89E3\u7684\u6CE8\u610F\u70B9" tabindex="-1"><a class="header-anchor" href="#_3-csrf-\u7406\u89E3\u7684\u6CE8\u610F\u70B9" aria-hidden="true">#</a> 3. CSRF \u7406\u89E3\u7684\u6CE8\u610F\u70B9</h2><blockquote><p>\u8981\u7406\u89E3CSRF\uFF0C\u6211\u8BA4\u4E3A\u4F60\u9700\u8981\u7406\u89E3\u5982\u4E0B\u51E0\u4E2A\u95EE\u9898\uFF1A</p></blockquote><h3 id="_3-1-\u9ED1\u5BA2\u80FD\u62FF\u5230cookie\u5417" tabindex="-1"><a class="header-anchor" href="#_3-1-\u9ED1\u5BA2\u80FD\u62FF\u5230cookie\u5417" aria-hidden="true">#</a> 3.1 \u9ED1\u5BA2\u80FD\u62FF\u5230Cookie\u5417?</h3><blockquote><p>CSRF \u653B\u51FB\u662F\u9ED1\u5BA2\u501F\u52A9\u53D7\u5BB3\u8005\u7684 cookie \u9A97\u53D6\u670D\u52A1\u5668\u7684\u4FE1\u4EFB\uFF0C\u4F46\u662F\u9ED1\u5BA2\u5E76\u4E0D\u80FD\u62FF\u5230 cookie\uFF0C\u4E5F\u770B\u4E0D\u5230 cookie \u7684\u5185\u5BB9\u3002</p></blockquote><p>\u5BF9\u4E8E\u670D\u52A1\u5668\u8FD4\u56DE\u7684\u7ED3\u679C\uFF0C\u7531\u4E8E\u6D4F\u89C8\u5668\u540C\u6E90\u7B56\u7565\u7684\u9650\u5236\uFF0C\u9ED1\u5BA2\u4E5F\u65E0\u6CD5\u8FDB\u884C\u89E3\u6790\u3002\u56E0\u6B64\uFF0C<strong>\u9ED1\u5BA2\u65E0\u6CD5\u4ECE\u8FD4\u56DE\u7684\u7ED3\u679C\u4E2D\u5F97\u5230\u4EFB\u4F55\u4E1C\u897F\uFF0C\u4ED6\u6240\u80FD\u505A\u7684\u5C31\u662F\u7ED9\u670D\u52A1\u5668\u53D1\u9001\u8BF7\u6C42</strong>\uFF0C\u4EE5\u6267\u884C\u8BF7\u6C42\u4E2D\u6240\u63CF\u8FF0\u7684\u547D\u4EE4\uFF0C\u5728\u670D\u52A1\u5668\u7AEF\u76F4\u63A5\u6539\u53D8\u6570\u636E\u7684\u503C\uFF0C\u800C\u975E\u7A83\u53D6\u670D\u52A1\u5668\u4E2D\u7684\u6570\u636E\u3002</p><h3 id="_3-2-\u4EC0\u4E48\u6837\u7684\u8BF7\u6C42\u662F\u8981csrf\u4FDD\u62A4\u7684" tabindex="-1"><a class="header-anchor" href="#_3-2-\u4EC0\u4E48\u6837\u7684\u8BF7\u6C42\u662F\u8981csrf\u4FDD\u62A4\u7684" aria-hidden="true">#</a> 3.2 \u4EC0\u4E48\u6837\u7684\u8BF7\u6C42\u662F\u8981CSRF\u4FDD\u62A4\u7684?</h3><blockquote><p>\u4E3A\u4EC0\u4E48\u6709\u4E9B\u6846\u67B6\uFF08\u6BD4\u5982Spring Security)\u91CC\u9632\u62A4CSRF\u7684filter\u9650\u5B9A\u7684Method\u662FPOST/PUT/DELETE\u7B49\uFF0C\u800C\u6CA1\u6709\u9650\u5B9AGET Method?</p></blockquote><p>\u6211\u4EEC\u8981\u4FDD\u62A4\u7684\u5BF9\u8C61\u662F\u90A3\u4E9B\u53EF\u4EE5\u76F4\u63A5\u4EA7\u751F\u6570\u636E\u6539\u53D8\u7684\u670D\u52A1\uFF0C\u800C\u5BF9\u4E8E\u8BFB\u53D6\u6570\u636E\u7684\u670D\u52A1\uFF0C\u5219\u4E0D\u9700\u8981\u8FDB\u884C CSRF \u7684\u4FDD\u62A4\u3002\u901A\u5E38\u800C\u8A00GET\u8BF7\u4F5C\u4E3A\u8BF7\u6C42\u6570\u636E\uFF0C\u4E0D\u4F5C\u4E3A\u4FEE\u6539\u6570\u636E\uFF0C\u6240\u4EE5\u8FD9\u4E9B\u6846\u67B6\u6CA1\u6709\u62E6\u622AGet\u7B49\u65B9\u5F0F\u8BF7\u6C42\u3002\u6BD4\u5982\u94F6\u884C\u7CFB\u7EDF\u4E2D\u8F6C\u8D26\u7684\u8BF7\u6C42\u4F1A\u76F4\u63A5\u6539\u53D8\u8D26\u6237\u7684\u91D1\u989D\uFF0C\u4F1A\u906D\u5230 CSRF \u653B\u51FB\uFF0C\u9700\u8981\u4FDD\u62A4\u3002\u800C\u67E5\u8BE2\u4F59\u989D\u662F\u5BF9\u91D1\u989D\u7684\u8BFB\u53D6\u64CD\u4F5C\uFF0C\u4E0D\u4F1A\u6539\u53D8\u6570\u636E\uFF0CCSRF \u653B\u51FB\u65E0\u6CD5\u89E3\u6790\u670D\u52A1\u5668\u8FD4\u56DE\u7684\u7ED3\u679C\uFF0C\u65E0\u9700\u4FDD\u62A4\u3002</p><h3 id="_3-3-\u4E3A\u4EC0\u4E48\u5BF9\u8BF7\u6C42\u505A\u4E86csrf\u62E6\u622A-\u4F46\u8FD8\u662F\u4F1A\u62A5crsf\u6F0F\u6D1E" tabindex="-1"><a class="header-anchor" href="#_3-3-\u4E3A\u4EC0\u4E48\u5BF9\u8BF7\u6C42\u505A\u4E86csrf\u62E6\u622A-\u4F46\u8FD8\u662F\u4F1A\u62A5crsf\u6F0F\u6D1E" aria-hidden="true">#</a> 3.3 \u4E3A\u4EC0\u4E48\u5BF9\u8BF7\u6C42\u505A\u4E86CSRF\u62E6\u622A\uFF0C\u4F46\u8FD8\u662F\u4F1A\u62A5CRSF\u6F0F\u6D1E?</h3><blockquote><p>\u4E3A\u4EC0\u4E48\u6211\u5728\u524D\u7AEF\u5DF2\u7ECF\u91C7\u7528POST+CSRF Token\u8BF7\u6C42\uFF0C\u540E\u7AEF\u4E5F\u5BF9POST\u8BF7\u6C42\u505A\u4E86CSRF Filter\uFF0C\u4F46\u662F\u6E17\u900F\u6D4B\u8BD5\u4E2D\u8FD8\u6709CSRF\u6F0F\u6D1E?</p></blockquote><p>\u76F4\u63A5\u770B\u4E0B\u9762\u4EE3\u7801\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// \u8FD9\u91CC\u6CA1\u6709\u9650\u5236POST Method\uFF0C\u5BFC\u81F4\u7528\u6237\u53EF\u4EE5\u4E0D\u901A\u8FC7POST\u8BF7\u6C42\u63D0\u4EA4\u6570\u636E\u3002</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/url&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ReponseData</span> <span class="token function">saveSomething</span><span class="token punctuation">(</span><span class="token class-name">XXParam</span> param<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// \u6570\u636E\u4FDD\u5B58\u64CD\u4F5C...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>PS\uFF1A\u8FD9\u4E00\u70B9\u662F\u5F88\u5BB9\u6613\u88AB\u5FFD\u89C6\u7684\uFF0C\u5728\u7B14\u8005\u7ECF\u5386\u8FC7\u7684\u51E0\u4E2A\u9879\u76EE\u7684\u6E17\u900F\u6D4B\u8BD5\u4E2D\uFF0C\u591A\u6B21\u51FA\u73B0</p></blockquote><h2 id="_4-csrf-\u9632\u5FA1\u5E38\u89C4\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_4-csrf-\u9632\u5FA1\u5E38\u89C4\u601D\u8DEF" aria-hidden="true">#</a> 4. CSRF \u9632\u5FA1\u5E38\u89C4\u601D\u8DEF</h2>`,14),q={href:"https://www.ibm.com/developerworks/cn/web/1102_niugang_csrf/index.html",target:"_blank",rel:"noopener noreferrer"},w=n("h3",{id:"_4-1-\u9A8C\u8BC1-http-referer-\u5B57\u6BB5",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4-1-\u9A8C\u8BC1-http-referer-\u5B57\u6BB5","aria-hidden":"true"},"#"),s(" 4.1 \u9A8C\u8BC1 HTTP Referer \u5B57\u6BB5")],-1),S={href:"http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory%EF%BC%8C%E7%94%A8%E6%88%B7%E5%BF%85%E9%A1%BB%E5%85%88%E7%99%BB%E9%99%86",target:"_blank",rel:"noopener noreferrer"},R=n("h3",{id:"_4-2-\u5728\u8BF7\u6C42\u5730\u5740\u4E2D\u6DFB\u52A0-token-\u5E76\u9A8C\u8BC1",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4-2-\u5728\u8BF7\u6C42\u5730\u5740\u4E2D\u6DFB\u52A0-token-\u5E76\u9A8C\u8BC1","aria-hidden":"true"},"#"),s(" 4.2 \u5728\u8BF7\u6C42\u5730\u5740\u4E2D\u6DFB\u52A0 token \u5E76\u9A8C\u8BC1")],-1),C=n("p",null,"CSRF \u653B\u51FB\u4E4B\u6240\u4EE5\u80FD\u591F\u6210\u529F\uFF0C\u662F\u56E0\u4E3A\u9ED1\u5BA2\u53EF\u4EE5\u5B8C\u5168\u4F2A\u9020\u7528\u6237\u7684\u8BF7\u6C42\uFF0C\u8BE5\u8BF7\u6C42\u4E2D\u6240\u6709\u7684\u7528\u6237\u9A8C\u8BC1\u4FE1\u606F\u90FD\u662F\u5B58\u5728\u4E8E cookie \u4E2D\uFF0C\u56E0\u6B64\u9ED1\u5BA2\u53EF\u4EE5\u5728\u4E0D\u77E5\u9053\u8FD9\u4E9B\u9A8C\u8BC1\u4FE1\u606F\u7684\u60C5\u51B5\u4E0B\u76F4\u63A5\u5229\u7528\u7528\u6237\u81EA\u5DF1\u7684 cookie \u6765\u901A\u8FC7\u5B89\u5168\u9A8C\u8BC1\u3002\u8981\u62B5\u5FA1 CSRF\uFF0C\u5173\u952E\u5728\u4E8E\u5728\u8BF7\u6C42\u4E2D\u653E\u5165\u9ED1\u5BA2\u6240\u4E0D\u80FD\u4F2A\u9020\u7684\u4FE1\u606F\uFF0C\u5E76\u4E14\u8BE5\u4FE1\u606F\u4E0D\u5B58\u5728\u4E8E cookie \u4E4B\u4E2D\u3002\u53EF\u4EE5\u5728 HTTP \u8BF7\u6C42\u4E2D\u4EE5\u53C2\u6570\u7684\u5F62\u5F0F\u52A0\u5165\u4E00\u4E2A\u968F\u673A\u4EA7\u751F\u7684 token\uFF0C\u5E76\u5728\u670D\u52A1\u5668\u7AEF\u5EFA\u7ACB\u4E00\u4E2A\u62E6\u622A\u5668\u6765\u9A8C\u8BC1\u8FD9\u4E2A token\uFF0C\u5982\u679C\u8BF7\u6C42\u4E2D\u6CA1\u6709 token \u6216\u8005 token \u5185\u5BB9\u4E0D\u6B63\u786E\uFF0C\u5219\u8BA4\u4E3A\u53EF\u80FD\u662F CSRF \u653B\u51FB\u800C\u62D2\u7EDD\u8BE5\u8BF7\u6C42\u3002",-1),T={href:"http://url?csrftoken=tokenvalue%E3%80%82",target:"_blank",rel:"noopener noreferrer"},_=n("code",null,"<input type=\u201Dhidden\u201D name=\u201Dcsrftoken\u201D value=\u201Dtokenvalue\u201D/>",-1),x=e(`<p>\u8BE5\u65B9\u6CD5\u8FD8\u6709\u4E00\u4E2A\u7F3A\u70B9\u662F\u96BE\u4EE5\u4FDD\u8BC1 token \u672C\u8EAB\u7684\u5B89\u5168\u3002\u7279\u522B\u662F\u5728\u4E00\u4E9B\u8BBA\u575B\u4E4B\u7C7B\u652F\u6301\u7528\u6237\u81EA\u5DF1\u53D1\u8868\u5185\u5BB9\u7684\u7F51\u7AD9\uFF0C\u9ED1\u5BA2\u53EF\u4EE5\u5728\u4E0A\u9762\u53D1\u5E03\u81EA\u5DF1\u4E2A\u4EBA\u7F51\u7AD9\u7684\u5730\u5740\u3002\u7531\u4E8E\u7CFB\u7EDF\u4E5F\u4F1A\u5728\u8FD9\u4E2A\u5730\u5740\u540E\u9762\u52A0\u4E0A token\uFF0C\u9ED1\u5BA2\u53EF\u4EE5\u5728\u81EA\u5DF1\u7684\u7F51\u7AD9\u4E0A\u5F97\u5230\u8FD9\u4E2A token\uFF0C\u5E76\u9A6C\u4E0A\u5C31\u53EF\u4EE5\u53D1\u52A8 CSRF \u653B\u51FB\u3002\u4E3A\u4E86\u907F\u514D\u8FD9\u4E00\u70B9\uFF0C\u7CFB\u7EDF\u53EF\u4EE5\u5728\u6DFB\u52A0 token \u7684\u65F6\u5019\u589E\u52A0\u4E00\u4E2A\u5224\u65AD\uFF0C\u5982\u679C\u8FD9\u4E2A\u94FE\u63A5\u662F\u94FE\u5230\u81EA\u5DF1\u672C\u7AD9\u7684\uFF0C\u5C31\u5728\u540E\u9762\u6DFB\u52A0 token\uFF0C\u5982\u679C\u662F\u901A\u5411\u5916\u7F51\u5219\u4E0D\u52A0\u3002\u4E0D\u8FC7\uFF0C\u5373\u4F7F\u8FD9\u4E2A csrftoken \u4E0D\u4EE5\u53C2\u6570\u7684\u5F62\u5F0F\u9644\u52A0\u5728\u8BF7\u6C42\u4E4B\u4E2D\uFF0C\u9ED1\u5BA2\u7684\u7F51\u7AD9\u4E5F\u540C\u6837\u53EF\u4EE5\u901A\u8FC7 Referer \u6765\u5F97\u5230\u8FD9\u4E2A token \u503C\u4EE5\u53D1\u52A8 CSRF \u653B\u51FB\u3002\u8FD9\u4E5F\u662F\u4E00\u4E9B\u7528\u6237\u559C\u6B22\u624B\u52A8\u5173\u95ED\u6D4F\u89C8\u5668 Referer \u529F\u80FD\u7684\u539F\u56E0\u3002</p><h3 id="_4-3-\u5728-http-\u5934\u4E2D\u81EA\u5B9A\u4E49\u5C5E\u6027\u5E76\u9A8C\u8BC1" tabindex="-1"><a class="header-anchor" href="#_4-3-\u5728-http-\u5934\u4E2D\u81EA\u5B9A\u4E49\u5C5E\u6027\u5E76\u9A8C\u8BC1" aria-hidden="true">#</a> 4.3 \u5728 HTTP \u5934\u4E2D\u81EA\u5B9A\u4E49\u5C5E\u6027\u5E76\u9A8C\u8BC1</h3><p>\u8FD9\u79CD\u65B9\u6CD5\u4E5F\u662F\u4F7F\u7528 token \u5E76\u8FDB\u884C\u9A8C\u8BC1\uFF0C\u548C\u4E0A\u4E00\u79CD\u65B9\u6CD5\u4E0D\u540C\u7684\u662F\uFF0C\u8FD9\u91CC\u5E76\u4E0D\u662F\u628A token \u4EE5\u53C2\u6570\u7684\u5F62\u5F0F\u7F6E\u4E8E HTTP \u8BF7\u6C42\u4E4B\u4E2D\uFF0C\u800C\u662F\u628A\u5B83\u653E\u5230 HTTP \u5934\u4E2D\u81EA\u5B9A\u4E49\u7684\u5C5E\u6027\u91CC\u3002\u901A\u8FC7 XMLHttpRequest \u8FD9\u4E2A\u7C7B\uFF0C\u53EF\u4EE5<strong>\u4E00\u6B21\u6027\u7ED9\u6240\u6709\u8BE5\u7C7B\u8BF7\u6C42\u52A0\u4E0A csrftoken \u8FD9\u4E2A HTTP \u5934\u5C5E\u6027\uFF0C\u5E76\u628A token \u503C\u653E\u5165\u5176\u4E2D\u3002\u8FD9\u6837\u89E3\u51B3\u4E86\u4E0A\u79CD\u65B9\u6CD5\u5728\u8BF7\u6C42\u4E2D\u52A0\u5165 token \u7684\u4E0D\u4FBF\uFF0C\u540C\u65F6\uFF0C\u901A\u8FC7 XMLHttpRequest \u8BF7\u6C42\u7684\u5730\u5740\u4E0D\u4F1A\u88AB\u8BB0\u5F55\u5230\u6D4F\u89C8\u5668\u7684\u5730\u5740\u680F\uFF0C\u4E5F\u4E0D\u7528\u62C5\u5FC3 token \u4F1A\u900F\u8FC7 Referer \u6CC4\u9732\u5230\u5176\u4ED6\u7F51\u7AD9\u4E2D\u53BB\u3002</strong></p><p>\u7136\u800C\u8FD9\u79CD\u65B9\u6CD5\u7684\u5C40\u9650\u6027\u975E\u5E38\u5927\u3002XMLHttpRequest \u8BF7\u6C42\u901A\u5E38\u7528\u4E8E Ajax \u65B9\u6CD5\u4E2D\u5BF9\u4E8E\u9875\u9762\u5C40\u90E8\u7684\u5F02\u6B65\u5237\u65B0\uFF0C\u5E76\u975E\u6240\u6709\u7684\u8BF7\u6C42\u90FD\u9002\u5408\u7528\u8FD9\u4E2A\u7C7B\u6765\u53D1\u8D77\uFF0C\u800C\u4E14\u901A\u8FC7\u8BE5\u7C7B\u8BF7\u6C42\u5F97\u5230\u7684\u9875\u9762\u4E0D\u80FD\u88AB\u6D4F\u89C8\u5668\u6240\u8BB0\u5F55\u4E0B\uFF0C\u4ECE\u800C\u8FDB\u884C\u524D\u8FDB\uFF0C\u540E\u9000\uFF0C\u5237\u65B0\uFF0C\u6536\u85CF\u7B49\u64CD\u4F5C\uFF0C\u7ED9\u7528\u6237\u5E26\u6765\u4E0D\u4FBF\u3002\u53E6\u5916\uFF0C\u5BF9\u4E8E\u6CA1\u6709\u8FDB\u884C CSRF \u9632\u62A4\u7684\u9057\u7559\u7CFB\u7EDF\u6765\u8BF4\uFF0C\u8981\u91C7\u7528\u8FD9\u79CD\u65B9\u6CD5\u6765\u8FDB\u884C\u9632\u62A4\uFF0C\u8981\u628A\u6240\u6709\u8BF7\u6C42\u90FD\u6539\u4E3A XMLHttpRequest \u8BF7\u6C42\uFF0C\u8FD9\u6837\u51E0\u4E4E\u662F\u8981\u91CD\u5199\u6574\u4E2A\u7F51\u7AD9\uFF0C\u8FD9\u4EE3\u4EF7\u65E0\u7591\u662F\u4E0D\u80FD\u63A5\u53D7\u7684\u3002</p><h2 id="_5-csrf-\u9632\u5FA1\u5B9E\u6218" tabindex="-1"><a class="header-anchor" href="#_5-csrf-\u9632\u5FA1\u5B9E\u6218" aria-hidden="true">#</a> 5. CSRF \u9632\u5FA1\u5B9E\u6218</h2><blockquote><p>\u4E3B\u6D41\u7684\u6846\u67B6\u4E00\u822C\u90FD\u5305\u542B\u4E86CSRF\u7684\u62E6\u622A\u3002</p></blockquote><h3 id="_5-1-\u975E\u6846\u67B6\u578B-\u81EA\u5B9A\u4E49xxxcsrffilter" tabindex="-1"><a class="header-anchor" href="#_5-1-\u975E\u6846\u67B6\u578B-\u81EA\u5B9A\u4E49xxxcsrffilter" aria-hidden="true">#</a> 5.1 \u975E\u6846\u67B6\u578B - \u81EA\u5B9A\u4E49XXXCsrfFilter</h3><p>\u53EF\u4EE5\u901A\u8FC7\u81EA\u5B9A\u4E49xxxCsrfFilter\u53BB\u62E6\u622A\u5B9E\u73B0\uFF0C \u8FD9\u91CC\u5EFA\u8BAE\u4F60\u53C2\u8003 Spring Security - org.springframework.security.web.csrf.CsrfFilter.java\u3002</p><h3 id="_5-2-spring-security-\u4EC0\u4E48\u65F6\u5019\u7981\u7528csrf" tabindex="-1"><a class="header-anchor" href="#_5-2-spring-security-\u4EC0\u4E48\u65F6\u5019\u7981\u7528csrf" aria-hidden="true">#</a> 5.2 Spring Security - \u4EC0\u4E48\u65F6\u5019\u7981\u7528CSRF</h3><blockquote><p>\u4F60\u5F00\u53D1\u7684\u5E94\u7528\u5728\u4F55\u65F6\uFF0C\u4F1A\u8003\u8651\u7981\u7528CSRF\u5462? \u8FD9\u65F6\u5019\u9700\u8981\u8003\u8651CSRF\u672C\u8D28\u662F\u76D7\u7528cookie, \u65E0cookie\u65B9\u6848\u5C31\u53EF\u4EE5\u7981\u7528\u3002</p></blockquote><ul><li>\u5982\u679C\u4F60\u53EA\u662F\u521B\u5EFA\u4E00\u4E2A\u975E\u6D4F\u89C8\u5668\u5BA2\u6237\u7AEF\u4F7F\u7528\u7684\u670D\u52A1,\u4F60\u53EF\u80FD\u4F1A\u60F3\u8981\u7981\u7528CSRF\u4FDD\u62A4</li></ul><p><strong>Spring Security\u4E2D\u7981\u7528CSRF</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// \u9ED8\u8BA4\u662F\u542F\u7528\u7684\uFF0C\u9700\u8981\u7981\u7528CSRF\u4FDD\u62A4</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-spring-security-cookiecsrftokenrepository-withhttponlyfalse" tabindex="-1"><a class="header-anchor" href="#_5-3-spring-security-cookiecsrftokenrepository-withhttponlyfalse" aria-hidden="true">#</a> 5.3 Spring Security - CookieCsrfTokenRepository.withHttpOnlyFalse()</h3><blockquote><p>\u5B58Cookie\uFF0C\u6BD4\u5982\u524D\u540E\u7AEF\u5206\u79BB\u65B9\u6848\uFF1ASpring Security CookieCsrfTokenRepository + \u524D\u7AEF\u8DEF\u7531\u7EDF\u4E00\u8BBE\u7F6E</p></blockquote><p><strong>Spring Security\u4F9D\u8D56\u5305</strong></p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Spring Security - CookieCsrfTokenRepository.withHttpOnlyFalse()</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u672C\u4F8B\u5B50\u7ED9\u4E2A\u8303\u4F8B\u800C\u5DF2\uFF0C\u5BF9\u4E8Exxx\u7684\u90E8\u5206\uFF0C\u81EA\u5DF1\u6839\u636E\u4E1A\u52A1\u5B9A\u4E49</span>
    http
        <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">/* allow */</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/plugins/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/api-docs/**&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment">/* auth control */</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/xxx/user/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority(&#39;xxx:user&#39;)&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/xxx/role/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority(&#39;xxx:role&#39;)&quot;</span><span class="token punctuation">)</span>

            <span class="token comment">/* others */</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           
        <span class="token comment">/* other Filters */</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token function">xxxFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        
        <span class="token comment">/* iframe */</span>
        <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sameOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment">/* form login &amp; logout */</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/admin/&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">&quot;remember&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">rememberMeCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;remember&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">&quot;JSESSIONID&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">invalidateHttpSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XXXLogoutSuccessHandler</span><span class="token punctuation">(</span><span class="token function">localeResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logoutRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment">/* csrf */</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">csrfTokenRepository</span><span class="token punctuation">(</span><span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">.</span><span class="token function">withHttpOnlyFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		.and().cors()</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u540E\u7AEFthymeleaf\u767B\u5F55\u9875\u9762&quot;/login&quot;</strong>\uFF1A</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>\u767B\u5F55\u9875\u9762<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>\u7528\u6237\u540D\uFF1A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>\u5BC6\u7801\uFF1A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--csrf\u9A8C\u8BC1\u9700\u8981--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${_csrf.parameterName}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${_csrf.token}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u767B\u5F55<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u524D\u7AEF\u8C03\u7528\u540E\u7AEFAPI: \u65B9\u5F0F\u4E00 \uFF08\u524D\u540E\u7AEF\u5206\u79BB\u7684\uFF09</strong>\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//  \u5C06Cookie\u8F6C\u6362\u4E3AJS Object</span>
<span class="token keyword">function</span> <span class="token function">initCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cookie <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie<span class="token punctuation">,</span>
        items <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> kv <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;=&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keys<span class="token punctuation">[</span>$<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>kv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>kv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> keys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//  \u63D0\u4EA4\u6570\u636E</span>
$<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userId</span> <span class="token operator">:</span> code<span class="token punctuation">,</span>
    <span class="token literal-property property">_csrf</span> <span class="token operator">:</span> <span class="token function">initCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&#39;X-XSRF-TOKEN&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">datas</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  TODO something</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u524D\u7AEF\u8C03\u7528\u540E\u7AEFAPI: \u65B9\u5F0F\u4E8C \uFF08\u540E\u7AEF\u5199\u524D\u7AEF\uFF0C\u7528\u7684\u540E\u7AEF\u6A21\u677F\uFF09</strong>\uFF1A</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${_csrf.token}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf_header<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${_csrf.headerName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
 
    <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;meta[name=&#39;_csrf&#39;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> header <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;meta[name=&#39;_csrf_header&#39;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">ajaxSetup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">beforeSend</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">xhr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header <span class="token operator">&amp;&amp;</span> token <span class="token punctuation">)</span><span class="token punctuation">{</span>
                xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-spring-security-new-cookiecsrftokenrepository" tabindex="-1"><a class="header-anchor" href="#_5-4-spring-security-new-cookiecsrftokenrepository" aria-hidden="true">#</a> 5.4 Spring Security - new CookieCsrfTokenRepository()</h3><p>\u53EF\u4EE5\u901A\u8FC7<code>new CookieCsrfTokenRepository()</code>\u81EA\u5B9A\u4E49\u62E6\u622A\u7684\u903B\u8F91\uFF0C\u5927\u6982\u610F\u601D\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrfTokenRepository</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">requireCsrfProtectionMatcher</span><span class="token punctuation">(</span>
                        <span class="token doc-comment comment">/**
                         * \u62E6\u622A\u201C/login\u201D\u5F00\u5934\u7684\u8BBF\u95EE\u8DEF\u5F84\uFF0C\u4E0D\u8BA9\u8BBF\u95EE
                         * \u62E6\u622A\u6240\u6709\u201CPOST\u201D\u8BF7\u6C42\uFF0C\u4E0D\u8BA9\u8BBF\u95EE
                         */</span>
<span class="token comment">//                        httpServletRequest -&gt; httpServletRequest.getRequestURI().startsWith(&quot;/login&quot;)</span>
<span class="token comment">//                                &amp;&amp; httpServletRequest.getMethod().equals(&quot;POST&quot;)</span>
                        httpServletRequest <span class="token operator">-&gt;</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53\u7136\u4E5F\u53EF\u4EE5\u8FD9\u4E48\u5199\uFF0C\u53EF\u4EE5\u770B\u540E\u7EED\u5BF9\u9ED8\u8BA4\u7684<code>DefaultRequiresCsrfMatcher</code>\u7684\u6E90\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CsrfSecurityRequestMatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestMatcher</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Pattern</span> allowedMethods <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;^(GET|HEAD|TRACE|OPTIONS)$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RegexRequestMatcher</span> unprotectedMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegexRequestMatcher</span><span class="token punctuation">(</span><span class="token string">&quot;^/rest/.*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>allowedMethods<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">return</span> <span class="token operator">!</span>unprotectedMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-spring-security-cookiecsrftokenrepository\u5982\u4F55\u5DE5\u4F5C\u7684\u5462" tabindex="-1"><a class="header-anchor" href="#_5-5-spring-security-cookiecsrftokenrepository\u5982\u4F55\u5DE5\u4F5C\u7684\u5462" aria-hidden="true">#</a> 5.5 Spring Security - CookieCsrfTokenRepository\u5982\u4F55\u5DE5\u4F5C\u7684\u5462?</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">.</span><span class="token function">withHttpOnlyFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\` \u672C\u8D28\u5C31\u662F\`<span class="token keyword">new</span> <span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CookieCsrfTokenRepository</span> <span class="token function">withHttpOnlyFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CookieCsrfTokenRepository</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">setCookieHttpOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4E3A\u4F55\u9ED8\u8BA4\u7684\u5B58\u653ECSRFToken\u7684cookie\u662FhttpOnly\u5462\uFF1F</strong></p><p>\u5982\u679Ccookie\u4E2D\u8BBE\u7F6E\u4E86HttpOnly\u5C5E\u6027\uFF0C\u90A3\u4E48\u901A\u8FC7js\u811A\u672C\u5C06\u65E0\u6CD5\u8BFB\u53D6\u5230cookie\u4FE1\u606F\uFF0C\u8FD9\u6837\u80FD\u6709\u6548\u7684\u9632\u6B62XSS\u653B\u51FB\uFF0C\u7A83\u53D6cookie\u5185\u5BB9\uFF0C\u8FD9\u6837\u5C31\u589E\u52A0\u4E86cookie\u7684\u5B89\u5168\u6027\uFF0C\u5373\u4FBF\u662F\u8FD9\u6837\uFF0C\u4E5F\u4E0D\u8981\u5C06\u91CD\u8981\u4FE1\u606F\u5B58\u5165cookie\u3002XSS\u5168\u79F0Cross SiteScript\uFF0C\u8DE8\u7AD9\u811A\u672C\u653B\u51FB\uFF0C\u662FWeb\u7A0B\u5E8F\u4E2D\u5E38\u89C1\u7684\u6F0F\u6D1E\uFF0CXSS\u5C5E\u4E8E\u88AB\u52A8\u5F0F\u4E14\u7528\u4E8E\u5BA2\u6237\u7AEF\u7684\u653B\u51FB\u65B9\u5F0F\uFF0C\u6240\u4EE5\u5BB9\u6613\u88AB\u5FFD\u7565\u5176\u5371\u5BB3\u6027\u3002\u5176\u539F\u7406\u662F\u653B\u51FB\u8005\u5411\u6709XSS\u6F0F\u6D1E\u7684\u7F51\u7AD9\u4E2D\u8F93\u5165(\u4F20\u5165)\u6076\u610F\u7684HTML\u4EE3\u7801\uFF0C\u5F53\u5176\u5B83\u7528\u6237\u6D4F\u89C8\u8BE5\u7F51\u7AD9\u65F6\uFF0C\u8FD9\u6BB5HTML\u4EE3\u7801\u4F1A\u81EA\u52A8\u6267\u884C\uFF0C\u4ECE\u800C\u8FBE\u5230\u653B\u51FB\u7684\u76EE\u7684\u3002\u5982\uFF0C\u76D7\u53D6\u7528\u6237Cookie\u3001\u7834\u574F\u9875\u9762\u7ED3\u6784\u3001\u91CD\u5B9A\u5411\u5230\u5176\u5B83\u7F51\u7AD9\u7B49\u3002\u8FD9\u91CC\u8BF7\u770B<a href="">\u5F00\u53D1\u5B89\u5168 - XSS \u8BE6\u89E3</a></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// \u6BD4\u5982\uFF0C\u8BBE\u7F6Ehttps\u7684cookie</span>
response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Set-Cookie&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uid=112; Path=/; Secure; HttpOnly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Cookie CsrfToken \u9ED8\u8BA4\u7684\u5C01\u88C5</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CSRF_COOKIE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;XSRF-TOKEN&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CSRF_PARAMETER_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;_csrf&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CSRF_HEADER_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;X-XSRF-TOKEN&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> parameterName <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_PARAMETER_NAME</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> headerName <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_HEADER_NAME</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> cookieName <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_COOKIE_NAME</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CsrfToken</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCsrfToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterName<span class="token punctuation">,</span>
            <span class="token function">createNewToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CsrfToken\u7684\u4FDD\u5B58</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveToken</span><span class="token punctuation">(</span><span class="token class-name">CsrfToken</span> token<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
        <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> tokenValue <span class="token operator">=</span> token <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> token<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieName<span class="token punctuation">,</span> tokenValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setSecure</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookiePath <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookiePath<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookiePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRequestContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cookieHttpOnly <span class="token operator">&amp;&amp;</span> setHttpOnlyMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>setHttpOnlyMethod<span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CsrfToken\u7684\u52A0\u8F7D</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CsrfToken</span> <span class="token function">loadToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cookieName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCsrfToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterName<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-6-spring-security-csrffilter\u662F\u5982\u4F55\u5B8C\u6210\u62E6\u622A\u548C\u6821\u9A8C\u7684\u5462" tabindex="-1"><a class="header-anchor" href="#_5-6-spring-security-csrffilter\u662F\u5982\u4F55\u5B8C\u6210\u62E6\u622A\u548C\u6821\u9A8C\u7684\u5462" aria-hidden="true">#</a> 5.6 Spring Security - CsrfFilter\u662F\u5982\u4F55\u5B8C\u6210\u62E6\u622A\u548C\u6821\u9A8C\u7684\u5462?</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CsrfFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8D1F\u8D23CsrfToken\u751F\u6210\uFF0C\u52A0\u8F7D\u7B49</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CsrfTokenRepository</span> tokenRepository<span class="token punctuation">;</span>
    
    <span class="token comment">// \u8D1F\u8D23\u62E6\u622ACsrf\u7684\u5339\u914D</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> requireCsrfProtectionMatcher <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_MATCHER</span><span class="token punctuation">;</span>
    
    <span class="token comment">// \u88AB\u62E6\u622A\u540E\u7684\u62D2\u7EDD\u7B56\u7565</span>
	<span class="token keyword">private</span> <span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedHandlerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// CsrfFilter\u7684\u8FC7\u6EE4\u903B\u8F91</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
			<span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
					<span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u52A0\u8F7Dtoken,\u6CA1\u6709\u7684\u81EA\u52A8\u751F\u6210\u4E00\u4E2A</span>
		<span class="token class-name">CsrfToken</span> csrfToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">loadToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">boolean</span> missingToken <span class="token operator">=</span> csrfToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>missingToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			csrfToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">saveToken</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">CsrfToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getParameterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u62E6\u622A\u8BF7\u6C42</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requireCsrfProtectionMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

        <span class="token comment">// \u6821\u9A8Ctoken</span>
		<span class="token class-name">String</span> actualToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getHeaderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>actualToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			actualToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getParameterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>csrfToken<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid CSRF token found for &quot;</span>
						<span class="token operator">+</span> <span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">buildFullRequestUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>missingToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
						<span class="token keyword">new</span> <span class="token class-name">MissingCsrfTokenException</span><span class="token punctuation">(</span>actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
						<span class="token keyword">new</span> <span class="token class-name">InvalidCsrfTokenException</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">,</span> actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-7-spring-security-\u9ED8\u8BA4\u5BF9\u54EA\u4E9Bmethod\u62E6\u622A\u5462" tabindex="-1"><a class="header-anchor" href="#_5-7-spring-security-\u9ED8\u8BA4\u5BF9\u54EA\u4E9Bmethod\u62E6\u622A\u5462" aria-hidden="true">#</a> 5.7 Spring Security - \u9ED8\u8BA4\u5BF9\u54EA\u4E9BMethod\u62E6\u622A\u5462?</h3><p>&quot;GET&quot;, &quot;HEAD&quot;, &quot;TRACE&quot;, &quot;OPTIONS&quot; \u4E0D\u4F1A\u62E6\u622A\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultRequiresCsrfMatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestMatcher</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allowedMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HEAD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TRACE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
        * (non-Javadoc)
        *
        * @see
        * org.springframework.security.web.util.matcher.RequestMatcher#matches(javax.
        * servlet.http.HttpServletRequest)
        */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowedMethods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-8-spring-security-httpsessioncsrftokenrepository" tabindex="-1"><a class="header-anchor" href="#_5-8-spring-security-httpsessioncsrftokenrepository" aria-hidden="true">#</a> 5.8 Spring Security - HttpSessionCsrfTokenRepository</h3><blockquote><p>\u7ECF\u8FC7\u4E0A\u9762\u7684\u5206\u6790\uFF0C\u4F60\u518D\u770BSession\u7684\uFF0C\u662F\u4E0D\u662F\u5F88\u7B80\u5355? \u6211\u8FD9\u8FB9\u8D34\u4E2A\u4EE3\u7801\uFF0C\u4F60\u773C\u775B\u626B\u4E00\u4E0B\u5373\u53EF\u3002</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HttpSessionCsrfTokenRepository</span> <span class="token keyword">implements</span> <span class="token class-name">CsrfTokenRepository</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CSRF_PARAMETER_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;_csrf&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CSRF_HEADER_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;X-CSRF-TOKEN&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CSRF_TOKEN_ATTR_NAME</span> <span class="token operator">=</span> <span class="token class-name">HttpSessionCsrfTokenRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span>
			<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;.CSRF_TOKEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> parameterName <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_PARAMETER_NAME</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> headerName <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_HEADER_NAME</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> sessionAttributeName <span class="token operator">=</span> <span class="token constant">DEFAULT_CSRF_TOKEN_ATTR_NAME</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * (non-Javadoc)
	 *
	 * @see org.springframework.security.web.csrf.CsrfTokenRepository#saveToken(org.
	 * springframework .security.web.csrf.CsrfToken,
	 * javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse)
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveToken</span><span class="token punctuation">(</span><span class="token class-name">CsrfToken</span> token<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
			<span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				session<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionAttributeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionAttributeName<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * (non-Javadoc)
	 *
	 * @see
	 * org.springframework.security.web.csrf.CsrfTokenRepository#loadToken(javax.servlet
	 * .http.HttpServletRequest)
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">CsrfToken</span> <span class="token function">loadToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">CsrfToken</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionAttributeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * (non-Javadoc)
	 *
	 * @see org.springframework.security.web.csrf.CsrfTokenRepository#generateToken(javax.
	 * servlet .http.HttpServletRequest)
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">CsrfToken</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCsrfToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterName<span class="token punctuation">,</span>
				<span class="token function">createNewToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-9-spring-security-\u8BBE\u7F6Ecsrf\u4E0D\u5BF9\u4F1A\u9020\u6210\u54EA\u4E9B\u9519\u8BEF\u5462" tabindex="-1"><a class="header-anchor" href="#_5-9-spring-security-\u8BBE\u7F6Ecsrf\u4E0D\u5BF9\u4F1A\u9020\u6210\u54EA\u4E9B\u9519\u8BEF\u5462" aria-hidden="true">#</a> 5.9 Spring Security - \u8BBE\u7F6ECsrf\u4E0D\u5BF9\u4F1A\u9020\u6210\u54EA\u4E9B\u9519\u8BEF\u5462?</h3><ul><li>403 - \u7528CSRF\u4F5C\u4E3A\u63A7\u5236\u6743\u9650\uFF0C\u5F15\u53D1\u6743\u9650\u95EE\u9898</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">There</span> was an unexpected error <span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token class-name">Forbidden</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token class-name">Invalid</span> <span class="token constant">CSRF</span> <span class="token class-name">Token</span> <span class="token char">&#39;null&#39;</span> was found on the request parameter <span class="token char">&#39;_csrf&#39;</span> or header &#39;<span class="token class-name">X</span><span class="token operator">-</span><span class="token constant">XSRF</span><span class="token operator">-</span><span class="token constant">TOKEN</span>&#39;<span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>405 - \u524D\u7F6E\u7684\u53C2\u6570\u7ED1\u5B9A\u95EE\u9898</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">POST</span> method not supported\u3002<span class="token comment">// \u672C\u8D28\u4E0A\u8FD8\u662F\u53C2\u6570\u7ED1\u5B9A\u65F6\uFF0CCsrf\u6CA1\u6709\u8BBE\u7F6E\u6216\u8005\u4E0D\u6B63\u786E\u3002</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-\u603B\u7ED3\u4E0E\u5C55\u671B" tabindex="-1"><a class="header-anchor" href="#_6-\u603B\u7ED3\u4E0E\u5C55\u671B" aria-hidden="true">#</a> 6. \u603B\u7ED3\u4E0E\u5C55\u671B</h2><p>\u53EF\u89C1\uFF0CCSRF \u662F\u4E00\u79CD\u5371\u5BB3\u975E\u5E38\u5927\u7684\u653B\u51FB\uFF0C\u53C8\u5F88\u96BE\u4EE5\u9632\u8303\u3002\u76EE\u524D\u51E0\u79CD\u9632\u5FA1\u7B56\u7565\u867D\u7136\u53EF\u4EE5\u5F88\u5927\u7A0B\u5EA6\u4E0A\u62B5\u5FA1 CSRF \u7684\u653B\u51FB\uFF0C\u4F46\u5E76\u6CA1\u6709\u4E00\u79CD\u5B8C\u7F8E\u7684\u89E3\u51B3\u65B9\u6848\u3002\u4E00\u4E9B\u65B0\u7684\u65B9\u6848\u6B63\u5728\u7814\u7A76\u4E4B\u4E2D\uFF0C\u6BD4\u5982\u5BF9\u4E8E\u6BCF\u6B21\u8BF7\u6C42\u90FD\u4F7F\u7528\u4E0D\u540C\u7684\u52A8\u6001\u53E3\u4EE4\uFF0C\u628A Referer \u548C token \u65B9\u6848\u7ED3\u5408\u8D77\u6765\uFF0C\u751A\u81F3\u5C1D\u8BD5\u4FEE\u6539 HTTP \u89C4\u8303\uFF0C\u4F46\u662F\u8FD9\u4E9B\u65B0\u7684\u65B9\u6848\u5C1A\u4E0D\u6210\u719F\uFF0C\u8981\u6B63\u5F0F\u6295\u5165\u4F7F\u7528\u5E76\u88AB\u4E1A\u754C\u5E7F\u4E3A\u63A5\u53D7\u8FD8\u9700\u65F6\u65E5\u3002\u5728\u8FD9\u4E4B\u524D\uFF0C\u6211\u4EEC\u53EA\u6709\u5145\u5206\u91CD\u89C6 CSRF\uFF0C\u6839\u636E\u7CFB\u7EDF\u7684\u5B9E\u9645\u60C5\u51B5\u9009\u62E9\u6700\u5408\u9002\u7684\u7B56\u7565\uFF0C\u8FD9\u6837\u624D\u80FD\u628A CSRF \u7684\u5371\u5BB3\u964D\u5230\u6700\u4F4E\u3002</p><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>`,57),F={href:"https://pdai.tech/md/develop/security/dev-security-x-csrf.html",target:"_blank",rel:"noopener noreferrer"};function E(A,M){const a=l("ExternalLinkIcon");return o(),c("div",null,[u,n("ul",null,[n("li",null,[n("p",null,[s("\u6BD4\u5982\u8BF4\uFF0C\u53D7\u5BB3\u8005 Bob \u5728\u94F6\u884C\u6709\u4E00\u7B14\u5B58\u6B3E\uFF0C\u901A\u8FC7\u5BF9\u94F6\u884C\u7684\u7F51\u7AD9\u53D1\u9001\u8BF7\u6C42 "),n("a",k,[s("http://bank.example/withdraw?account=bob&amount=1000000&for=bob2"),t(a)]),s(" \u53EF\u4EE5\u4F7F Bob \u628A 1000000 \u7684\u5B58\u6B3E\u8F6C\u5230 bob2 \u7684\u8D26\u53F7\u4E0B\u3002")])]),r,n("li",null,[n("p",null,[s("\u9ED1\u5BA2 Mallory \u81EA\u5DF1\u5728\u8BE5\u94F6\u884C\u4E5F\u6709\u8D26\u6237\uFF0C\u4ED6\u77E5\u9053\u4E0A\u6587\u4E2D\u7684 URL \u53EF\u4EE5\u628A\u94B1\u8FDB\u884C\u8F6C\u5E10\u64CD\u4F5C\u3002Mallory \u53EF\u4EE5\u81EA\u5DF1\u53D1\u9001\u4E00\u4E2A\u8BF7\u6C42\u7ED9\u94F6\u884C\uFF1A"),n("a",d,[s("http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory\u3002"),t(a)])]),v]),n("li",null,[n("p",null,[s("\u4F46\u662F\u8FD9\u4E2A\u8BF7\u6C42\u6765\u81EA Mallory \u800C\u975E Bob\uFF0C\u4ED6\u4E0D\u80FD\u901A\u8FC7\u5B89\u5168\u8BA4\u8BC1\uFF0C\u56E0\u6B64\u8BE5\u8BF7\u6C42\u4E0D\u4F1A\u8D77\u4F5C\u7528\u3002\u8FD9\u65F6\uFF0CMallory \u60F3\u5230\u4F7F\u7528 CSRF \u7684\u653B\u51FB\u65B9\u5F0F\uFF0C\u4ED6\u5148\u81EA\u5DF1\u505A\u4E00\u4E2A\u7F51\u7AD9\uFF0C\u5728\u7F51\u7AD9\u4E2D\u653E\u5165\u5982\u4E0B\u4EE3\u7801\uFF1A src=\u201D"),n("a",m,[s("http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory"),t(a)]),s(" \u201D\uFF0C"),b,s("\u3002")]),f]),g,h]),y,n("blockquote",null,[n("p",null,[s("\u4E00\u5B9A\u8981\u6CE8\u610F\uFF0C\u4E0B\u9762\u53EA\u662F\u7ED9\u4F60\u63D0\u4F9B\u5E38\u89C4\u601D\u8DEF\u800C\u5DF2\uFF08\u4EE5\u4E0B\u6587\u5B57\u6458\u81EA"),n("a",q,[s("CSRF \u653B\u51FB\u7684\u5E94\u5BF9\u4E4B\u9053"),t(a)]),s("\uFF0C\u5177\u4F53\u5B9E\u73B0\u8BF7\u770B\u4E0B\u4E00\u4E2A\u7AE0\u8282\u3002")])]),w,n("p",null,[s("\u6839\u636E HTTP \u534F\u8BAE\uFF0C\u5728 HTTP \u5934\u4E2D\u6709\u4E00\u4E2A\u5B57\u6BB5\u53EB Referer\uFF0C\u5B83\u8BB0\u5F55\u4E86\u8BE5 HTTP \u8BF7\u6C42\u7684\u6765\u6E90\u5730\u5740\u3002\u5728\u901A\u5E38\u60C5\u51B5\u4E0B\uFF0C\u8BBF\u95EE\u4E00\u4E2A\u5B89\u5168\u53D7\u9650\u9875\u9762\u7684\u8BF7\u6C42\u6765\u81EA\u4E8E\u540C\u4E00\u4E2A\u7F51\u7AD9\uFF0C\u6BD4\u5982\u9700\u8981\u8BBF\u95EE "),n("a",S,[s("http://bank.example/withdraw?account=bob&amount=1000000&for=Mallory\uFF0C\u7528\u6237\u5FC5\u987B\u5148\u767B\u9646"),t(a)]),s(" bank.example\uFF0C\u7136\u540E\u901A\u8FC7\u70B9\u51FB\u9875\u9762\u4E0A\u7684\u6309\u94AE\u6765\u89E6\u53D1\u8F6C\u8D26\u4E8B\u4EF6\u3002\u8FD9\u65F6\uFF0C\u8BE5\u8F6C\u5E10\u8BF7\u6C42\u7684 Referer \u503C\u5C31\u4F1A\u662F\u8F6C\u8D26\u6309\u94AE\u6240\u5728\u7684\u9875\u9762\u7684 URL\uFF0C\u901A\u5E38\u662F\u4EE5 bank.example \u57DF\u540D\u5F00\u5934\u7684\u5730\u5740\u3002\u800C\u5982\u679C\u9ED1\u5BA2\u8981\u5BF9\u94F6\u884C\u7F51\u7AD9\u5B9E\u65BD CSRF \u653B\u51FB\uFF0C\u4ED6\u53EA\u80FD\u5728\u4ED6\u81EA\u5DF1\u7684\u7F51\u7AD9\u6784\u9020\u8BF7\u6C42\uFF0C\u5F53\u7528\u6237\u901A\u8FC7\u9ED1\u5BA2\u7684\u7F51\u7AD9\u53D1\u9001\u8BF7\u6C42\u5230\u94F6\u884C\u65F6\uFF0C\u8BE5\u8BF7\u6C42\u7684 Referer \u662F\u6307\u5411\u9ED1\u5BA2\u81EA\u5DF1\u7684\u7F51\u7AD9\u3002\u56E0\u6B64\uFF0C\u8981\u9632\u5FA1 CSRF \u653B\u51FB\uFF0C\u94F6\u884C\u7F51\u7AD9\u53EA\u9700\u8981\u5BF9\u4E8E\u6BCF\u4E00\u4E2A\u8F6C\u8D26\u8BF7\u6C42\u9A8C\u8BC1\u5176 Referer \u503C\uFF0C\u5982\u679C\u662F\u4EE5 bank.example \u5F00\u5934\u7684\u57DF\u540D\uFF0C\u5219\u8BF4\u660E\u8BE5\u8BF7\u6C42\u662F\u6765\u81EA\u94F6\u884C\u7F51\u7AD9\u81EA\u5DF1\u7684\u8BF7\u6C42\uFF0C\u662F\u5408\u6CD5\u7684\u3002\u5982\u679C Referer \u662F\u5176\u4ED6\u7F51\u7AD9\u7684\u8BDD\uFF0C\u5219\u6709\u53EF\u80FD\u662F\u9ED1\u5BA2\u7684 CSRF \u653B\u51FB\uFF0C\u62D2\u7EDD\u8BE5\u8BF7\u6C42\u3002")]),R,C,n("p",null,[s("\u8FD9\u79CD\u65B9\u6CD5\u8981\u6BD4\u68C0\u67E5 Referer \u8981\u5B89\u5168\u4E00\u4E9B\uFF0Ctoken \u53EF\u4EE5\u5728\u7528\u6237\u767B\u9646\u540E\u4EA7\u751F\u5E76\u653E\u4E8E session \u4E4B\u4E2D\uFF0C\u7136\u540E\u5728\u6BCF\u6B21\u8BF7\u6C42\u65F6\u628A token \u4ECE session \u4E2D\u62FF\u51FA\uFF0C\u4E0E\u8BF7\u6C42\u4E2D\u7684 token \u8FDB\u884C\u6BD4\u5BF9\uFF0C\u4F46\u8FD9\u79CD\u65B9\u6CD5\u7684\u96BE\u70B9\u5728\u4E8E\u5982\u4F55\u628A token \u4EE5\u53C2\u6570\u7684\u5F62\u5F0F\u52A0\u5165\u8BF7\u6C42\u3002\u5BF9\u4E8E GET \u8BF7\u6C42\uFF0Ctoken \u5C06\u9644\u5728\u8BF7\u6C42\u5730\u5740\u4E4B\u540E\uFF0C\u8FD9\u6837 URL \u5C31\u53D8\u6210 "),n("a",T,[s("http://url?csrftoken=tokenvalue\u3002"),t(a)]),s(" \u800C\u5BF9\u4E8E POST \u8BF7\u6C42\u6765\u8BF4\uFF0C\u8981\u5728 form \u7684\u6700\u540E\u52A0\u4E0A "),_,s("\uFF0C\u8FD9\u6837\u5C31\u628A token \u4EE5\u53C2\u6570\u7684\u5F62\u5F0F\u52A0\u5165\u8BF7\u6C42\u4E86\u3002\u4F46\u662F\uFF0C\u5728\u4E00\u4E2A\u7F51\u7AD9\u4E2D\uFF0C\u53EF\u4EE5\u63A5\u53D7\u8BF7\u6C42\u7684\u5730\u65B9\u975E\u5E38\u591A\uFF0C\u8981\u5BF9\u4E8E\u6BCF\u4E00\u4E2A\u8BF7\u6C42\u90FD\u52A0\u4E0A token \u662F\u5F88\u9EBB\u70E6\u7684\uFF0C\u5E76\u4E14\u5F88\u5BB9\u6613\u6F0F\u6389\uFF0C\u901A\u5E38\u4F7F\u7528\u7684\u65B9\u6CD5\u5C31\u662F\u5728\u6BCF\u6B21\u9875\u9762\u52A0\u8F7D\u65F6\uFF0C\u4F7F\u7528 javascript \u904D\u5386\u6574\u4E2A dom \u6811\uFF0C\u5BF9\u4E8E dom \u4E2D\u6240\u6709\u7684 a \u548C form \u6807\u7B7E\u540E\u52A0\u5165 token\u3002\u8FD9\u6837\u53EF\u4EE5\u89E3\u51B3\u5927\u90E8\u5206\u7684\u8BF7\u6C42\uFF0C\u4F46\u662F\u5BF9\u4E8E\u5728\u9875\u9762\u52A0\u8F7D\u4E4B\u540E\u52A8\u6001\u751F\u6210\u7684 html \u4EE3\u7801\uFF0C\u8FD9\u79CD\u65B9\u6CD5\u5C31\u6CA1\u6709\u4F5C\u7528\uFF0C\u8FD8\u9700\u8981\u7A0B\u5E8F\u5458\u5728\u7F16\u7801\u65F6\u624B\u52A8\u6DFB\u52A0 token\u3002")]),x,n("p",null,[n("a",F,[s("\u5F00\u53D1\u5B89\u5168 - CSRF \u8BE6\u89E3"),t(a)])])])}const O=p(i,[["render",E],["__file","dev-security-x-csrf.html.vue"]]);export{O as default};
