import{_ as o}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as i,c as p,a as n,b as e,d as s,f as t,r}from"./app.89148984.js";const l={},c=t(`<h1 id="gc-java-\u5783\u573E\u56DE\u6536\u5668\u4E4Bg1-\u8865\u5145" tabindex="-1"><a class="header-anchor" href="#gc-java-\u5783\u573E\u56DE\u6536\u5668\u4E4Bg1-\u8865\u5145" aria-hidden="true">#</a> GC - Java \u5783\u573E\u56DE\u6536\u5668\u4E4BG1\uFF08\u8865\u5145\uFF09</h1><h2 id="_1-\u524D\u8A00" tabindex="-1"><a class="header-anchor" href="#_1-\u524D\u8A00" aria-hidden="true">#</a> 1. \u524D\u8A00</h2><blockquote><p>G1:\u6EE1\u8DB3\u9AD8\u541E\u5410\u91CF\u7684\u540C\u65F6\u6EE1\u8DB3GC\u505C\u987F\u7684\u65F6\u95F4\u5C3D\u53EF\u80FD\u77ED</p></blockquote><p>G1\u6536\u96C6\u5668\u662F\u4E00\u6B3E\u5728server\u7AEF\u8FD0\u884C\u7684\u5783\u573E\u6536\u96C6\u5668\uFF0C\u4E13\u95E8\u9488\u5BF9\u4E8E\u62E5\u6709\u591A\u6838\u5904\u7406\u5668\u548C\u5927\u5185\u5B58\u7684\u673A\u5668\uFF0C\u5728JDK 7u4\u7248\u672C\u53D1\u884C\u65F6\u88AB\u6B63\u5F0F\u63A8\u51FA\uFF0C\u5728JDK9\u4E2D\u66F4\u88AB\u6307\u5B9A\u4E3A\u5B98\u65B9GC\u6536\u96C6\u5668\u3002<strong>\u5B83\u6EE1\u8DB3\u9AD8\u541E\u5410\u91CF\u7684\u540C\u65F6\u6EE1\u8DB3GC\u505C\u987F\u7684\u65F6\u95F4\u5C3D\u53EF\u80FD\u77ED</strong>\u3002</p><h3 id="_1-1-g1-\u4F18\u52BF" tabindex="-1"><a class="header-anchor" href="#_1-1-g1-\u4F18\u52BF" aria-hidden="true">#</a> 1.1. G1 \u4F18\u52BF</h3><p>G1\u6536\u96C6\u5668\u4E13\u95E8\u9488\u5BF9\u4EE5\u4E0B\u5E94\u7528\u573A\u666F\u8BBE\u8BA1</p><ul><li>\u53EF\u4EE5\u50CFCMS\u6536\u96C6\u5668\u4E00\u6837\u53EF\u4EE5\u548C\u5E94\u7528\u5E76\u53D1\u8FD0\u884C</li><li>\u538B\u7F29\u7A7A\u95F2\u7684\u5185\u5B58\u788E\u7247\uFF0C\u5374\u4E0D\u9700\u8981\u5197\u957F\u7684GC\u505C\u987F</li><li>\u5BF9GC\u505C\u987F\u53EF\u4EE5\u505A\u66F4\u597D\u7684\u9884\u6D4B</li><li>\u4E0D\u60F3\u727A\u7272\u5927\u91CF\u7684\u541E\u5410\u91CF\u6027\u80FD</li><li>\u4E0D\u9700\u8981\u66F4\u5927\u7684Java Heap</li></ul><blockquote><p>Can operate concurrently with applications threads like the CMS collector. Compact free space without lengthy GC induced pause times. Need more predictable GC pause durations. Do not want to sacrifice a lot of throughput performance. Do not require a much larger Java heap.</p></blockquote><h3 id="_1-2-\u4E0Ecms\u4E0D\u540C\u70B9" tabindex="-1"><a class="header-anchor" href="#_1-2-\u4E0Ecms\u4E0D\u540C\u70B9" aria-hidden="true">#</a> 1.2 \u4E0ECMS\u4E0D\u540C\u70B9</h3><p>G1\u4ECE\u957F\u671F\u8BA1\u5212\u6765\u770B\u662F\u4EE5\u53D6\u4EE3CMS\u4E3A\u76EE\u6807\u3002\u4E0ECMS\u76F8\u6BD4\u6709\u51E0\u4E2A\u4E0D\u540C\u70B9\u4F7F\u5F97G1\u6210\u4E3AGC\u7684\u66F4\u597D\u89E3\u51B3\u65B9\u6848\u3002</p><ul><li>\u7B2C\u4E00\u70B9\uFF1AG1\u4F1A\u538B\u7F29\u7A7A\u95F2\u5185\u5B58\u4F7F\u4E4B\u8DB3\u591F\u7D27\u51D1\uFF0C\u505A\u6CD5<strong>\u662F\u7528regions\u4EE3\u66FF\u7EC6\u7C92\u5EA6\u7684\u7A7A\u95F2\u5217\u8868\u8FDB\u884C\u5206\u914D</strong>\uFF0C\u51CF\u5C11\u5185\u5B58\u788E\u7247\u7684\u4EA7\u751F\u3002</li><li>\u7B2C\u4E8C\u70B9\uFF1AG1\u7684STW\u66F4\u53EF\u63A7\uFF0CG1\u5728\u505C\u987F\u65F6\u95F4\u4E0A\u6DFB\u52A0\u4E86<strong>\u9884\u6D4B\u673A\u5236</strong>\uFF0C\u7528\u6237\u53EF\u4EE5\u6307\u5B9A\u671F\u671B\u505C\u987F\u65F6\u95F4\u3002</li></ul><blockquote><p>G1 is planned as the long term replacement for the Concurrent Mark-Sweep Collector (CMS). Comparing G1 with CMS, there are differences that make G1 a better solution. One difference is that G1 is a compacting collector. G1 compacts sufficiently to completely avoid the use of fine-grained free lists for allocation, and instead relies on regions. This considerably simplifies parts of the collector, and mostly eliminates potential fragmentation issues. Also, G1 offers more predictable garbage collection pauses than the CMS collector, and allows users to specify desired pause targets.</p></blockquote><h2 id="_2-\u6982\u89C8" tabindex="-1"><a class="header-anchor" href="#_2-\u6982\u89C8" aria-hidden="true">#</a> 2. \u6982\u89C8</h2><p>\u5728\u4F20\u7EDF\u7684GC\u6536\u96C6\u5668(serial,parallel,CMS)\u65E0\u4E00\u4E0D\u4F8B\u5916\u90FD\u628Aheap\u5206\u6210\u56FA\u5B9A\u5927\u5C0F\u8FDE\u7EED\u7684\u4E09\u4E2A\u7A7A\u95F4\uFF1Ayoung generation, old generation, and permanent generation</p><p><img src="https://abelsun-1256449468.cos.ap-beijing.myqcloud.com/image/image-20221209111945943.png" alt="image-20221209111945943"></p><p>\u4F46G1\u5374\u72EC\u8F9F\u8E4A\u5F84\uFF0C\u91C7\u7528\u4E86\u4E00\u79CD\u5168\u65B0\u7684\u5185\u5B58\u5E03\u5C40</p><p><img src="https://abelsun-1256449468.cos.ap-beijing.myqcloud.com/image/image-20221209112005861.png" alt="image-20221209112005861"></p><p>\u5728G1\u4E2D\u5806\u88AB\u5206\u6210\u4E00\u5757\u5757\u5927\u5C0F\u76F8\u7B49\u7684heap region\uFF0C\u4E00\u822C\u67092000\u591A\u5757\uFF0C\u8FD9\u4E9Bregion\u5728\u903B\u8F91\u4E0A\u662F\u8FDE\u7EED\u7684\u3002\u6BCF\u5757region\u90FD\u4F1A\u88AB\u6253\u552F\u4E00\u7684\u5206\u4EE3\u6807\u5FD7(eden,survivor,old)\u3002\u5728\u903B\u8F91\u4E0A\uFF0Ceden regions\u6784\u6210Eden\u7A7A\u95F4\uFF0Csurvivor regions\u6784\u6210Survivor\u7A7A\u95F4\uFF0Cold regions\u6784\u6210\u4E86old \u7A7A\u95F4\u3002</p><h3 id="_2-1-\u5206\u533Aregion-\u5404\u533A\u6BD4\u4F8B" tabindex="-1"><a class="header-anchor" href="#_2-1-\u5206\u533Aregion-\u5404\u533A\u6BD4\u4F8B" aria-hidden="true">#</a> 2.1 \u5206\u533Aregion \u5404\u533A\u6BD4\u4F8B</h3><p>\u901A\u8FC7\u547D\u4EE4\u884C\u53C2\u6570</p><ul><li><code>-XX:NewRatio=n</code>\u6765\u914D\u7F6E\u65B0\u751F\u4EE3\u4E0E\u8001\u5E74\u4EE3\u7684\u6BD4\u4F8B\uFF0C\u9ED8\u8BA4\u4E3A2\uFF0C\u5373\u6BD4\u4F8B\u4E3A2:1\uFF1B</li><li><code>XX:SurvivorRatio=n</code>\u5219\u53EF\u4EE5\u914D\u7F6EEden\u4E0ESurvivor\u7684\u6BD4\u4F8B\uFF0C\u9ED8\u8BA4\u4E3A8\u3002</li></ul><h3 id="_2-2-\u4E3A\u4EC0\u4E48\u53EBg1-\u5168\u5C40\u5E76\u53D1\u6807\u8BB0-\u4F18\u5148\u56DE\u6536" tabindex="-1"><a class="header-anchor" href="#_2-2-\u4E3A\u4EC0\u4E48\u53EBg1-\u5168\u5C40\u5E76\u53D1\u6807\u8BB0-\u4F18\u5148\u56DE\u6536" aria-hidden="true">#</a> 2.2 \u4E3A\u4EC0\u4E48\u53EBG1\uFF08\u5168\u5C40\u5E76\u53D1\u6807\u8BB0-&gt;\u4F18\u5148\u56DE\u6536\uFF09</h3><blockquote><p>\u5168\u5C40\u5E76\u53D1\u6807\u8BB0-&gt;\u53EF\u56DE\u6536\u5BF9\u8C61\u591A-&gt;\u4F18\u5148\u56DE\u6536</p></blockquote><p>GC\u65F6G1\u7684\u8FD0\u884C\u65B9\u5F0F\u4E0ECMS\u65B9\u5F0F\u7C7B\u4F3C\uFF0C\u4F1A\u6709\u4E00\u4E2A\u5168\u5C40\u5E76\u53D1\u6807\u8BB0(concurrent global marking phase)\u7684\u8FC7\u7A0B\uFF0C\u53BB\u786E\u5B9A\u5806\u91CC\u5BF9\u8C61\u7684\u7684\u5B58\u6D3B\u60C5\u51B5\u3002\u5E76\u53D1\u6807\u8BB0\u5B8C\u6210\u4E4B\u540E\uFF0CG1\u77E5\u9053\u54EA\u4E9Bregions\u7A7A\u95F2\u7A7A\u95F4\u591A(\u53EF\u56DE\u6536\u5BF9\u8C61\u591A),\u4F18\u5148\u56DE\u6536\u8FD9\u4E9B\u7A7A\u7684regions\uFF0C\u91CA\u653E\u51FA\u5927\u91CF\u7684\u7A7A\u95F2\u7A7A\u95F4\u3002\u8FD9\u662F\u4E3A\u4EC0\u4E48\u8FD9\u79CD\u5783\u573E\u56DE\u6536\u65B9\u5F0F\u53EBG1\u7684\u539F\u56E0(Garbage-First)\u3002</p><h3 id="_2-3-\u6682\u505C\u9884\u6D4B\u6A21\u578B" tabindex="-1"><a class="header-anchor" href="#_2-3-\u6682\u505C\u9884\u6D4B\u6A21\u578B" aria-hidden="true">#</a> 2.3 \u6682\u505C\u9884\u6D4B\u6A21\u578B</h3><p>G1\u5C06\u5176\u6536\u96C6\u548C\u538B\u7F29\u6D3B\u52A8\u96C6\u4E2D\u5728\u5806\u4E2D\u53EF\u80FD\u5145\u6EE1\u53EF\u56DE\u6536\u5BF9\u8C61(\u5373\u5783\u573E)\u7684\u533A\u57DF\uFF0C\u4F7F\u7528\u6682\u505C\u9884\u6D4B\u6A21\u578B\u6765\u6EE1\u8DB3\u7528\u6237\u5B9A\u4E49\u7684\u6682\u505C\u65F6\u95F4\u76EE\u6807\uFF0C\u5E76\u6839\u636E\u6307\u5B9A\u7684\u6682\u505C\u65F6\u95F4\u76EE\u6807\u9009\u62E9\u8981\u6536\u96C6\u7684\u533A\u57DF\u6570\u91CF\u3002</p><p>\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0CG1\u4E0D\u662F\u5B9E\u65F6\u6536\u96C6\u5668\u3002\u5B83\u80FD\u591F\u4EE5\u8F83\u9AD8\u7684\u6982\u7387\u6EE1\u8DB3\u8BBE\u5B9A\u7684\u6682\u505C\u65F6\u95F4\u76EE\u6807\uFF0C\u4F46\u4E0D\u662F\u7EDD\u5BF9\u786E\u5B9A\u7684\u3002\u6839\u636E\u4EE5\u524D\u6536\u96C6\u7684\u6570\u636E\uFF0CG1\u4F30\u7B97\u51FA\u5728\u7528\u6237\u6307\u5B9A\u7684\u76EE\u6807\u65F6\u95F4\u5185\u53EF\u4EE5\u6536\u96C6\u591A\u5C11\u4E2A\u533A\u57DF\u3002\u56E0\u6B64\uFF0C\u6536\u96C6\u5668\u5BF9\u4E8E\u6536\u96C6\u533A\u57DF\u7684\u6210\u672C\u6709\u4E00\u4E2A\u76F8\u5F53\u51C6\u786E\u7684\u6A21\u578B\uFF0C\u5B83\u4F7F\u7528\u8FD9\u4E2A\u6A21\u578B\u6765\u786E\u5B9A\u5728\u6682\u505C\u65F6\u95F4\u76EE\u6807\u5185\u6536\u96C6\u54EA\u4E9B\u533A\u57DF\u548C\u6536\u96C6\u591A\u5C11\u533A\u57DF\u3002</p><blockquote><p>It is important to note that G1 is not a real-time collector. It meets the set pause time target with high probability but not absolute certainty. Based on data from previous collections, G1 does an estimate of how many regions can be collected within the user specified target time. Thus, the collector has a reasonably accurate model of the cost of collecting the regions, and it uses this model to determine which and how many regions to collect while staying within the pause time target.</p></blockquote><h2 id="_3-g1\u4E2D\u7684region" tabindex="-1"><a class="header-anchor" href="#_3-g1\u4E2D\u7684region" aria-hidden="true">#</a> 3. G1\u4E2D\u7684Region</h2><p>G1\u4E2D\u6BCF\u4E2ARegion\u5927\u5C0F\u662F\u56FA\u5B9A\u76F8\u7B49\u7684\uFF0CRegion\u7684\u5927\u5C0F\u53EF\u4EE5\u901A\u8FC7\u53C2\u6570-XX:G1HeapRegionSize\u8BBE\u5B9A\uFF0C\u53D6\u503C\u8303\u56F4\u4ECE1M\u523032M\uFF0C\u4E14\u662F2\u7684\u6307\u6570\u3002\u5982\u679C\u4E0D\u8BBE\u5B9A\uFF0C\u90A3\u4E48G1\u4F1A\u6839\u636EHeap\u5927\u5C0F\u81EA\u52A8\u51B3\u5B9A\u3002</p><p>\u51B3\u5B9A\u903B\u8F91:</p><p><code>size =\uFF08\u5806\u6700\u5C0F\u503C+\u5806\u6700\u5927\u503C\uFF09/ TARGET_REGION_NUMBER(2048)</code> \uFF0C\u7136\u540Esize\u53D6\u6700\u9760\u8FD12\u7684\u5E42\u6B21\u6570\u503C\uFF0C \u5E76\u5C06size\u63A7\u5236\u5728[1M,32M]\u4E4B\u95F4\u3002\u5177\u4F53\u4EE3\u7801\u5982\u4E0B</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// share/vm/gc_implementation/g1/heapRegion.cpp</span>
<span class="token comment">// Minimum region size; we won&#39;t go lower than that.</span>
<span class="token comment">// We might want to decrease this in the future, to deal with small</span>
<span class="token comment">// heaps a bit more efficiently.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_REGION_SIZE</span>  <span class="token expression"><span class="token punctuation">(</span>      <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token punctuation">)</span></span></span>
<span class="token comment">// Maximum region size; we don&#39;t go higher than that. There&#39;s a good</span>
<span class="token comment">// reason for having an upper bound. We don&#39;t want regions to get too</span>
<span class="token comment">// large, otherwise cleanup&#39;s effectiveness would decrease as there</span>
<span class="token comment">// will be fewer opportunities to find totally empty regions after</span>
<span class="token comment">// marking.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_REGION_SIZE</span>  <span class="token expression"><span class="token punctuation">(</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token punctuation">)</span></span></span>
<span class="token comment">// The automatic region size calculation will try to have around this</span>
<span class="token comment">// many regions in the heap (based on the min heap size).</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGET_REGION_NUMBER</span>          <span class="token expression"><span class="token number">2048</span></span></span>
<span class="token keyword">void</span> <span class="token class-name">HeapRegion</span><span class="token double-colon punctuation">::</span><span class="token function">setup_heap_region_size</span><span class="token punctuation">(</span>size_t initial_heap_size<span class="token punctuation">,</span> size_t max_heap_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uintx region_size <span class="token operator">=</span> G1HeapRegionSize<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FLAG_IS_DEFAULT</span><span class="token punctuation">(</span>G1HeapRegionSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t average_heap_size <span class="token operator">=</span> <span class="token punctuation">(</span>initial_heap_size <span class="token operator">+</span> max_heap_size<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    region_size <span class="token operator">=</span> <span class="token function">MAX2</span><span class="token punctuation">(</span>average_heap_size <span class="token operator">/</span> TARGET_REGION_NUMBER<span class="token punctuation">,</span>
                       <span class="token punctuation">(</span>uintx<span class="token punctuation">)</span> MIN_REGION_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">int</span> region_size_log <span class="token operator">=</span> <span class="token function">log2_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span>jlong<span class="token punctuation">)</span> region_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Recalculate the region size to make sure it&#39;s a power of</span>
  <span class="token comment">// 2. This means that region_size is the largest power of 2 that&#39;s</span>
  <span class="token comment">// &lt;= what we&#39;ve calculated so far.</span>
  region_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintx<span class="token punctuation">)</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> region_size_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Now make sure that we don&#39;t go over or under our limits.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>region_size <span class="token operator">&lt;</span> MIN_REGION_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    region_size <span class="token operator">=</span> MIN_REGION_SIZE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>region_size <span class="token operator">&gt;</span> MAX_REGION_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    region_size <span class="token operator">=</span> MAX_REGION_SIZE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-g1\u4E2D\u7684gc\u6536\u96C6" tabindex="-1"><a class="header-anchor" href="#_4-g1\u4E2D\u7684gc\u6536\u96C6" aria-hidden="true">#</a> 4. G1\u4E2D\u7684GC\u6536\u96C6</h2><p><strong>G1\u4FDD\u7559\u4E86YGC\u5E76\u52A0\u4E0A\u4E86\u4E00\u79CD\u5168\u65B0\u7684MIXGC\u7528\u4E8E\u6536\u96C6\u8001\u5E74\u4EE3\u3002G1\u4E2D\u6CA1\u6709Full GC\uFF0CG1\u4E2D\u7684Full GC\u662F\u91C7\u7528serial old Full GC\u3002</strong></p><blockquote><p>Q:\u7406\u89E3\u4E0D\u4E86\u201CG1\u4E2D\u6CA1\u6709Full GC\uFF0CG1\u4E2D\u7684Full GC\u662F\u91C7\u7528serial old Full GC\u3002\u201C\u8FD9\u53E5\u8BDD\uFF0C\u4E0D\u662F\u8BF4\u6CA1\u6709Full GC\u5417</p><p>A1: G1\u4E2D\u5B9E\u9645\u662F\u6709full gc\u7684\u53EA\u662F\u975E\u5E38\u6162\uFF0C\u6240\u4EE5g1\u7684\u4F18\u5316\u76EE\u6807\u662F\u5C3D\u91CF\u907F\u514Dfull gc\uFF0C\u56E0\u6B64\u624D\u6709\u5982\u4E0A\u8BF4\u6CD5</p><p>A2:\u5982\u679Cmixed GC\u5B9E\u5728\u65E0\u6CD5\u8DDF\u4E0A\u7A0B\u5E8F\u5206\u914D\u5185\u5B58\u7684\u901F\u5EA6\uFF0C\u5BFC\u81F4old gen\u586B\u6EE1\u65E0\u6CD5\u7EE7\u7EED\u8FDB\u884Cmixed GC\uFF0C\u5C31\u4F1A\u5207\u6362\u5230&quot;G1\u4E4B\u5916\u7684serial old GC&quot;\u6765\u6536\u96C6\u6574\u4E2AGC heap\uFF08\u6CE8\u610F\uFF0C\u5305\u62ECyoung\u3001old\u3001perm\uFF09\u3002\u8FD9\u624D\u662F\u771F\u6B63\u7684full GC\u3002Full GC\u4E4B\u6240\u4EE5\u53EBfull\u5C31\u662F\u8981\u6536\u96C6\u6574\u4E2A\u5806\uFF0C\u53EA\u9009\u62E9old gen\u7684\u90E8\u5206region\u7B97\u4E0D\u4E0Afull GC\u3002\u8FDB\u5165\u8FD9\u79CD\u72B6\u6001\u7684G1\u5C31\u8DDF-XX:+UseSerialGC\u7684full GC\u4E00\u6837</p></blockquote><h2 id="_5-ygc" tabindex="-1"><a class="header-anchor" href="#_5-ygc" aria-hidden="true">#</a> 5.YGC</h2><p>\u5F53Eden\u7A7A\u95F4\u88AB\u5360\u6EE1\u4E4B\u540E\uFF0C\u5C31\u4F1A\u89E6\u53D1YGC\u3002\u5728G1\u4E2DYGC\u4F9D\u7136\u91C7\u7528\u590D\u5236\u5B58\u6D3B\u5BF9\u8C61\u5230survivor\u7A7A\u95F4\u7684\u65B9\u5F0F\uFF0C\u5F53\u5BF9\u8C61\u7684\u5B58\u6D3B\u5E74\u9F84\u6EE1\u8DB3\u664B\u5347\u6761\u4EF6\u65F6\uFF0C\u628A\u5BF9\u8C61\u63D0\u5347\u5230old generation regions(\u8001\u5E74\u4EE3)\u3002</p><p>G1\u63A7\u5236YGC\u5F00\u9500\u7684\u624B\u6BB5\u662F\u52A8\u6001\u6539\u53D8young region\u7684\u4E2A\u6570\uFF0CYGC\u7684\u8FC7\u7A0B\u4E2D\u4F9D\u7136\u4F1ASTW(stop the world \u5E94\u7528\u505C\u987F)\uFF0C\u5E76\u91C7\u7528\u591A\u7EBF\u7A0B\u5E76\u53D1\u590D\u5236\u5BF9\u8C61\uFF0C\u51CF\u5C11GC\u505C\u987F\u65F6\u95F4\u3002</p><h3 id="_5-1-ygc\u5F00\u59CB" tabindex="-1"><a class="header-anchor" href="#_5-1-ygc\u5F00\u59CB" aria-hidden="true">#</a> 5.1 YGC\u5F00\u59CB</h3><p><img src="https://abelsun-1256449468.cos.ap-beijing.myqcloud.com/image/image-20221209113334611.png" alt="image-20221209113334611"></p><h3 id="_5-2-ygc\u7ED3\u675F" tabindex="-1"><a class="header-anchor" href="#_5-2-ygc\u7ED3\u675F" aria-hidden="true">#</a> 5.2 YGC\u7ED3\u675F</h3><p><img src="https://abelsun-1256449468.cos.ap-beijing.myqcloud.com/image/image-20221209113401283.png" alt="image-20221209113401283"></p><p>\u6211\u4EEC\u4ECE\u56FE\u4E2D\u770B\u5230Eden\u533A\u4E2D\u5B58\u6D3B\u5BF9\u8C61\u88AB\u590D\u5236\u5230\u65B0\u7684Survior\u533A\u3002</p><h3 id="_5-3-ygc\u662F\u5426\u9700\u8981\u626B\u63CF\u6574\u4E2A\u8001\u5E74\u4EE3-rset" tabindex="-1"><a class="header-anchor" href="#_5-3-ygc\u662F\u5426\u9700\u8981\u626B\u63CF\u6574\u4E2A\u8001\u5E74\u4EE3-rset" aria-hidden="true">#</a> 5.3 YGC\u662F\u5426\u9700\u8981\u626B\u63CF\u6574\u4E2A\u8001\u5E74\u4EE3\uFF1FRset</h3><p>\u6211\u4EEC\u77E5\u9053\u5224\u65AD\u5BF9\u8C61\u662F\u5426\u5B58\u6D3B\u9700\u8981\u4ECEGC ROOTS\u7ED3\u70B9\u51FA\u53D1\uFF0C\u4ECEGC ROOTS\u7ED3\u70B9\u53EF\u8FBE\u7684\u5BF9\u8C61\u5C31\u662F\u5B58\u6D3B\u7684\u3002\u5728YGC\u65F6\uFF0C\u8001\u5E74\u4EE3\u4E2D\u7684\u5BF9\u8C61\u662F\u4E0D\u56DE\u6536\u7684\uFF0C\u4E5F\u5C31\u610F\u5473\u7740GC ROOTS\u91CC\u9762\u5E94\u5305\u542B\u4E86\u8001\u5E74\u4EE3\u4E2D\u7684\u5BF9\u8C61\u3002<strong>\u4F46\u626B\u63CF\u6574\u4E2A\u8001\u5E74\u4EE3\u4F1A\u5F88\u8017\u8D39\u65F6\u95F4\uFF0C\u52BF\u5FC5\u5F71\u54CD\u6574\u4E2AGC\u7684\u6027\u80FD\uFF01</strong>\u3002\u6240\u4EE5\u5728CMS\u4E2D\u4F7F\u7528\u4E86Card Table\u7684\u7ED3\u6784\uFF0C\u91CC\u9762\u8BB0\u5F55\u4E86\u8001\u5E74\u4EE3\u5BF9\u8C61\u5230\u65B0\u751F\u4EE3\u5F15\u7528\u3002**Card Table\u7684\u7ED3\u6784\u662F\u4E00\u4E2A\u8FDE\u7EED\u7684byte[]\u6570\u7EC4\uFF0C\u626B\u63CFCard Table\u7684\u65F6\u95F4\u6BD4\u626B\u63CF\u6574\u4E2A\u8001\u5E74\u4EE3\u7684\u4EE3\u4EF7\u8981\u5C0F\u5F88\u591A\uFF01G1\u4E5F\u53C2\u7167\u4E86\u8FD9\u4E2A\u601D\u8DEF\uFF0C\u4E0D\u8FC7\u91C7\u7528\u4E86\u4E00\u79CD\u65B0\u7684\u6570\u636E\u7ED3\u6784 Remembered Set \u7B80\u79F0Rset\u3002**RSet\u8BB0\u5F55\u4E86\u5176\u4ED6Region\u4E2D\u7684\u5BF9\u8C61\u5F15\u7528\u672CRegion\u4E2D\u5BF9\u8C61\u7684\u5173\u7CFB\uFF0C\u5C5E\u4E8Epoints-into\u7ED3\u6784\uFF08\u8C01\u5F15\u7528\u4E86\u6211\u7684\u5BF9\u8C61\uFF09\u3002\u800CCard Table\u5219\u662F\u4E00\u79CDpoints-out\uFF08\u6211\u5F15\u7528\u4E86\u8C01\u7684\u5BF9\u8C61\uFF09\u7684\u7ED3\u6784\uFF0C\u6BCF\u4E2ACard \u8986\u76D6\u4E00\u5B9A\u8303\u56F4\u7684Heap\uFF08\u4E00\u822C\u4E3A512Bytes\uFF09\u3002G1\u7684RSet\u662F\u5728Card Table\u7684\u57FA\u7840\u4E0A\u5B9E\u73B0\u7684\uFF1A\u6BCF\u4E2ARegion\u4F1A\u8BB0\u5F55\u4E0B\u522B\u7684Region\u6709\u6307\u5411\u81EA\u5DF1\u7684\u6307\u9488\uFF0C\u5E76\u6807\u8BB0\u8FD9\u4E9B\u6307\u9488\u5206\u522B\u5728\u54EA\u4E9BCard\u7684\u8303\u56F4\u5185\u3002 \u8FD9\u4E2ARSet\u5176\u5B9E\u662F\u4E00\u4E2AHash Table\uFF0CKey\u662F\u522B\u7684Region\u7684\u8D77\u59CB\u5730\u5740\uFF0CValue\u662F\u4E00\u4E2A\u96C6\u5408\uFF0C\u91CC\u9762\u7684\u5143\u7D20\u662FCard Table\u7684Index\u3002<strong>\u6BCF\u4E2ARegion\u90FD\u6709\u4E00\u4E2A\u5BF9\u5E94\u7684Rset</strong>\u3002</p><p><img src="https://abelsun-1256449468.cos.ap-beijing.myqcloud.com/image/image-20221209140929589.png" alt="image-20221209140929589"></p><p>RSet\u7A76\u7ADF\u662F\u600E\u4E48\u8F85\u52A9GC\u7684\u5462\uFF1F\u5728\u505AYGC\u7684\u65F6\u5019\uFF0C\u53EA\u9700\u8981\u9009\u5B9Ayoung generation region\u7684RSet\u4F5C\u4E3A\u6839\u96C6\uFF0C\u8FD9\u4E9BRSet\u8BB0\u5F55\u4E86<code>old-&gt;young</code>\u7684\u8DE8\u4EE3\u5F15\u7528\uFF0C\u907F\u514D\u4E86\u626B\u63CF\u6574\u4E2Aold generation\u3002 \u800Cmixed gc\u7684\u65F6\u5019\uFF0Cold generation\u4E2D\u8BB0\u5F55\u4E86<code>old-&gt;old</code>\u7684RSet\uFF0C<code>young-&gt;old</code>\u7684\u5F15\u7528\u7531\u626B\u63CF\u5168\u90E8young generation region\u5F97\u5230\uFF0C\u8FD9\u6837\u4E5F\u4E0D\u7528\u626B\u63CF\u5168\u90E8old generation region\u3002\u6240\u4EE5RSet\u7684\u5F15\u5165\u5927\u5927\u51CF\u5C11\u4E86GC\u7684\u5DE5\u4F5C\u91CF\u3002</p><p><strong>\u6240\u4EE5G1\u4E2DYGC\u4E0D\u9700\u8981\u626B\u63CF\u6574\u4E2A\u8001\u5E74\u4EE3\uFF0C\u53EA\u9700\u8981\u626B\u63CFRset\u5C31\u53EF\u4EE5\u77E5\u9053\u8001\u5E74\u4EE3\u5F15\u7528\u4E86\u54EA\u4E9B\u65B0\u751F\u4EE3\u4E2D\u7684\u5BF9\u8C61\u3002</strong></p><h2 id="_6-mixgc" tabindex="-1"><a class="header-anchor" href="#_6-mixgc" aria-hidden="true">#</a> 6. MIXGC</h2><p>G1\u4E2D\u7684MIXGC\u9009\u5B9A\u6240\u6709\u65B0\u751F\u4EE3\u91CC\u7684Region\uFF0C\u5916\u52A0\u6839\u636Eglobal concurrent marking\u7EDF\u8BA1\u5F97\u51FA\u6536\u96C6\u6536\u76CA\u9AD8\u7684\u82E5\u5E72\u8001\u5E74\u4EE3Region\uFF0C\u5728\u7528\u6237\u6307\u5B9A\u7684\u5F00\u9500\u76EE\u6807\u8303\u56F4\u5185\u5C3D\u53EF\u80FD\u9009\u62E9\u6536\u76CA\u9AD8\u7684\u8001\u5E74\u4EE3Region\u8FDB\u884C\u56DE\u6536\u3002\u6240\u4EE5MIXGC\u56DE\u6536\u7684\u5185\u5B58\u533A\u57DF\u662F\u65B0\u751F\u4EE3+\u8001\u5E74\u4EE3\u3002</p><p>\u5728\u4ECB\u7ECDMIXGC\u4E4B\u524D\u6211\u4EEC\u9700\u8981\u5148\u4E86\u89E3global concurrent marking\uFF0C\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u3002\u56E0\u4E3A\u8001\u5E74\u4EE3\u56DE\u6536\u8981\u4F9D\u8D56\u8BE5\u8FC7\u7A0B\u3002</p><h3 id="_6-1-\u5168\u5C40\u5E76\u53D1\u6807\u8BB0" tabindex="-1"><a class="header-anchor" href="#_6-1-\u5168\u5C40\u5E76\u53D1\u6807\u8BB0" aria-hidden="true">#</a> 6.1 \u5168\u5C40\u5E76\u53D1\u6807\u8BB0</h3><p>\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u8FC7\u7A0B\u5206\u4E3A\u4E94\u4E2A\u9636\u6BB5</p><p>(1) Initial Mark\u521D\u59CB\u6807\u8BB0 STW</p><p>Initial Mark\u521D\u59CB\u6807\u8BB0\u662F\u4E00\u4E2ASTW\u4E8B\u4EF6\uFF0C\u5176\u5B8C\u6210\u5DE5\u4F5C\u662F\u6807\u8BB0GC ROOTS \u76F4\u63A5\u53EF\u8FBE\u7684\u5BF9\u8C61\u3002\u5E76\u5C06\u5B83\u4EEC\u7684\u5B57\u6BB5\u538B\u5165\u626B\u63CF\u6808\uFF08marking stack\uFF09\u4E2D\u7B49\u5230\u540E\u7EED\u626B\u63CF\u3002G1\u4F7F\u7528\u5916\u90E8\u7684bitmap\u6765\u8BB0\u5F55mark\u4FE1\u606F\uFF0C\u800C\u4E0D\u4F7F\u7528\u5BF9\u8C61\u5934\u7684mark word\u91CC\u7684mark bit\u3002\u56E0\u4E3A STW\uFF0C\u6240\u4EE5\u901A\u5E38YGC\u7684\u65F6\u5019\u501F\u7528YGC\u7684STW\u987A\u4FBF\u542F\u52A8Initial Mark\uFF0C\u4E5F\u5C31\u662F\u542F\u52A8\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\uFF0C\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u4E0EYGC\u5728\u903B\u8F91\u4E0A\u72EC\u7ACB\u3002</p><blockquote><p>(1) Initial Mark *(Stop the World Event)*This is a stop the world event. With G1, it is piggybacked on a normal young GC. Mark survivor regions (root regions) which may have references to objects in old generation.</p></blockquote><p>(2)Root Region Scanning \u6839\u533A\u57DF\u626B\u63CF</p><p>\u6839\u533A\u57DF\u626B\u63CF\u662F\u4ECESurvior\u533A\u7684\u5BF9\u8C61\u51FA\u53D1\uFF0C\u6807\u8BB0\u88AB\u5F15\u7528\u5230\u8001\u5E74\u4EE3\u4E2D\u7684\u5BF9\u8C61\uFF0C\u5E76\u628A\u5B83\u4EEC\u7684\u5B57\u6BB5\u5728\u538B\u5165\u626B\u63CF\u6808\uFF08marking stack\uFF09\u4E2D\u7B49\u5230\u540E\u7EED\u626B\u63CF\u3002\u4E0EInitial Mark\u4E0D\u4E00\u6837\u7684\u662F\uFF0CRoot Region Scanning\u4E0D\u9700\u8981STW\u4E0E\u5E94\u7528\u7A0B\u5E8F\u662F\u5E76\u53D1\u8FD0\u884C\u3002Root Region Scanning\u5FC5\u987B\u5728YGC\u5F00\u59CB\u524D\u5B8C\u6210\u3002</p><blockquote><p>(2) Root Region Scanning Scan survivor regions for references into the old generation. This happens while the application continues to run. The phase must be completed before a young GC can occur.</p></blockquote><p>(3)Concurrent Marking \u5E76\u53D1\u6807\u8BB0</p><p>\u4E0D\u9700\u8981STW\u3002\u4E0D\u65AD\u4ECE\u626B\u63CF\u6808\u53D6\u51FA\u5F15\u7528\u9012\u5F52\u626B\u63CF\u6574\u4E2A\u5806\u91CC\u7684\u5BF9\u8C61\u3002\u6BCF\u626B\u63CF\u5230\u4E00\u4E2A\u5BF9\u8C61\u5C31\u4F1A\u5BF9\u5176\u6807\u8BB0\uFF0C\u5E76\u5C06\u5176\u5B57\u6BB5\u538B\u5165\u626B\u63CF\u6808\u3002\u91CD\u590D\u626B\u63CF\u8FC7\u7A0B\u76F4\u5230\u626B\u63CF\u6808\u6E05\u7A7A\u3002\u8FC7\u7A0B\u4E2D\u8FD8\u4F1A\u626B\u63CFSATB write barrier\u6240\u8BB0\u5F55\u4E0B\u7684\u5F15\u7528\u3002Concurrent Marking \u53EF\u4EE5\u88ABYGC\u4E2D\u65AD</p><blockquote><p>(3) Concurrent Marking Find live objects over the entire heap. This happens while the application is running. This phase can be interrupted by young generation garbage collections.</p></blockquote><p>(4)Remark \u6700\u7EC8\u6807\u8BB0 STW</p><p>STW\u64CD\u4F5C\u3002\u5728\u5B8C\u6210\u5E76\u53D1\u6807\u8BB0\u540E\uFF0C\u6BCF\u4E2AJava\u7EBF\u7A0B\u8FD8\u4F1A\u6709\u4E00\u4E9B\u5269\u4E0B\u7684SATB write barrier\u8BB0\u5F55\u7684\u5F15\u7528\u5C1A\u672A\u5904\u7406\u3002\u8FD9\u4E2A\u9636\u6BB5\u5C31\u8D1F\u8D23\u628A\u5269\u4E0B\u7684\u5F15\u7528\u5904\u7406\u5B8C\u3002\u540C\u65F6\u8FD9\u4E2A\u9636\u6BB5\u4E5F\u8FDB\u884C\u5F31\u5F15\u7528\u5904\u7406\uFF08reference processing\uFF09\u3002\u6CE8\u610F\u8FD9\u4E2A\u6682\u505C\u4E0ECMS\u7684remark\u6709\u4E00\u4E2A\u672C\u8D28\u4E0A\u7684\u533A\u522B\uFF0C\u90A3\u5C31\u662F\u8FD9\u4E2A\u6682\u505C\u53EA\u9700\u8981\u626B\u63CFSATB buffer\uFF0C\u800CCMS\u7684remark\u9700\u8981\u91CD\u65B0\u626B\u63CFmod-union table\u91CC\u7684dirty card\u5916\u52A0\u6574\u4E2A\u6839\u96C6\u5408\uFF0C\u800C\u6B64\u65F6\u6574\u4E2Ayoung gen\uFF08\u4E0D\u7BA1\u5BF9\u8C61\u6B7B\u6D3B\uFF09\u90FD\u4F1A\u88AB\u5F53\u4F5C\u6839\u96C6\u5408\u7684\u4E00\u90E8\u5206\uFF0C\u56E0\u800CCMS remark\u6709\u53EF\u80FD\u4F1A\u975E\u5E38\u6162\u3002</p><blockquote><p>(4) Remark Completes the marking of live object in the heap. Uses an algorithm called snapshot-at-the-beginning (SATB) which is much faster than what was used in the CMS collector.</p></blockquote><p>(5)Cleanup \u6E05\u9664 STW AND <em>Concurrent</em></p><p>STW\u64CD\u4F5C\uFF0C\u6E05\u70B9\u51FA\u6709\u5B58\u6D3B\u5BF9\u8C61\u7684Region\u548C\u6CA1\u6709\u5B58\u6D3B\u5BF9\u8C61\u7684Region(Empty Region)</p><p>STW\u64CD\u4F5C\uFF0C\u66F4\u65B0Rset</p><p>Concurrent\u64CD\u4F5C\uFF0C\u628AEmpty Region\u6536\u96C6\u8D77\u6765\u5230\u53EF\u5206\u914DRegion\u961F\u5217\u3002</p><blockquote><p>(5) Cleanup Performs accounting on live objects and completely free regions. (Stop the world) Scrubs the Remembered Sets. (Stop the world) Reset the empty regions and return them to the free list. (Concurrent)</p></blockquote><h3 id="_6-2-\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_6-2-\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u603B\u7ED3" aria-hidden="true">#</a> 6.2 \u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u603B\u7ED3</h3><p><strong>\u7ECF\u8FC7global concurrent marking\uFF0Ccollector\u5C31\u77E5\u9053\u54EA\u4E9BRegion\u6709\u5B58\u6D3B\u7684\u5BF9\u8C61\u3002\u5E76\u5C06\u90A3\u4E9B\u5B8C\u5168\u53EF\u56DE\u6536\u7684Region(\u6CA1\u6709\u5B58\u6D3B\u5BF9\u8C61)\u6536\u96C6\u8D77\u6765\u52A0\u5165\u5230\u53EF\u5206\u914DRegion\u961F\u5217\uFF0C\u5B9E\u73B0\u5BF9\u8BE5\u90E8\u5206\u5185\u5B58\u7684\u56DE\u6536\u3002\u5BF9\u4E8E\u6709\u5B58\u6D3B\u5BF9\u8C61\u7684Region\uFF0CG1\u4F1A\u6839\u636E\u7EDF\u8BA1\u6A21\u578B\u627E\u5904\u6536\u76CA\u6700\u9AD8\u3001\u5F00\u9500\u4E0D\u8D85\u8FC7\u7528\u6237\u6307\u5B9A\u7684\u4E0A\u9650\u7684\u82E5\u5E72Region\u8FDB\u884C\u5BF9\u8C61\u56DE\u6536\u3002\u8FD9\u4E9B\u9009\u4E2D\u88AB\u56DE\u6536\u7684Region\u7EC4\u6210\u7684\u96C6\u5408\u5C31\u53EB\u505Acollection set \u7B80\u79F0Cset\uFF01</strong></p><p><strong>\u5728MIXGC\u4E2D\u7684Cset\u662F\u9009\u5B9A\u6240\u6709young gen\u91CC\u7684region\uFF0C\u5916\u52A0\u6839\u636Eglobal concurrent marking\u7EDF\u8BA1\u5F97\u51FA\u6536\u96C6\u6536\u76CA\u9AD8\u7684\u82E5\u5E72old gen region\u3002</strong></p><p><strong>\u5728YGC\u4E2D\u7684Cset\u662F\u9009\u5B9A\u6240\u6709young gen\u91CC\u7684region\u3002\u901A\u8FC7\u63A7\u5236young gen\u7684region\u4E2A\u6570\u6765\u63A7\u5236young GC\u7684\u5F00\u9500\u3002</strong></p><p><strong>YGC\u4E0EMIXGC\u90FD\u662F\u91C7\u7528\u591A\u7EBF\u7A0B\u590D\u5236\u6E05\u9664\uFF0C\u6574\u4E2A\u8FC7\u7A0B\u4F1ASTW\u3002 G1\u7684\u4F4E\u5EF6\u8FDF\u539F\u7406\u5728\u4E8E\u5176\u56DE\u6536\u7684\u533A\u57DF\u53D8\u5F97\u7CBE\u786E\u5E76\u4E14\u8303\u56F4\u53D8\u5C0F\u4E86\u3002</strong></p><h3 id="_6-3-stab-\u7EF4\u6301\u5E76\u53D1gc\u7684\u6B63\u786E\u6027" tabindex="-1"><a class="header-anchor" href="#_6-3-stab-\u7EF4\u6301\u5E76\u53D1gc\u7684\u6B63\u786E\u6027" aria-hidden="true">#</a> 6.3 STAB\uFF08\u7EF4\u6301\u5E76\u53D1GC\u7684\u6B63\u786E\u6027\uFF09</h3><p>\u4E0A\u9762global concurrent marking\u63D0\u5230\u4E86STAB\u7B97\u6CD5\uFF0C\u90A3\u8FD9\u4E2ASTAB\u5230\u5E95\u4E3A\u4F55\u7269\uFF1FSTAB\u5168\u79F0\u4E3Asnapshot-at-the-beginning\uFF0C\u5176\u76EE\u7684\u662F\u4E86\u7EF4\u6301\u5E76\u53D1GC\u7684\u6B63\u786E\u6027\u3002<strong>GC\u7684\u6B63\u786E\u6027\u662F\u4FDD\u8BC1\u5B58\u6D3B\u7684\u5BF9\u8C61\u4E0D\u88AB\u56DE\u6536\uFF0C\u6362\u53E5\u8BDD\u6765\u8BF4\u5C31\u662F\u4FDD\u8BC1\u56DE\u6536\u7684\u90FD\u662F\u5783\u573E</strong>\u3002\u5982\u679C\u6807\u8BB0\u8FC7\u7A0B\u662FSTW\u7684\u8BDD\uFF0C\u90A3GC\u7684\u6B63\u786E\u6027\u662F\u4E00\u5B9A\u80FD\u4FDD\u8BC1\u7684\u3002\u4F46\u5982\u679C\u4E00\u8FB9\u6807\u8BB0\uFF0C\u4E00\u8FB9\u5E94\u7528\u5728\u53D8\u66F4\u5806\u91CC\u9762\u5BF9\u8C61\u7684\u5F15\u7528\uFF0C\u90A3\u4E48\u6807\u8BB0\u7684\u6B63\u786E\u6027\u5C31\u4E0D\u4E00\u5B9A\u80FD\u4FDD\u8BC1\u4E86\u3002</p><p><strong>\u4E3A\u4E86\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\uFF0CSTAB\u7684\u505A\u6CD5\u5728GC\u5F00\u59CB\u65F6\u5BF9\u5185\u5B58\u8FDB\u884C\u4E00\u4E2A\u5BF9\u8C61\u56FE\u7684\u903B\u8F91\u5FEB\u7167(snapshot)\uFF0C\u901A\u8FC7GC Roots tracing \u53C2\u7167\u5E76\u53D1\u6807\u8BB0\u7684\u8FC7\u7A0B\uFF0C\u53EA\u8981\u88AB\u5FEB\u7167\u5230\u5BF9\u8C61\u662F\u6D3B\u7684\uFF0C\u90A3\u5728\u6574\u4E2AGC\u7684\u8FC7\u7A0B\u4E2D\u5BF9\u8C61\u5C31\u88AB\u8BA4\u5B9A\u7684\u662F\u6D3B\u7684\uFF0C\u5373\u4F7F\u8BE5\u5BF9\u8C61\u7684\u5F15\u7528\u7A0D\u540E\u88AB\u4FEE\u6539\u6216\u8005\u5220\u9664\u3002\u540C\u65F6\u65B0\u5206\u914D\u7684\u5BF9\u8C61\u4E5F\u4F1A\u88AB\u8BA4\u4E3A\u662F\u6D3B\u7684\uFF0C\u9664\u6B64\u4E4B\u5916\u5176\u5B83\u4E0D\u53EF\u8FBE\u7684\u5BF9\u8C61\u5C31\u88AB\u8BA4\u4E3A\u662F\u6B7B\u6389\u4E86\u3002\u8FD9\u6837STAB\u5C31\u4FDD\u8BC1\u4E86\u771F\u6B63\u5B58\u6D3B\u7684\u5BF9\u8C61\u4E0D\u4F1A\u88ABGC\u8BEF\u56DE\u6536\uFF0C\u4F46\u540C\u65F6\u4E5F\u9020\u6210\u4E86\u67D0\u4E9B\u53EF\u4EE5\u88AB\u56DE\u6536\u7684\u5BF9\u8C61\u9003\u8FC7\u4E86GC\uFF0C\u5BFC\u81F4\u4E86\u5185\u5B58\u91CC\u9762\u5B58\u5728\u6D6E\u52A8\u7684\u5783\u573E(float garbage)\u3002</strong></p><h3 id="_6-4-stab\u5177\u4F53\u7EC6\u8282" tabindex="-1"><a class="header-anchor" href="#_6-4-stab\u5177\u4F53\u7EC6\u8282" aria-hidden="true">#</a> 6.4 STAB\u5177\u4F53\u7EC6\u8282</h3><p>\u6BCF\u4E2ARegion\u4E2D\u90FD\u6709\u90A3\u4E48\u51E0\u4E2A\u6307\u9488</p><p><code>|&lt;-- (1) --&gt;|&lt;-- (2) --&gt;|&lt;-- (3) --&gt;|&lt;-- (4) --&gt;|</code> bottom prevTAMS nextTAMS top end</p><p>\u5176\u4E2Dtop\u662F\u8BE5region\u7684\u5F53\u524D\u5206\u914D\u6307\u9488\uFF0C[bottom, top)\u662F\u5F53\u524D\u8BE5region\u5DF2\u7528\uFF08used\uFF09\u7684\u90E8\u5206\uFF0C[top, end)\u662F\u5C1A\u672A\u4F7F\u7528\u7684\u53EF\u5206\u914D\u7A7A\u95F4\uFF08unused\uFF09\u3002</p><p>(1): [bottom, prevTAMS): \u8FD9\u90E8\u5206\u91CC\u7684\u5BF9\u8C61\u5B58\u6D3B\u4FE1\u606F\u53EF\u4EE5\u901A\u8FC7prevBitmap\u6765\u5F97\u77E5</p><p>(2): [prevTAMS, nextTAMS): \u8FD9\u90E8\u5206\u91CC\u7684\u5BF9\u8C61\u5728\u7B2Cn-1\u8F6Econcurrent marking\u662F\u9690\u5F0F\u5B58\u6D3B\u7684</p><p>(3): [nextTAMS, top): \u8FD9\u90E8\u5206\u91CC\u7684\u5BF9\u8C61\u5728\u7B2Cn\u8F6Econcurrent marking\u662F\u9690\u5F0F\u5B58\u6D3B\u7684</p><p>\u4E3A\u4EC0\u4E48\u4F1A\u7528prevTAMS\u548CnextTAMS\u4E24\u4E2A\u6307\u9488\uFF1F</p><p>\u56E0\u4E3AG1\u7684\u5E76\u53D1\u6807\u8BB0\u7684\u8FC7\u7A0B\u7528\u4E86\u4E24\u4E2Abitmap\uFF1A</p><p>\u4E00\u4E2AprevBitmap\u8BB0\u5F55\u7B2Cn-1\u8F6Econcurrent mark\u6240\u5F97\u7684\u5BF9\u8C61\u5B58\u6D3B\u72B6\u6001\u3002\u7531\u4E8E\u7B2Cn\uFF0D1\u8F6Econcurrent marking\u5DF2\u7ECF\u5B8C\u6210\uFF0C\u8FD9\u4E2Abitmap\u7684\u4FE1\u606F\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528\u3002</p><p>\u4E00\u4E2AnextBitmap\u8BB0\u5F55\u7B2Cn\u8F6Econcurrent mark\u7684\u7ED3\u679C\u3002\u8FD9\u4E2Abitmap\u662F\u5F53\u524D\u5C06\u8981\u6216\u6B63\u5728\u8FDB\u884C\u7684concurrent mark\u7684\u7ED3\u679C\uFF0C\u5C1A\u672A\u5B8C\u6210\uFF0C\u6240\u4EE5\u8FD8\u4E0D\u80FD\u4F7F\u7528\u3002</p><p>\u6240\u4EE5Region\u4F1A\u540C\u65F6\u5B58\u5728prevTAMS\u548CnextTAMS\u4E24\u4E2A\u6307\u9488\uFF0C\u8FD9\u4E24\u4E2A\u6307\u9488\u662F\u5728 Initial Mark\u9636\u6BB5\u5C31\u4F1A\u8BBE\u7F6E\u597D\u3002</p><p>\u6240\u4EE5\u6211\u4EEC\u5F88\u5BB9\u6613\u77E5\u9053\u54EA\u4E9B\u5BF9\u8C61\u5728\u4E00\u6B21GC\u5F00\u59CB\u4E4B\u540E\u65B0\u5206\u914D\u7684\uFF1A\u5728TAMS\u4EE5\u4E0A\u7684\u5BF9\u8C61\u5C31\u662F\u65B0\u5206\u914D\u7684\uFF0C\u56E0\u800C\u88AB\u89C6\u4E3A\u9690\u5F0Fmarked\uFF0C\u6807\u8BB0\u4E3A\u5B58\u6D3B\u3002</p><p>\u5207\u6362\u5230\u53E6\u5916\u4E00\u4E2A\u573A\u666F\uFF1A\u5982\u679C\u5728\u6807\u8BB0\u7684\u8FC7\u7A0B\u4E2Dmark\u4E86\u67D0\u4E2A\u5BF9\u8C61\u4F46\u5BF9\u8C61\u4E2D\u67D0\u4E9B\u5F15\u7528\u8FD9\u5B57\u6BB5\u8FD8\u6CA1\u6709\u88ABmark\u5230,\u6B64\u65F6\u5E94\u7528\u5E76\u53D1\u4FEE\u6539\u5F15\u7528\u5B57\u6BB5\u7684\u503C\uFF0C\u90A3collecotr\u5C31\u62FF\u4E0D\u5230\u5B8C\u6574\u7684\u5FEB\u7167\u4E86\uFF0C\u8FD9\u4E0D\u7B26\u5408STAB\u7684\u8BBE\u60F3\u3002</p><p>\u4E3A\u4E86\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\u5C31\u6709\u4E86SATB write barrier\u3002G1 GC\u5177\u4F53\u4F7F\u7528\u7684\u662FYuasa\u5F0F\u7684SATB write barrier\u7684\u53D8\u79CD\u3002\u5B83\u7684\u76F8\u5173\u8BBA\u6587\u662F\uFF1A</p>`,94),u={href:"https://link.zhihu.com/?target=http%3A//dl.acm.org/citation.cfm%3Fid%3D82237",target:"_blank",rel:"noopener noreferrer"},d=t(`<p>Write barrier\u662F\u5BF9\u201C\u5BF9\u5F15\u7528\u7C7B\u578B\u5B57\u6BB5\u8D4B\u503C\u201D\u8FD9\u4E2A\u52A8\u4F5C\u7684\u73AF\u5207\uFF0C\u4E5F\u5C31\u662F\u8BF4\u8D4B\u503C\u7684\u524D\u540E\u90FD\u5728barrier\u8986\u76D6\u7684\u8303\u7574\u5185\u3002\u5728\u8D4B\u503C\u524D\u7684\u90E8\u5206\u7684write barrier\u53EB\u505Apre-write barrier\uFF0C\u5728\u8D4B\u503C\u540E\u7684\u5219\u53EB\u505Apost-write barrier\u3002</p><p>\u5728HotSpot VM\u91CC\uFF0C\u5728\u5F15\u5165G1 GC\u4E4B\u524D\uFF0C\u5176\u5B83GC\u90FD\u53EA\u7528\u4E86post-write barrier\uFF0C\u6240\u4EE5\u5B83\u5728\u6E90\u7801\u91CC\u6CA1\u6709\u7279\u522B\u7684\u524D\u540E\u7F00\uFF1B\u800CG1 GC\u7279\u6709\u7684pre-write barrier\u5219\u5728\u6E90\u7801\u91CC\u6709_pre\u7684\u540E\u7F00\uFF0C\u53EF\u4EE5\u7559\u610F\u4E00\u4E0B\u3002</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">oop_field_store</span><span class="token punctuation">(</span>oop<span class="token operator">*</span> field<span class="token punctuation">,</span> oop value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pre_write_barrier</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>field <span class="token operator">=</span> value<span class="token punctuation">;</span> <span class="token comment">// the actual store</span>
  <span class="token function">post_write_barrier</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-1-pre-post-write-barrier\u4E0Esatb\u7684\u5173\u7CFB" tabindex="-1"><a class="header-anchor" href="#_6-4-1-pre-post-write-barrier\u4E0Esatb\u7684\u5173\u7CFB" aria-hidden="true">#</a> 6.4.1 Pre/Post-write barrier\u4E0ESATB\u7684\u5173\u7CFB</h4><p>\u524D\u9762\u63D0\u5230SATB\u8981\u7EF4\u6301\u201C\u5728GC\u5F00\u59CB\u65F6\u6D3B\u7684\u5BF9\u8C61\u201D\u7684\u72B6\u6001\u8FD9\u4E2A\u903B\u8F91snapshot\u3002\u9664\u4E86\u4ECEroot\u51FA\u53D1\u628A\u6574\u4E2A\u5BF9\u8C61\u56FEmark\u4E0B\u6765\u4E4B\u5916\uFF0C\u5176\u5B9E\u53EA\u9700\u8981\u7528pre-write barrier\u628A\u6BCF\u6B21\u5F15\u7528\u5173\u7CFB\u53D8\u5316\u65F6\u65E7\u7684\u5F15\u7528\u503C\u8BB0\u4E0B\u6765\u5C31\u597D\u4E86\u3002\u8FD9\u6837\uFF0C\u7B49concurrent marker\u5230\u8FBE\u67D0\u4E2A\u5BF9\u8C61\u65F6\uFF0C\u8FD9\u4E2A\u5BF9\u8C61\u7684\u6240\u6709\u5F15\u7528\u7C7B\u578B\u5B57\u6BB5\u7684\u53D8\u5316\u5168\u90FD\u6709\u8BB0\u5F55\u5728\u6848\uFF0C\u5C31\u4E0D\u4F1A\u6F0F\u6389\u4EFB\u4F55\u5728snapshot\u91CC\u6D3B\u7684\u5BF9\u8C61\u3002\u5F53\u7136\uFF0C\u5F88\u53EF\u80FD\u6709\u5BF9\u8C61\u5728snapshot\u4E2D\u662F\u6D3B\u7684\uFF0C\u4F46\u968F\u7740\u5E76\u53D1GC\u7684\u8FDB\u884C\u5B83\u53EF\u80FD\u672C\u6765\u5DF2\u7ECF\u6B7B\u4E86\uFF0C\u4F46SATB\u8FD8\u662F\u4F1A\u8BA9\u5B83\u6D3B\u8FC7\u8FD9\u6B21GC\u3002</p><p>\u6240\u4EE5\u5728G1 GC\u91CC\uFF0C\u6574\u4E2Awrite barrier+oop_field_store\u662F\u8FD9\u6837\u7684\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">oop_field_store</span><span class="token punctuation">(</span>oop<span class="token operator">*</span> field<span class="token punctuation">,</span> oop new_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pre_write_barrier</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// pre-write barrier: for maintaining SATB invariant</span>
  <span class="token operator">*</span>field <span class="token operator">=</span> new_value<span class="token punctuation">;</span>                   <span class="token comment">// the actual store</span>
  <span class="token function">post_write_barrier</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> new_value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// post-write barrier: for tracking cross-region reference</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6309\u7167Yuasa\u5F0FSATB barrier\u7684\u8BBE\u8BA1\uFF0Cpre-write barrier\u91CC\u9762\u7684\u62BD\u8C61\u903B\u8F91\u5E94\u5F53\u5982\u4E0B\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">pre_write_barrier</span><span class="token punctuation">(</span>oop<span class="token operator">*</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$gc_phase <span class="token operator">==</span> GC_CONCURRENT_MARK<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// SATB invariant only maintained during concurrent marking</span>
    oop old_value <span class="token operator">=</span> <span class="token operator">*</span>field<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>old_value <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_marked</span><span class="token punctuation">(</span>old_value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mark_object</span><span class="token punctuation">(</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $mark_stack<span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scan all of old_value&#39;s fields later</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6BD4\u539F\u672C\u7684Yuasa\u5F0F\u8BBE\u8BA1\u5C11\u4E86\u4E9B\u4E1C\u897F\uFF1A\u6CA1\u6709\u68C0\u67E5\u76EE\u6807\u5BF9\u8C61\u662F\u5426\u5DF2\u7ECFmark\uFF0C\u4E5F\u4E0D\u53BB\u5BF9\u76EE\u6807\u5BF9\u8C61\u505Amark\u548C\u626B\u63CF\u5B83\u7684\u5B57\u6BB5\u3002\u5B9E\u9645\u4E0A\u8BE5\u505A\u7684\u4E8B\u60C5\u8FD8\u662F\u5F97\u505A\uFF0C\u53EA\u662F\u4E0D\u5728\u8FD9\u91CC\u505A\u800C\u5DF2\u3002\u90A3\u653E\u5728\u90A3\u91CC\u505A\u5462\u653E\u5230\u4E86\u540E\u9762\u7684logging barrier\uFF0C\u8FD9\u4E2A\u540E\u9762\u8BB2\u5230\u3002</p><p>Pre-write barrier\u7684\u5B9E\u9645\u4EE3\u7801\u6709\u597D\u51E0\u4E2A\u7248\u672C\uFF0C\u5176\u4E2D\u6700\u7B80\u5355\u660E\u767D\u7684\u7248\u672C\u662F\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token comment">// This notes that we don&#39;t need to access any BarrierSet data</span>
  <span class="token comment">// structures, so this can be called from a static context.</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_ref_field_pre_static</span><span class="token punctuation">(</span>T<span class="token operator">*</span> field<span class="token punctuation">,</span> oop newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    T heap_oop <span class="token operator">=</span> oopDesc<span class="token double-colon punctuation">::</span><span class="token function">load_heap_oop</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oopDesc<span class="token double-colon punctuation">::</span><span class="token function">is_null</span><span class="token punctuation">(</span>heap_oop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">enqueue</span><span class="token punctuation">(</span>oopDesc<span class="token double-colon punctuation">::</span><span class="token function">decode_heap_oop</span><span class="token punctuation">(</span>heap_oop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>enqueue\u52A8\u4F5C\u7684\u5B9E\u9645\u4EE3\u7801\u5219\u5728G1SATBCardTableModRefBS::enqueue(oop pre_val)\u3002</p><p>\u5B83\u5224\u65AD\u5F53\u524D\u662F\u5426\u5728concurrent marking phase\u7528\u7684\u662F\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token class-name">JavaThread</span><span class="token double-colon punctuation">::</span><span class="token function">satb_mark_queue_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_6-4-2-logging-write-barrier" tabindex="-1"><a class="header-anchor" href="#_6-4-2-logging-write-barrier" aria-hidden="true">#</a> 6.4.2 logging write barrier</h4><p>\u4E3A\u4E86\u5C3D\u91CF\u51CF\u5C11write barrier\u5BF9\u5E94\u7528mutator\u6027\u80FD\u7684\u5F71\u54CD\uFF0CG1\u5C06\u4E00\u90E8\u5206\u539F\u672C\u8981\u5728barrier\u91CC\u505A\u7684\u4E8B\u60C5\u632A\u5230\u522B\u7684\u7EBF\u7A0B\u4E0A\u5E76\u53D1\u6267\u884C\u3002 \u5B9E\u73B0\u8FD9\u79CD\u5206\u79BB\u7684\u65B9\u5F0F\u5C31\u662F\u901A\u8FC7logging\u5F62\u5F0F\u7684write barrier\uFF1Amutator\u53EA\u5728barrier\u91CC\u628A\u8981\u505A\u7684\u4E8B\u60C5\u7684\u4FE1\u606F\u8BB0\uFF08log\uFF09\u5230\u4E00\u4E2A\u961F\u5217\u91CC\uFF0C\u7136\u540E\u53E6\u5916\u7684\u7EBF\u7A0B\u4ECE\u961F\u5217\u91CC\u53D6\u51FA\u4FE1\u606F\u6279\u91CF\u5B8C\u6210\u5269\u4F59\u7684\u52A8\u4F5C\u3002</p><p>\u4EE5SATB write barrier\u4E3A\u4F8B\uFF0C\u6BCF\u4E2AJava\u7EBF\u7A0B\u6709\u4E00\u4E2A\u72EC\u7ACB\u7684\u3001\u5B9A\u957F\u7684SATBMarkQueue\uFF0Cmutator\u5728barrier\u91CC\u53EA\u628Aold_value\u538B\u5165\u8BE5\u961F\u5217\u4E2D\u3002\u4E00\u4E2A\u961F\u5217\u6EE1\u4E86\u4E4B\u540E\uFF0C\u5B83\u5C31\u4F1A\u88AB\u52A0\u5230\u5168\u5C40\u7684SATB\u961F\u5217\u96C6\u5408SATBMarkQueueSet\u91CC\u7B49\u5F85\u5904\u7406\uFF0C\u7136\u540E\u7ED9\u5BF9\u5E94\u7684Java\u7EBF\u7A0B\u6362\u4E00\u4E2A\u65B0\u7684\u3001\u5E72\u51C0\u7684\u961F\u5217\u7EE7\u7EED\u6267\u884C\u4E0B\u53BB\u3002</p><p>\u5E76\u53D1\u6807\u8BB0\uFF08concurrent marker\uFF09\u4F1A\u5B9A\u671F\u68C0\u67E5\u5168\u5C40SATB\u961F\u5217\u96C6\u5408\u7684\u5927\u5C0F\u3002\u5F53\u5168\u5C40\u96C6\u5408\u4E2D\u961F\u5217\u6570\u91CF\u8D85\u8FC7\u4E00\u5B9A\u9608\u503C\u540E\uFF0Cconcurrent marker\u5C31\u4F1A\u5904\u7406\u96C6\u5408\u91CC\u7684\u6240\u6709\u961F\u5217\uFF1A\u628A\u961F\u5217\u91CC\u8BB0\u5F55\u7684\u6BCF\u4E2Aoop\u90FD\u6807\u8BB0\u4E0A\uFF0C\u5E76\u5C06\u5176\u5F15\u7528\u5B57\u6BB5\u538B\u5230\u6807\u8BB0\u6808\uFF08marking stack\uFF09\u4E0A\u7B49\u540E\u9762\u505A\u8FDB\u4E00\u6B65\u6807\u8BB0\u3002</p><p>\u6240\u4EE5\u6574\u4E2ASTAB\u8FC7\u7A0B\u8BB2\u5B8C\u3002</p><h2 id="_7-g1\u547D\u4EE4\u884C\u9009\u9879\u4E0E\u6700\u4F73\u5B9E\u8DF5" tabindex="-1"><a class="header-anchor" href="#_7-g1\u547D\u4EE4\u884C\u9009\u9879\u4E0E\u6700\u4F73\u5B9E\u8DF5" aria-hidden="true">#</a> 7. G1\u547D\u4EE4\u884C\u9009\u9879\u4E0E\u6700\u4F73\u5B9E\u8DF5</h2><h3 id="_7-1-\u547D\u4EE4\u884C\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#_7-1-\u547D\u4EE4\u884C\u9009\u9879" aria-hidden="true">#</a> 7.1 \u547D\u4EE4\u884C\u9009\u9879</h3><ul><li><p><strong><code>-XX:+UseG1GC</code></strong> \u544A\u8BC9JVM\u4F7F\u7528G1\u6536\u96C6\u5668</p></li><li><p><strong>-XX:MaxGCPauseMillis=200</strong> \u8BBE\u7F6E\u6700\u5927GC\u76EE\u6807\u6700\u5927\u505C\u987F\u65F6\u95F4\u4E3A200ms\uFF0C\u8FD9\u662F\u4E00\u4E2A\u8F6F\u6307\u6807\u3002JVM\u4F1A\u6700\u5927\u52AA\u529B\u53BB\u8FBE\u5230\u5B83\uFF0C\u56E0\u6B64\u6709\u65F6\u505C\u987F\u65F6\u95F4\u4F1A\u8FBE\u4E0D\u5230\u8BBE\u7F6E\u76EE\u6807\u3002G1\u914D\u7F6E\u662F200ms</p></li><li><p><strong>-XX:InitiatingHeapOccupancyPercent=45</strong> \u542F\u52A8\u5E76\u53D1\u6807\u8BB0\u6807\u8BB0\u767E\u5206\u6BD4\uFF0C\u5F53\u6574\u5806\u5185\u5B58\u4F7F\u7528\u91CF\u8FBE\u5230\u767E\u5206\u6BD4\u65F6\uFF0CG1\u4F7F\u7528\u5B83\u6765\u89E6\u53D1\u4E00\u4E2A\u57FA\u4E8E\u6574\u4E2A\u5806\u7684\u5E76\u53D1\u6807\u8BB0\u5FAA\u73AF\uFF0C\u800C\u4E0D\u4EC5\u4EC5\u662F\u4E00\u4E2A\u4EE3\u3002\u9ED8\u5FF5\u503C\u662F45%</p></li></ul><h3 id="_7-2-\u6700\u4F73\u5B9E\u8DF5" tabindex="-1"><a class="header-anchor" href="#_7-2-\u6700\u4F73\u5B9E\u8DF5" aria-hidden="true">#</a> 7.2 \u6700\u4F73\u5B9E\u8DF5</h3><p>\u4E0B\u9762\u6709\u51E0\u4E2A\u5173\u4E8E\u4F7F\u7528G1\u7684\u6700\u4F73\u5B9E\u8DF5</p><h4 id="_7-2-1-\u4E0D\u8981\u8BBE\u7F6Eyoung-generation\u5927\u5C0F" tabindex="-1"><a class="header-anchor" href="#_7-2-1-\u4E0D\u8981\u8BBE\u7F6Eyoung-generation\u5927\u5C0F" aria-hidden="true">#</a> 7.2.1 <strong>\u4E0D\u8981\u8BBE\u7F6EYoung Generation\u5927\u5C0F</strong></h4><p>\u56E0\u4E3A\u663E\u5F0F\u901A\u8FC7-Xmn\u8BBE\u7F6Eyoung generation\u5927\u5C0F\u5C06\u4F1A\u5E72\u9884G1\u6536\u96C6\u5668\u7684\u9ED8\u8BA4\u884C\u4E3A</p><ul><li>G1\u5C06\u4E0D\u518D\u5C0A\u91CD\u8BBE\u5B9A\u7684pause time,\u672C\u8D28\u6765\u8BF4\u662F\u56E0\u4E3A\u8BBE\u7F6Eyoung generation\u5927\u5C0F\u4F7F\u5F97\u8BBE\u5B9A\u7684pause time\u76EE\u6807\u5931\u6548\u3002</li><li>G1\u4E0D\u518D\u80FD\u591F\u6839\u636E\u9700\u8981\u6269\u5C55\u548C\u6536\u7F29young generation\u7684\u7A7A\u95F4\u3002\u7531\u4E8E\u5927\u5C0F\u662F\u56FA\u5B9A\u7684\uFF0C\u6240\u4EE5\u4E0D\u80FD\u66F4\u6539\u5927\u5C0F\u3002</li></ul><h4 id="_7-2-2-\u54CD\u5E94\u65F6\u95F4\u6307\u6807" tabindex="-1"><a class="header-anchor" href="#_7-2-2-\u54CD\u5E94\u65F6\u95F4\u6307\u6807" aria-hidden="true">#</a> 7.2.2 <strong>\u54CD\u5E94\u65F6\u95F4\u6307\u6807</strong></h4><p>\u4E0D\u8981\u4F7F\u7528\u5E73\u5747\u54CD\u5E94\u65F6\u95F4(ART)\u4F5C\u4E3A\u6307\u6807\u6765\u8BBE\u7F6E<code>XX:MaxGCPauseMillis=&lt;N&gt;</code>\uFF0C\u800C\u8981\u8003\u8651\u8BBE\u7F6E90%\u4EE5\u4E0A\u65F6\u95F4\u90FD\u80FD\u8FBE\u5230\u76EE\u6807\u7684\u503C\u3002\u8FD9\u610F\u5473\u774090%\u53D1\u51FA\u8BF7\u6C42\u7684\u7528\u6237\u4E0D\u4F1A\u7ECF\u5386\u9AD8\u4E8E\u76EE\u6807\u7684\u54CD\u5E94\u65F6\u95F4\u3002\u8BB0\u4F4F\uFF0C\u6682\u505C\u65F6\u95F4\u662F\u4E00\u4E2A\u76EE\u6807\uFF0C\u5E76\u4E0D\u80FD\u4FDD\u8BC1\u603B\u80FD\u8FBE\u5230\u3002</p><h4 id="_7-2-3-\u4EC0\u4E48\u662Fevacuation-failure" tabindex="-1"><a class="header-anchor" href="#_7-2-3-\u4EC0\u4E48\u662Fevacuation-failure" aria-hidden="true">#</a> 7.2.3 <strong>\u4EC0\u4E48\u662FEvacuation Failure</strong></h4><p>\u5F53JVM\u5728GC\u671F\u95F4\u590D\u5236\u5BF9\u8C61\u5230Survior\u533A\u6216\u6216\u8005\u63D0\u5347\u5BF9\u8C61\u65F6\uFF0C\u5806\u7A7A\u95F4\u88AB\u8017\u5C3D\uFF0C\u5806\u533A\u57DF\u5347\u7EA7\u5931\u8D25\u3002\u5806\u65E0\u6CD5\u6269\u5C55\uFF0C\u56E0\u4E3A\u5B83\u5DF2\u7ECF\u5904\u4E8E\u6700\u5927\u503C\u3002\u8FD9\u79CD\u60C5\u51B5\u5728-XX:+PrintGCDetails\u5C06\u4F1A\u4EE5TO\u7A7A\u95F4\u6EA2\u51FA**(<code>to-space overflow</code>)**\u7684\u5F62\u5F0F\u8868\u793A\u3002\u4EE3\u4EF7\u662F\u5341\u5206\u6602\u8D35\u7684\uFF0C\u56E0\u4E3A</p><ul><li>GC\u4ECD\u7136\u9700\u8981\u7EE7\u7EED\uFF0C\u6240\u4EE5\u5FC5\u987B\u91CA\u653E\u7A7A\u95F4</li><li>\u672A\u6210\u529F\u590D\u5236\u7684\u5BF9\u8C61\u5FC5\u987B\u5728\u9002\u5F53\u7684\u4F4D\u7F6E\u4FDD\u7559</li><li>\u5BF9CSet\u4E2D\u533A\u57DF\u7684rset\u7684\u4EFB\u4F55\u66F4\u65B0\u90FD\u5FC5\u987B\u91CD\u65B0\u751F\u6210</li><li>\u6240\u6709\u8FD9\u4E9B\u6B65\u9AA4\u90FD\u5F88\u6602\u8D35\u3002</li></ul><h4 id="_7-2-4-\u5982\u4F55\u907F\u514Devacuation-failure" tabindex="-1"><a class="header-anchor" href="#_7-2-4-\u5982\u4F55\u907F\u514Devacuation-failure" aria-hidden="true">#</a> 7.2.4 <strong>\u5982\u4F55\u907F\u514DEvacuation Failure</strong></h4><p>\u4E3A\u4E86\u907F\u514DEvacuation Failure\uFF0C\u8003\u8651\u4EE5\u4E0B\u9009\u9879\u3002</p><ul><li><p>\u589E\u5927\u5806\uFF08\u5185\u5B58)\u5927\u5C0F</p></li><li><ul><li>\u589E\u5927**<code>-XX:G1ReservePercent=n</code>**\uFF0C\u9ED8\u8BA4\u662F10</li><li>G1\u4F1A\u9884\u7559\u4E00\u90E8\u5206\u5185\u5B58\uFF0C\u5236\u9020\u4E00\u4E2A\u5047\u5929\u82B1\u677F\uFF0C\u5F53\u771F\u6B63Evacuation Failure\u65F6\u8FD8\u6709\u5185\u5B58\u53EF\u7528\u3002</li></ul></li><li><p>\u65E9\u70B9\u542F\u52A8\u6807\u8BB0\u5468\u671F</p></li><li><p>\u589E\u5927\u5E76\u884C\u6807\u8BB0\u7684\u7EBF\u7A0B\u6570\uFF0C\u4F7F\u7528**<code>-XX:ConcGCThreads=n</code>**\u9009\u9879\u3002</p></li></ul><h3 id="_7-3-\u5B8C\u6574\u7684g1-gc\u5F00\u5173\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#_7-3-\u5B8C\u6574\u7684g1-gc\u5F00\u5173\u5217\u8868" aria-hidden="true">#</a> 7.3 \u5B8C\u6574\u7684G1 GC\u5F00\u5173\u5217\u8868</h3><ul><li>-XX:+UseG1GC \u4F7F\u7528G1 GC\u3002</li><li>-XX:MaxGCPauseMillis=n \u8BBE\u7F6E\u6700\u5927GC\u505C\u987F\u65F6\u95F4\uFF0C\u8FD9\u662F\u4E00\u4E2A\u8F6F\u76EE\u6807\uFF0CJVM\u4F1A\u5C3D\u6700\u5927\u52AA\u529B\u53BB\u8FBE\u5230\u5B83\u3002</li><li>-XX:InitiatingHeapOccupancyPercent=n \u542F\u52A8\u5E76\u53D1\u6807\u8BB0\u5FAA\u73AF\u7684\u5806\u5360\u7528\u7387\u7684\u767E\u5206\u6BD4\uFF0C\u5F53\u6574\u4E2A\u5806\u7684\u5360\u7528\u8FBE\u5230\u6BD4\u4F8B\u65F6\uFF0C\u542F\u52A8\u4E00\u4E2A\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u5FAA\u73AF\uFF0C0\u4EE3\u8868\u5E76\u53D1\u6807\u8BB0\u4E00\u76F4\u8FD0\u884C\u3002\u9ED8\u8BA4\u503C\u662F45%\u3002</li><li>-XX:NewRatio=n \u65B0\u751F\u4EE3\u548C\u8001\u5E74\u4EE3\u5927\u5C0F\u7684\u6BD4\u4F8B\uFF0C\u9ED8\u8BA4\u662F2\u3002</li><li>-XX:SurvivorRatio=n eden\u548Csurvivor\u533A\u57DF\u7A7A\u95F4\u5927\u5C0F\u7684\u6BD4\u4F8B\uFF0C\u9ED8\u8BA4\u662F8\u3002</li><li>-XX:MaxTenuringThreshold=n \u664B\u5347\u7684\u9608\u503C\uFF0C\u9ED8\u8BA4\u662F15\uFF08\u4E00\u4E2A\u5B58\u6D3B\u5BF9\u8C61\u7ECF\u5386\u591A\u5C11\u6B21GC\u5468\u671F\u4E4B\u540E\u664B\u5347\u5230\u8001\u5E74\u4EE3)\u3002</li><li>-XX:ParallelGCThreads=n \u8BBE\u7F6EGC\u5E76\u53D1\u9636\u6BB5\u7684\u7EBF\u7A0B\u6570\uFF0C\u9ED8\u8BA4\u503C\u4E0EJVM\u8FD0\u884C\u5E73\u53F0\u76F8\u5173\u3002</li><li>-XX:ConcGCThreads=n \u8BBE\u7F6E\u5E76\u53D1\u6807\u8BB0\u7684\u7EBF\u7A0B\u6570\uFF0C\u9ED8\u8BA4\u503C\u4E0EJVM\u8FD0\u884C\u5E73\u53F0\u76F8\u5173\u3002</li><li>-XX:G1ReservePercent=n \u8BBE\u7F6E\u4FDD\u7559java\u5806\u5927\u5C0F\u6BD4\u4F8B\uFF0C\u7528\u4E8E\u9632\u6B62\u664B\u5347\u5931\u8D25/Evacuation Failure,\u9ED8\u8BA4\u503C\u662F10%\u3002</li><li>-XX:G1HeapRegionSize=n \u8BBE\u7F6ERegion\u7684\u5927\u5C0F\uFF0C\u9ED8\u8BA4\u662F\u6839\u636E\u5806\u7684\u5927\u5C0F\u52A8\u6001\u51B3\u5B9A\uFF0C\u5927\u5C0F\u8303\u56F4\u662F[1M,32M]</li></ul><h2 id="_8-\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_8-\u603B\u7ED3" aria-hidden="true">#</a> 8. \u603B\u7ED3</h2><ul><li>G1\u628A\u5185\u5B58\u5206\u6210\u4E00\u5757\u5757\u7684Region\uFF0C\u6BCF\u5757\u7684Region\u7684\u5927\u5C0F\u90FD\u662F\u4E00\u6837\u7684\u3002</li><li>G1\u4FDD\u7559\u4E86YGC\u5E76\u52A0\u4E0A\u4E86\u4E00\u79CD\u5168\u65B0\u7684MIXGC\u7528\u4E8E\u6536\u96C6\u8001\u5E74\u4EE3\u3002G1\u4E2D\u6CA1\u6709Full GC\uFF0CG1\u4E2D\u7684Full GC\u662F\u91C7\u7528serial old Full GC\u3002\u5728MIXGC\u4E2D\u7684Cset\u662F\u9009\u5B9A\u6240\u6709young gen\u91CC\u7684region\uFF0C\u5916\u52A0\u6839\u636Eglobal concurrent marking\u7EDF\u8BA1\u5F97\u51FA\u6536\u96C6\u6536\u76CA\u9AD8\u7684\u82E5\u5E72old gen region\u3002\u5728YGC\u4E2D\u7684Cset\u662F\u9009\u5B9A\u6240\u6709young gen\u91CC\u7684region\u3002\u901A\u8FC7\u63A7\u5236young gen\u7684region\u4E2A\u6570\u6765\u63A7\u5236young GC\u7684\u5F00\u9500\u3002YGC\u4E0EMIXGC\u90FD\u662F\u91C7\u7528\u591A\u7EBF\u7A0B\u590D\u5236\u6E05\u9664\uFF0C\u6574\u4E2A\u8FC7\u7A0B\u4F1ASTW\u3002</li><li>G1\u7684\u4F4E\u5EF6\u8FDF\u539F\u7406\u5728\u4E8E\u5176\u56DE\u6536\u7684\u533A\u57DF\u53D8\u5F97\u7CBE\u786E\u5E76\u4E14\u8303\u56F4\u53D8\u5C0F\u4E86\u3002</li><li>\u5168\u5C40\u5E76\u53D1\u6807\u8BB0\u5206\u7684\u4E94\u4E2A\u9636\u6BB5\u3002</li><li>\u7528STAB\u6765\u7EF4\u6301\u5E76\u53D1GC\u7684\u51C6\u786E\u6027\u3002</li><li>\u4F7F\u7528G1\u7684\u6700\u4F73\u5B9E\u8DF5</li><li>G1 GC\u65E5\u5FD7\u6253\u5370</li></ul><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>`,41),g={href:"https://zhuanlan.zhihu.com/p/52841787",target:"_blank",rel:"noopener noreferrer"};function h(k,m){const a=r("ExternalLinkIcon");return i(),p("div",null,[c,n("ul",null,[n("li",null,[n("a",u,[e("Real-time garbage collection on general-purpose"),s(a)])])]),d,n("p",null,[n("a",g,[e("G1 \u6536\u96C6\u5668\u539F\u7406\u7406\u89E3\u4E0E\u5206\u6790"),s(a)])])])}const G=o(l,[["render",h],["__file","java-jvm-gc-g1-supplement.html.vue"]]);export{G as default};
