import{_ as n}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as s,c as a,f as e}from"./app.669b4984.js";const t={},o=e(`<blockquote><p>\u6D45\u8C08hyperledger fabric\u6E90\u7801|Order\u8282\u70B9\u542F\u52A8</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmytqt8ef1g30zk0m7dn6.gif" alt="207f698ab0d8c69266fb6fe4c8f85def"></p><h2 id="orderer\u8282\u70B9\u542F\u52A8\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#orderer\u8282\u70B9\u542F\u52A8\u6D41\u7A0B" aria-hidden="true">#</a> Orderer\u8282\u70B9\u542F\u52A8\u6D41\u7A0B</h2><p>\u8282\u70B9\u542F\u52A8\u5F00\u59CB\u5728<code>/orderer/common/server/main.go</code>:</p><div class="language-GO ext-GO line-numbers-mode"><pre class="language-GO"><code>func Main() {
	fullCmd := kingpin.MustParse(app.Parse(os.Args[1:]))  // \u89E3\u6790\u7528\u6237\u547D\u4EE4\u884C
	...
	conf, err := config.Load() //  \u52A0\u8F7Dorderer.yaml\u914D\u7F6E\u6587\u4EF6
	...
	initializeLoggingLevel(conf) //\u521D\u59CB\u5316\u65E5\u5FD7\u7EA7\u522B
	initializeLocalMsp(conf) //\u521D\u59CB\u5316\u672C\u5730MSP\u7EC4\u4EF6

	prettyPrintStruct(conf) // \u6253\u5370\u914D\u7F6E\u4FE1\u606F
	Start(fullCmd, conf) // \u542F\u52A8Orderer\u6392\u5E8F\u670D\u52A1\u5668
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3B\u8981\u505A\u4E86\u4EE5\u4E0B\u51E0\u4EF6\u4E8B\uFF1A</p><ul><li>\u89E3\u6790\u7528\u6237\u547D\u4EE4\u884C</li><li>\u52A0\u8F7Dorderer.yaml\u914D\u7F6E\u6587\u4EF6</li><li>\u521D\u59CB\u5316\u65E5\u5FD7\u7EA7\u522B</li><li>\u521D\u59CB\u5316\u672C\u5730MSP\u7EC4\u4EF6</li><li>\u6253\u5370\u914D\u7F6E\u4FE1\u606F</li><li>\u542F\u52A8Orderer\u6392\u5E8F\u670D\u52A1\u5668</li></ul><p>\u63A5\u4E0B\u6765\u5C06\u4F1A\u5C55\u5F00\u7684\u53BB\u8BB2\u4E0A\u9762\u6BD4\u8F83\u91CD\u8981\u7684\u4E00\u4E9B\u5185\u5BB9\u3002</p><h2 id="\u52A0\u8F7Dorderer-yaml\u914D\u7F6E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u52A0\u8F7Dorderer-yaml\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a> \u52A0\u8F7Dorderer.yaml\u914D\u7F6E\u6587\u4EF6</h2><p>\u662F\u7531<code>config.Load()</code>\u5F00\u542F\u7684\uFF0C\u8FDB\u5165\u5230<code>/orderer/common/localconfig/config.go/Load()</code></p><p>\u2460\uFF1A\u521D\u59CB\u5316viper</p><p>\u8C03\u7528<code>InitViper()</code>\u51FD\u6570\u8BBE\u7F6E\u914D\u7F6E\u6587\u4EF6\u8DEF\u5F84\uFF0C\u5E76\u9ED8\u8BA4\u5728<code>$FABRIC_CFG_PATH</code>\uFF08\u5982<code>/etc/hyperledger/fabric</code>\uFF09\u8DEF\u5F84\u4E0B\u67E5\u627E\u914D\u7F6E\u6587\u4EF6\uFF0C\u627E\u4E0D\u5230\u6587\u4EF6\u65F6\u518D\u4F9D\u6B21\u67E5\u627E\u5F53\u524D\u76EE\u5F55\u3001\u9ED8\u8BA4\u5F00\u53D1\u914D\u7F6E\u76EE\u5F55 \uFF08<code>$GOPATH/src/github.com/hyperledger/fabric/sampleconfig</code>\uFF09\u548C\u7CFB\u7EDF\u9ED8\u8BA4\u914D\u7F6E\u8DEF\u5F84 \uFF08<code>/etc/hyperledger/fabric</code>\uFF09\u3002\u63A5\u7740\u5F00\u542F\u5339\u914D\u7CFB\u7EDF\u73AF\u5883\u53D8\u91CF\u7684\u6A21\u5F0F\uFF0C\u5373\u4E3AViper\u7EC4\u4EF6\u914D\u7F6E\u9879\uFF08\u4EE5.\u5206\u5272\u7684\u683C\u5F0F\uFF09\u6DFB\u52A0\u6307\u5B9A\u524D\u7F00\u201CORDERER_\u201D\uFF0C\u8F6C\u6362\u4E3A\u5927\u5199\u5B57\u6BCD\u5F62\u5F0F\uFF0C\u518D\u5C06\u201C.\u201D\u66FF\u6362\u4E3A<code>_</code>\u3002\u8FD9\u6837\uFF0CViper\u7EC4\u4EF6\u5C31\u80FD\u5728\u67E5\u627E\u914D\u7F6E\u9879\u65F6\uFF0C\u4E0E\u4EE5\u201CORDERER_\u201D\u524D\u7F00\u5F00\u5934\u7684\u73AF\u5883\u53D8\u91CF\u8FDB\u884C\u5339\u914D\uFF0C\u83B7\u53D6\u5176\u5728\u73AF\u5883\u53D8\u91CF\u4E2D\u7684\u914D\u7F6E\u503C\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>config <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cf<span class="token punctuation">.</span><span class="token function">InitViper</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> configName<span class="token punctuation">)</span>
	config<span class="token punctuation">.</span><span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span>Prefix<span class="token punctuation">)</span>
	config<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	replacer <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">NewReplacer</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span>
	config<span class="token punctuation">.</span><span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>replacer<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2461\uFF1A\u52A0\u8F7DOrderer.yaml\u914D\u7F6E\u6587\u4EF6</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>err <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u2462\uFF1A\u89E3\u6790\u914D\u7F6E\u6587\u4EF6\u6210Orderer\u914D\u7F6E\u5BF9\u8C61</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> uconf TopLevel
err <span class="token operator">=</span> viperutil<span class="token punctuation">.</span><span class="token function">EnhancedExactUnmarshal</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uconf<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u914D\u7F6E\u5BF9\u8C61\u4E3ATopLevel\u578B\uFF0C\u7ED3\u6784\u4F53\u5982\u4E0B\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> TopLevel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	General    General    <span class="token comment">//\u901A\u7528\u914D\u7F6E\u5BF9\u8C61</span>
	FileLedger FileLedger <span class="token comment">//\u6587\u672C\u8D26\u672C\u914D\u7F6E\u5BF9\u8C61</span>
	RAMLedger  RAMLedger  <span class="token comment">//RAM\u8D26\u672C\u914D\u7F6E\u5BF9\u8C61</span>
	Kafka      Kafka      <span class="token comment">// Kafka\u5171\u8BC6\u7EC4\u4EF6\u914D\u7F6E\u5BF9\u8C61</span>
	Debug      Debug      <span class="token comment">// \u8C03\u8BD5\u4FE1\u606F\u914D\u7F6E\u5BF9\u8C61</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2463\uFF1A\u68C0\u67E5Orderer\u914D\u7F6E\u5BF9\u8C61conf\u914D\u7F6E\u9879\u5E76\u8BBE\u7F6E\u9ED8\u8BA4\u503C</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>uconf<span class="token punctuation">.</span><span class="token function">completeInitialization</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="\u521D\u59CB\u5316\u65E5\u5FD7\u4E0E\u672C\u5730msp\u7EC4\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u521D\u59CB\u5316\u65E5\u5FD7\u4E0E\u672C\u5730msp\u7EC4\u4EF6" aria-hidden="true">#</a> \u521D\u59CB\u5316\u65E5\u5FD7\u4E0E\u672C\u5730MSP\u7EC4\u4EF6</h2><p>\u2460\uFF1A\u521D\u59CB\u5316\u65E5\u5FD7</p><p><code>initializeLoggingLevel</code>\u8BBE\u7F6E<code>Orderer</code>\u8282\u70B9\u4E0A\u7684\u65E5\u5FD7\u540E\u7AEF\u8F93\u51FA\u6D41\u3001\u8F93\u51FA\u683C \u5F0F\u4E0E\u9ED8\u8BA4\u65E5\u5FD7\u7EA7\u522B\uFF08<code>INFO</code>\u7EA7\u522B\uFF09\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initializeLoggingLevel</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>config<span class="token punctuation">.</span>TopLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flogging<span class="token punctuation">.</span><span class="token function">InitBackend</span><span class="token punctuation">(</span>flogging<span class="token punctuation">.</span><span class="token function">SetFormat</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>LogFormat<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stderr<span class="token punctuation">)</span>
	flogging<span class="token punctuation">.</span><span class="token function">InitFromSpec</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>LogLevel<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2461\uFF1A\u521D\u59CB\u5316\u672C\u5730MSP\u7EC4\u4EF6</p><p>\u9996\u5148\u52A0\u8F7D\u672C\u5730\u7684<code>MSP</code>\u7EC4\u4EF6\uFF0C\u6839\u636EMSP\u914D\u7F6E\u6587\u4EF6\u8DEF\u5F84\u3001<code>BCCSP</code>\u5BC6\u7801\u670D\u52A1\u7EC4\u4EF6\u914D\u7F6E\u3001<code>MSP</code>\u540D\u79F0\u521D\u59CB\u5316\u672C\u5730<code>MSP</code>\u7EC4\u4EF6 \u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initializeLocalMsp</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>config<span class="token punctuation">.</span>TopLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	err <span class="token operator">:=</span> mspmgmt<span class="token punctuation">.</span><span class="token function">LoadLocalMsp</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>LocalMSPDir<span class="token punctuation">,</span> conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>BCCSP<span class="token punctuation">,</span> conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>LocalMSPID<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u672C\u5730<code>MSP</code>\u7EC4\u4EF6\u9ED8\u8BA4\u4F7F\u7528<code>bccspmsp</code>\u7C7B\u578B\u5BF9\u8C61\u3002\u8BE5\u7C7B\u578B\u7684<code>MSP</code>\u7EC4\u4EF6\u662F\u57FA\u4E8E<code>BCCSP</code>\u7EC4\u4EF6\u63D0\u4F9B\u5BC6\u7801\u5957\u4EF6\u670D\u52A1\u7684\uFF0C\u5C01\u88C5\u4E86<code>MSP</code>\u7EC4\u4EF6\uFF08\u901A\u5E38\u5BF9\u5E94\u4E8E\u4E00\u4E2A\u7EC4\u7EC7\uFF09\u4FE1\u4EFB\u7684\u76F8\u5173\u8BC1\u4E66\u5217\u8868\uFF08\u5305\u542B\u6839<code>CA</code>\u8BC1\u4E66\u3001\u4E2D\u95F4<code>CA</code>\u8BC1\u4E66\u7B49\uFF09\u3001<code>MSP</code>\u540D\u79F0\u3001\u7B7E\u540D\u8005\u8EAB\u4EFD\u5B9E\u4F53\u4E0E\u7BA1\u7406\u5458\u8EAB\u4EFD\u5B9E\u4F53\u5217\u8868\u7B49\u3002MSP\u7EC4\u4EF6\u7684\u5173\u952E\u5185\u5BB9\u540E\u9762\u4F1A\u6709\u4E13\u95E8\u53BB\u8BB2\u89E3\u3002</p><h2 id="\u542F\u52A8orderer\u6392\u5E8F\u8282\u70B9" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8orderer\u6392\u5E8F\u8282\u70B9" aria-hidden="true">#</a> \u542F\u52A8Orderer\u6392\u5E8F\u8282\u70B9</h2><p>\u542F\u52A8\u51FD\u6570\u5728<code>/orderer/common/server/main.go/Start()\u51FD\u6570</code>\u4E2D\uFF0C\u63A5\u4E0B\u6765\u4E00\u6B65\u6B65\u7684\u89E3\u6790\uFF1A</p><p>\u2460\uFF1A\u521B\u5EFA\u672C\u5730MSP\u7B7E\u540D\u8005\u5B9E\u4F53 signer</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>signer <span class="token operator">:=</span> localmsp<span class="token punctuation">.</span><span class="token function">NewSigner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u2461\uFF1A\u521D\u59CB\u5316TLS\u8BA4\u8BC1\u7684\u5B89\u5168\u670D\u52A1\u5668\u914D\u7F6E\u9879\u548CgRPC\u670D\u52A1\u5668</p><p>\u672C\u5730gRPC\u670D\u52A1\u5668grpcServer\u9ED8\u8BA4\u7AEF\u53E3\u4E3A7050</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>serverConfig <span class="token operator">:=</span> <span class="token function">initializeServerConfig</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>       
grpcServer <span class="token operator">:=</span> <span class="token function">initializeGrpcServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> serverConfig<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2462\uFF1A\u8BBE\u7F6ETLS\u8FDE\u63A5\u8BA4\u8BC1\u7684\u56DE\u8C03\u51FD\u6570</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>tlsCallback <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>bundle <span class="token operator">*</span>channelconfig<span class="token punctuation">.</span>Bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> grpcServer<span class="token punctuation">.</span><span class="token function">MutualTLSRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u68C0\u6D4B\u662F\u5426\u9700\u8981\u8BA4\u8BC1TLS\u5BA2\u6237\u7AEF\u8BC1\u4E66</span>
			logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;Executing callback to update root CAs&quot;</span><span class="token punctuation">)</span>
			<span class="token function">updateTrustedRoots</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">,</span> caSupport<span class="token punctuation">,</span> bundle<span class="token punctuation">)</span> <span class="token comment">//\u6267\u884C\u56DE\u8C03\u51FD\u6570\u66F4\u65B0\u6839CA\u8BC1\u4E66</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2463\uFF1A\u521B\u5EFA\u591A\u901A\u9053\u6CE8\u518C\u7BA1\u7406\u5668</p><p>\u591A\u901A\u9053\u6CE8\u518C\u7BA1\u7406\u5668<code>Registrar</code>\u5BF9\u8C61\uFF0C\u7528\u4E8E\u6CE8\u518C<code>Orderer</code>\u8282\u70B9\u4E0A\u7684\u6240\u6709\u901A\u9053\uFF08\u5305\u62EC\u7CFB\u7EDF\u901A\u9053\u548C\u5E94\u7528\u901A\u9053\uFF09\uFF0C\u8D1F\u8D23\u7EF4\u62A4\u901A\u9053\u914D\u7F6E\u3001\u8D26\u672C\u7B49\u91CD\u8981\u8D44\u6E90\u3002</p><p>\u591A\u901A\u9053\u6CE8\u518C\u7BA1\u7406\u5668<code>Registrar</code>\u5BF9\u8C61\u76F8\u5F53\u4E8E<code>Orderer</code>\u8282\u70B9\u4E0A\u7684\u201C\u8D44\u6E90\u7BA1\u7406\u5668\u201D\uFF0C\u4E3A\u6BCF\u4E2A\u901A\u9053\u521B\u5EFA\u5173\u8054\u7684\u5171\u8BC6\u7EC4\u4EF6\u94FE\u5BF9\u8C61\uFF0C\u8D1F\u8D23\u4EA4\u6613\u6392\u5E8F\u3001\u6253\u5305\u51FA\u5757\u3001\u63D0\u4EA4\u8D26\u672C\u4EE5\u53CA\u901A\u9053\u7BA1\u7406\u7B49\u5DE5\u4F5C</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>manager <span class="token operator">:=</span> <span class="token function">initializeMultichannelRegistrar</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> signer<span class="token punctuation">,</span> tlsCallback<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initializeMultichannelRegistrar</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>config<span class="token punctuation">.</span>TopLevel<span class="token punctuation">,</span> signer crypto<span class="token punctuation">.</span>LocalSigner<span class="token punctuation">,</span>
	callbacks <span class="token operator">...</span><span class="token keyword">func</span><span class="token punctuation">(</span>bundle <span class="token operator">*</span>channelconfig<span class="token punctuation">.</span>Bundle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>multichannel<span class="token punctuation">.</span>Registrar <span class="token punctuation">{</span>
	lf<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">createLedgerFactory</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span> <span class="token comment">//\u521B\u5EFA\u901A\u9053\u7684\u8D26\u672C\u5DE5\u5382\u5BF9\u8C61</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>lf<span class="token punctuation">.</span><span class="token function">ChainIDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">initializeBootstrapChannel</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> lf<span class="token punctuation">)</span> <span class="token comment">//\u521D\u59CB\u5316\u7CFB\u7EDF\u901A\u9053</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Not bootstrapping because of existing chains&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//\u521B\u5EFA\u5E76\u8BBE\u7F6E\u5171\u8BC6\u7EC4\u4EF6\u5B57\u5178</span>
	consenters <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>consensus<span class="token punctuation">.</span>Consenter<span class="token punctuation">)</span>
	consenters<span class="token punctuation">[</span><span class="token string">&quot;solo&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> solo<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	consenters<span class="token punctuation">[</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> kafka<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>Kafka<span class="token punctuation">)</span> <span class="token comment">//// Kafka\u7C7B\u578B\u5171\u8BC6\u7EC4\u4EF6</span>
	<span class="token keyword">return</span> multichannel<span class="token punctuation">.</span><span class="token function">NewRegistrar</span><span class="token punctuation">(</span>lf<span class="token punctuation">,</span> consenters<span class="token punctuation">,</span> signer<span class="token punctuation">,</span> callbacks<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.1 \u521B\u5EFA\u901A\u9053\u7684\u8D26\u672C\u5DE5\u5382\u5BF9\u8C61</p><p>\u4EE3\u7801\u8DEF\u5F84<code>/orderer/common/server/util.go</code>\uFF0C\u5927\u6982\u505A\u4E86\u4EE5\u4E0B\u51E0\u4EF6\u4E8B\uFF1A</p><ul><li>\u83B7\u53D6<code>Orderer</code>\u8282\u70B9\u4E0A\u7684\u533A\u5757\u8D26\u672C\u5B58\u50A8\u76EE\u5F55ld\uFF0C\u5305\u62EC\u9ED8\u8BA4\u76EE\u5F55<code>/var/hyperledger/production/orderer</code>\u6216\u4E34\u65F6\u76EE\u5F55\u4E2D\u7684\u5B50\u76EE\u5F55<code>hyperledger-fabric-ordererledger</code>+\u968F\u673A\u6570\u540E\u7F00\uFF08\u9ED8\u8BA4\u76EE\u5F55\u4E0D\u5B58\u5728\u65F6\u4F7F\u7528\uFF09</li><li>\u521B\u5EFA\u57FA\u4E8E\u6587\u4EF6\u7684\u533A\u5757\u8D26\u672C\u5DE5\u5382\u5BF9\u8C61lf\uFF08<code>fileLedgerFactory</code>\u7C7B\u578B\uFF09</li><li>\u5728\u533A\u5757\u8D26\u672C\u76EE\u5F55\u4E0B\u5EFA\u7ACB\u4EE5chains\u547D\u540D\u7684\u5B50\u76EE\u5F55\uFF08<code>/var/hyperledger/production/orderer/chains</code>\uFF09\uFF0C\u7531\u6BCF\u4E2A\u901A\u9053\u8D26\u672C\u7684\u533A\u5757\u6570\u636E\u5B58\u50A8\u5BF9\u8C61\u8D1F\u8D23\u5728<code>chains</code>\u5B50\u76EE\u5F55\u4E0B\u521B\u5EFA\u7EF4\u62A4\u4EE5\u901A\u9053ID\uFF08\u5373\u94FEID\uFF09\u547D\u540D\u7684\u901A\u9053\u8D26\u672C\u5B50\u76EE\u5F55\uFF0C\u7528\u4E8E\u4FDD\u5B58\u8BE5\u901A\u9053\u8D26\u672C\u7684\u6240\u6709\u533A\u5757\u6570\u636E\u6587\u4EF6\u3002\u5176\u4E2D\uFF0C\u533A\u5757\u6570\u636E\u6587\u4EF6\u540D\u90FD\u662F\u4EE5<code>blockfile_num</code>\u547D\u540D\uFF0C<code>num</code>\u662F6\u4F4D\u533A\u5757\u6587\u4EF6\u7F16\u53F7\uFF0C\u5DE6\u4FA7\u4E0D\u8DB3\u4F4D\u6570\u75280\u8865\u9F50\u3002</li></ul><p>4.2 \u521D\u59CB\u5316\u7CFB\u7EDF\u901A\u9053</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initializeBootstrapChannel</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>config<span class="token punctuation">.</span>TopLevel<span class="token punctuation">,</span> lf blockledger<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">switch</span> conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>GenesisMethod <span class="token punctuation">{</span> <span class="token comment">// \u5206\u6790\u521B\u4E16\u533A\u5757\u7684\u751F\u6210\u65B9\u5F0F</span>
	<span class="token keyword">case</span> <span class="token string">&quot;provisional&quot;</span><span class="token punctuation">:</span> <span class="token comment">// \u6839\u636E\u914D\u7F6E\u6587\u4EF6\u751F\u6210\u521B\u4E16\u533A\u5757</span>
		genesisBlock <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>genesisconfig<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>GenesisProfile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GenesisBlockForChannel</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>SystemChannel<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">:</span> <span class="token comment">// \u6839\u636E\u521B\u4E16\u533A\u5757\u6587\u4EF6\u751F\u6210\u521B\u4E16\u533A\u5757</span>
		genesisBlock <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>GenesisFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GenesisBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
	<span class="token punctuation">}</span>

	chainID<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">GetChainIDFromBlock</span><span class="token punctuation">(</span>genesisBlock<span class="token punctuation">)</span> <span class="token comment">// \u4ECE\u521B\u4E16\u533A\u5757\u4E2D\u89E3\u6790\u83B7\u53D6\u901A\u9053ID</span>
	<span class="token operator">...</span>
	gl<span class="token punctuation">,</span> err <span class="token operator">:=</span> lf<span class="token punctuation">.</span><span class="token function">GetOrCreate</span><span class="token punctuation">(</span>chainID<span class="token punctuation">)</span> <span class="token comment">// \u521B\u5EFA\u7CFB\u7EDF\u901A\u9053\u7684\u533A\u5757\u8D26\u672C\u5BF9\u8C61</span>
	<span class="token operator">...</span>
	err <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>genesisBlock<span class="token punctuation">)</span> <span class="token comment">// \u6DFB\u52A0\u533A\u5757\u5230\u7CFB\u7EDF\u901A\u9053\u8D26\u672C\u4E0A</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2464\uFF1A\u521B\u5EFAOrderer\u6392\u5E8F\u670D\u52A1\u5668</p><p><code>Orderer</code>\u6392\u5E8F\u670D\u52A1\u5668\uFF0C\u63D0\u4F9B<code>Orderer</code>\u670D\u52A1\u4E0E\u7BA1\u7406\u6240\u6709\u901A\u9053\u8D44\u6E90\u53CA\u5176\u8D26\u672C\u3001\u5171\u8BC6\u7EC4\u4EF6\u7B49\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>server <span class="token operator">:=</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> signer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>conf<span class="token punctuation">.</span>Debug<span class="token punctuation">,</span> conf<span class="token punctuation">.</span>General<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>TimeWindow<span class="token punctuation">,</span> mutualTLS<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>r <span class="token operator">*</span>multichannel<span class="token punctuation">.</span>Registrar<span class="token punctuation">,</span> <span class="token boolean">_</span> crypto<span class="token punctuation">.</span>LocalSigner<span class="token punctuation">,</span> debug <span class="token operator">*</span>localconfig<span class="token punctuation">.</span>Debug<span class="token punctuation">,</span> timeWindow time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> mutualTLS <span class="token builtin">bool</span><span class="token punctuation">)</span> ab<span class="token punctuation">.</span>AtomicBroadcastServer <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token operator">&amp;</span>server<span class="token punctuation">{</span>
		dh<span class="token punctuation">:</span>        deliver<span class="token punctuation">.</span><span class="token function">NewHandlerImpl</span><span class="token punctuation">(</span>deliverSupport<span class="token punctuation">{</span>Registrar<span class="token punctuation">:</span> r<span class="token punctuation">}</span><span class="token punctuation">,</span> timeWindow<span class="token punctuation">,</span> mutualTLS<span class="token punctuation">)</span><span class="token punctuation">,</span>
		bh<span class="token punctuation">:</span>        broadcast<span class="token punctuation">.</span><span class="token function">NewHandlerImpl</span><span class="token punctuation">(</span>broadcastSupport<span class="token punctuation">{</span>Registrar<span class="token punctuation">:</span> r<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		debug<span class="token punctuation">:</span>     debug<span class="token punctuation">,</span>
		Registrar<span class="token punctuation">:</span> r<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>bh\uFF1ABroadcast</code>\u670D\u52A1\u5904\u7406\u53E5\u67C4\uFF08<code>deliverHandler</code>\u7C7B\u578B\uFF09\u3002\u8BE5\u5BF9\u8C61\u5B9E\u73B0\u4E86<code>Broadcast</code>\u4EA4\u6613\u5E7F\u64AD\u670D\u52A1\u7684<code>Handle(srv ab.AtomicBroadcast_BroadcastServer)</code>\u6D88\u606F\u5904\u7406\u63A5\u53E3\uFF0C\u8D1F\u8D23\u63A5\u6536\u5BA2\u6237\u7AEF\u63D0\u4EA4\u7684\u666E\u901A\u4EA4\u6613\u6D88\u606F\u4E0E\u914D\u7F6E\u4EA4\u6613\u6D88\u606F\uFF0C\u5E76\u5206\u522B\u8FDB\u884C\u5904\u7406\uFF0C\u8FC7\u6EE4\u540E\u8F6C\u53D1\u7ED9\u901A\u9053\u7ED1\u5B9A\u7684\u5171\u8BC6\u7EC4\u4EF6\u94FE\u5BF9\u8C61\u8FDB\u884C\u5904\u7406\uFF1B</p></li><li><p><code>dh\uFF1ADeliver</code>\u670D\u52A1\u5904\u7406\u53E5\u67C4\uFF08<code>handlerImpl</code>\u7C7B\u578B\uFF09\u3002\u8BE5\u5BF9\u8C61\u5B9E\u73B0\u4E86<code>Deliver</code>\u533A\u5757\u5206\u53D1\u670D\u52A1\u7684<code>Handle(srv*DeliverServer)</code>\u6D88\u606F\u5904\u7406\u63A5\u53E3\uFF0C\u8D1F\u8D23\u63A5\u6536\u5BA2\u6237\u7AEF\u63D0\u4EA4\u7684\u533A\u5757\u8BF7\u6C42\u6D88\u606F\uFF0C\u4ECE<code>Orderer</code>\u8282\u70B9\u533A\u5757\u8D26\u672C\u4E2D\u8BFB\u53D6\u6307\u5B9A\u7684\u533A\u5757\u6570\u636E\uFF0C\u5E76\u8FD4\u56DE\u7ED9\u8BF7\u6C42\u8282\u70B9\u3002\u5982\u679C\u8BF7\u6C42\u7684\u6307\u5B9A\u533A\u5757\u8FD8\u6CA1\u6709\u751F\u6210\uFF0C\u5219\u9ED8\u8BA4\u963B\u585E\u7B49\u5F85\u76F4\u5230\u8BE5\u533A\u5757\u521B\u5EFA\u548C\u63D0\u4EA4\u5B8C\u6BD5\uFF1B</p></li><li><p><code>Registrar\uFF1AOrderer</code>\u8282\u70B9\u7684\u591A\u901A\u9053\u6CE8\u518C\u7BA1\u7406\u5668\uFF08<code>Registrar</code>\u7C7B\u578B\uFF09\u3002\u8BE5\u5BF9\u8C61\u5C01\u88C5\u4E86<code>Orderer</code>\u8282\u70B9\u4E0A\u6240\u6709\u901A\u9053\u7684\u94FE\u652F\u6301\u5BF9\u8C61\u5B57\u5178<code>chains</code>\u3001\u5171\u8BC6\u7EC4\u4EF6\u5B57\u5178<code>consenters</code>\u3001\u533A\u5757\u8D26\u672C\u5DE5\u5382\u5BF9\u8C61<code>ledgerFactory</code>\u3001\u7CFB\u7EDF\u901A\u9053\u94FE\u652F\u6301\u5BF9\u8C61\u4E0EID\u3001\u672C\u5730\u7B7E\u540D\u8005\u5B9E\u4F53<code>signer</code>\u7B49\uFF0C\u7528\u4E8E\u7BA1\u7406\u901A\u9053\u914D\u7F6E\u3001\u533A\u5757\u8D26\u672C\u5BF9\u8C61\u3001\u5171\u8BC6\u7EC4\u4EF6\u7B49\u6838\u5FC3\u8D44\u6E90\uFF0C\u76F8\u5F53\u4E8E<code>Orderer</code>\u8282\u70B9\u4E0A\u7684\u201C\u8D44\u6E90\u7BA1\u7406\u5668\u201D\u3002</p></li></ul><p>\u2465\uFF1A\u89E3\u6790\u6267\u884C\u5B50\u547D\u4EE4</p><ul><li>start\u5B50\u547D\u4EE4\uFF1A\u542F\u52A8<code>profile</code>\u670D\u52A1\u4E0E<code>Orderer</code>\u6392\u5E8F\u670D\u52A1\u5668\uFF0C\u652F\u6301<code>go tool pprof</code>\u547D\u4EE4\u67E5\u770B\u4E0E\u5206\u6790\u7A0B\u5E8F\u6027\u80FD\u74F6\u9888</li><li>benchmark\u5B50\u547D\u4EE4\uFF1A\u7528\u4E8E\u542F\u52A8\u6D4B\u8BD5\u670D\u52A1\u5668</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">switch</span> cmd <span class="token punctuation">{</span> <span class="token comment">//\u5206\u6790\u547D\u4EE4\u7C7B\u578B</span>
	<span class="token keyword">case</span> start<span class="token punctuation">.</span><span class="token function">FullCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// &quot;start&quot; command // start\u542F\u52A8\u5B50\u547D\u4EE4</span>
		logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Starting %s&quot;</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">GetVersionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">initializeProfilingService</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span> <span class="token comment">// goroutine\u542F\u52A8go profile\u670D\u52A1</span>
		ab<span class="token punctuation">.</span><span class="token function">RegisterAtomicBroadcastServer</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">.</span><span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span>
		logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Beginning to serve requests&quot;</span><span class="token punctuation">)</span>
		grpcServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// \u542F\u52A8gRPC\u670D\u52A1\u5668\u63D0\u4F9BOrderer\u670D\u52A1</span>
	<span class="token keyword">case</span> benchmark<span class="token punctuation">.</span><span class="token function">FullCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// &quot;benchmark&quot; command // &quot;benchmark&quot; \u6D4B\u8BD5\u7528\u4F8B\u5B50\u547D\u4EE4</span>
		logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting orderer in benchmark mode&quot;</span><span class="token punctuation">)</span>
		benchmarkServer <span class="token operator">:=</span> performance<span class="token punctuation">.</span><span class="token function">GetBenchmarkServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		benchmarkServer<span class="token punctuation">.</span><span class="token function">RegisterService</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
		benchmarkServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="\u53C2\u8003" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003" aria-hidden="true">#</a> \u53C2\u8003</h2><blockquote><p>/</p></blockquote>`,59),p=[o];function c(i,l){return s(),a("div",null,p)}const d=n(t,[["render",c],["__file","2.Hyperledger_fabric_source.html.vue"]]);export{d as default};
