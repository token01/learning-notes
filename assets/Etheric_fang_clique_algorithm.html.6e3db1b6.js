import{_ as r}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as d,c as a,a as e,b as n,d as s,f as l,r as u}from"./app.f386ac8b.js";const v={},c=e("p",null,"\u4EE5\u592A\u574Aclique\u7B97\u6CD5",-1),t={href:"https://github.com/ethereum/go-ethereum/tree/v1.9.9",target:"_blank",rel:"noopener noreferrer"},o=e("p",null,[e("img",{src:"https://tva1.sinaimg.cn/large/008eGmZEgy1gomsueveelj31ao0t6wor.jpg",alt:"bca914bd89fa6439facc5a61b6e6d0a1"})],-1),m=e("h2",{id:"clique",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#clique","aria-hidden":"true"},"#"),n(" clique")],-1),b=e("p",null,"\u4EE5\u592A\u574A\u7684\u5B98\u65B9\u5171\u8BC6\u7B97\u6CD5\u662Fethash\u7B97\u6CD5\uFF0C\u8FD9\u5728\u524D\u6587\u5DF2\u7ECF\u6709\u4E86\u8BE6\u7EC6\u7684\u5206\u6790\uFF1A",-1),p=e("blockquote",null,[e("p",null,"\u5B83\u662F\u57FA\u4E8EPOW\u7684\u5171\u8BC6\u673A\u5236\u7684\uFF0C\u77FF\u5DE5\u9700\u8981\u901A\u8FC7\u8BA1\u7B97nonce\u503C\uFF0C\u4F1A\u6D88\u8017\u5927\u91CF\u7B97\u529B\u6765\u5339\u914Dtarget\u503C\u3002")],-1),h=e("p",null,"\u5982\u679C\u5728\u8054\u76DF\u94FE\u6216\u8005\u79C1\u94FE\u7684\u65B9\u6848\u91CC\uFF0C\u7EE7\u7EED\u4F7F\u7528ethash\u5C31\u4F1A\u6D6A\u8D39\u7B97\u529B\uFF0CPOW\u4E5F\u6CA1\u6709\u5B58\u5728\u7684\u610F\u4E49\u3002\u6240\u4EE5\u4EE5\u592A\u574A\u6709\u4E86\u53E6\u4E00\u79CD\u5171\u8BC6\u65B9\u6848\uFF1A\u57FA\u4E8EPOA\u7684clique\u3002",-1),g=e("blockquote",null,[e("p",null,"POA, Proof of Authority\u3002\u6743\u529B\u8BC1\u660E\uFF0C\u4E0D\u540C\u4E8EPOW\u7684\u5DE5\u4F5C\u91CF\u8BC1\u660E\uFF0CPOA\u662F\u80FD\u591F\u76F4\u63A5\u786E\u5B9A\u51E0\u4E2A\u8282\u70B9\u5177\u5907\u51FA\u5757\u7684\u6743\u529B\uFF0C\u8FD9\u51E0\u4E2A\u8282\u70B9\u51FA\u7684\u5757\u4F1A\u88AB\u5168\u7F51\u5176\u4ED6\u8282\u70B9\u9A8C\u8BC1\u4E3A\u6709\u6548\u5757\u3002")],-1),f={href:"https://github.com/evsward/blog/blob/master/posts/%E4%BB%A5%E5%A4%AA%E5%9D%8A-%E7%A7%81%E6%9C%89%E9%93%BE%E6%90%AD%E5%BB%BA%E5%88%9D%E6%AD%A5%E5%AE%9E%E8%B7%B5.md",target:"_blank",rel:"noopener noreferrer"},q=e("p",null,"\u901A\u8FC7\u8FD9\u7BC7\u6587\u7AE0\u7684\u64CD\u4F5C\u53EF\u4EE5\u5EFA\u7ACB\u4E00\u4E2A\u79C1\u6709\u94FE\uFF0C\u89C2\u5BDF\u8FD9\u4E2A\u6D41\u7A0B\u53EF\u4EE5\u770B\u5230\uFF0C\u901A\u8FC7puppeth\u5DE5\u5177\u5EFA\u7ACB\u521B\u4E16\u5757\u65F6\uFF0C\u4F1A\u63D0\u793A\u4F60\u9009\u62E9\u54EA\u79CD\u5171\u8BC6\u65B9\u5F0F\uFF0C\u6709ethash\u548Cclique\u4E24\u4E2A\u9009\u9879\uFF0C\u8BF4\u5230\u8FD9\u91CC\u6211\u4EEC\u5C31\u660E\u767D\u4E86\u4E3A\u4EC0\u4E48\u6587\u7AE0\u4E2D\u9ED8\u8BA4\u8981\u9009\u62E9clique\u3002",-1),x=e("h2",{id:"\u6E90\u7801\u5206\u6790",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#\u6E90\u7801\u5206\u6790","aria-hidden":"true"},"#"),n(" \u6E90\u7801\u5206\u6790")],-1),k=e("p",null,"\u8BB2\u8FC7\u4E86\u57FA\u672C\u6982\u5FF5\uFF0C\u4E0B\u9762\u6211\u4EEC\u6DF1\u5165\u4EE5\u592A\u574A\u6E90\u7801\u6765\u4ED4\u7EC6\u5206\u6790clique\u7B97\u6CD5\u7684\u5177\u4F53\u5B9E\u73B0\u3002",-1),y={href:"http://www.cnblogs.com/Evsward/p/miner.html#uncles%E5%8F%94%E5%9D%97%E7%9A%84%E6%A6%82%E5%BF%B5",target:"_blank",rel:"noopener noreferrer"},S=l(`<div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// \u6211\u4EEC\u7684\u6CE8\u91CA\u53EF\u4EE5\u5BF9\u6BD4\u7740\u6765\u770B\uFF0Cclique\u7684seal\u51FD\u6570\u7684\u76EE\u7684\u662F\uFF1A\u5C1D\u8BD5\u901A\u8FC7\u672C\u5730\u7B7E\u540D\u8BA4\u8BC1\uFF08\u6743\u529B\u7B7E\u540D\u4E0E\u8BA4\u8BC1\uFF0C\u627E\u5230\u6709\u6743\u529B\u7684\u7ED3\u70B9\uFF09\u6765\u521B\u5EFA\u4E00\u4E2A\u5DF2\u5BC6\u5C01\u7684\u533A\u5757\u3002
func (c *Clique) Seal(chain consensus.ChainReader, block *types.Block, stop &lt;-chan struct{}) (*types.Block, error) {
 header := block.Header()

 number := header.Number.Uint64()
 if number == 0 {// \u4E0D\u5141\u8BB8\u5BC6\u5C01\u521B\u4E16\u5757
  return nil, errUnknownBlock
 }
 // \u8DF3\u8F6C\u5230\u4E0B\u65B9Clique\u5BF9\u8C61\u7684\u5206\u6790\u3002\u4E0D\u652F\u63010-period\u7684\u94FE\uFF0C\u540C\u65F6\u62D2\u7EDD\u5BC6\u5C01\u7A7A\u5757\uFF0C\u6CA1\u6709\u5956\u52B1\u4F46\u662F\u80FD\u591F\u65CB\u8F6C\u5BC6\u5C01
 if c.config.Period == 0 &amp;&amp; len(block.Transactions()) == 0 {
  return nil, errWaitTransactions
 }
 // \u5728\u6574\u4E2A\u5BC6\u5C01\u533A\u5757\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u4E0D\u8981\u6301\u6709signer\u7B7E\u540D\u8005\u5B57\u6BB5\u3002
 c.lock.RLock() // \u4E0A\u9501\u83B7\u53D6config\u4E2D\u7684\u7B7E\u540D\u8005\u548C\u7B7E\u540D\u65B9\u6CD5\u3002
 signer, signFn := c.signer, c.signFn
 c.lock.RUnlock()

 snap, err := c.snapshot(chain, number-1, header.ParentHash, nil)// snapshot\u51FD\u6570\u89C1\u4E0B\u65B9\u5206\u6790
    // \u6821\u9A8C\u5904\u7406\uFF1A\u5982\u679C\u6211\u4EEC\u672A\u7ECF\u6388\u6743\u53BB\u7B7E\u540D\u4E86\u4E00\u4E2A\u533A\u5757
 if err != nil {
  return nil, err
 }
 if _, authorized := snap.Signers[signer]; !authorized {
  return nil, errUnauthorized
 }
 // \u5982\u679C\u6211\u4EEC\u662F\u3010\u6700\u8FD1\u7B7E\u540D\u8005\u3011\u7684\u4E00\u5458\uFF0C\u5219\u7B49\u5F85\u4E0B\u4E00\u4E2A\u533A\u5757\uFF0C// \u89C1\u4E0B\u65B9[\u5E95\u5C42\u673A\u5236\u4E09](http://www.cnblogs.com/Evsward/p/clique.html#%E4%B8%89%E8%AE%A4%E8%AF%81%E7%BB%93%E7%82%B9%E7%9A%84%E5%87%BA%E5%9D%97%E6%9C%BA%E4%BC%9A%E5%9D%87%E7%AD%89)
 for seen, recent := range snap.Recents {
  if recent == signer {
   // Signer\u5F53\u524D\u7B7E\u540D\u8005\u5728\u3010\u6700\u8FD1\u7B7E\u540D\u8005\u3011\u4E2D\uFF0C\u5982\u679C\u5F53\u524D\u533A\u5757\u6CA1\u6709\u5254\u9664\u4ED6\u7684\u8BDD\u53EA\u80FD\u7EE7\u7EED\u7B49\u5F85\u3002
   if limit := uint64(len(snap.Signers)/2 + 1); number &lt; limit || seen &gt; number-limit {
    log.Info(&quot;Signed recently, must wait for others&quot;)
    &lt;-stop
    return nil, nil
   }
  }
 }
 // \u901A\u8FC7\u4EE5\u4E0A\u6821\u9A8C\uFF0C\u5230\u4E86\u8FD9\u91CC\u8BF4\u660E\u534F\u8BAE\u5DF2\u7ECF\u5141\u8BB8\u6211\u4EEC\u6765\u7B7E\u540D\u8FD9\u4E2A\u533A\u5757\uFF0C\u7B49\u5F85\u6B64\u5DE5\u4F5C\u5B8C\u6210
 delay := time.Unix(header.Time.Int64(), 0).Sub(time.Now())
 if header.Difficulty.Cmp(diffNoTurn) == 0 {
  // \u8FD9\u4E0D\u662F\u6211\u4EEC\u7684\u8F6E\u6B21\u6765\u7B7E\u540D\uFF0Cdelay
  wiggle := time.Duration(len(snap.Signers)/2+1) * wiggleTime // wiggleTime = 500 * time.Millisecond // \u968F\u673A\u63A8\u5EF6\uFF0C\u4ECE\u800C\u5141\u8BB8\u5E76\u53D1\u7B7E\u540D\uFF08\u9488\u5BF9\u6BCF\u4E2A\u7B7E\u540D\u8005\uFF09
  delay += time.Duration(rand.Int63n(int64(wiggle)))

  log.Trace(&quot;Out-of-turn signing requested&quot;, &quot;wiggle&quot;, common.PrettyDuration(wiggle))
 }
 log.Trace(&quot;Waiting for slot to sign and propagate&quot;, &quot;delay&quot;, common.PrettyDuration(delay))

 select {
 case &lt;-stop:
  return nil, nil
 case &lt;-time.After(delay):
 }
 // \u6838\u5FC3\u5DE5\u4F5C\uFF1A\u5F00\u59CB\u7B7E\u540D
 sighash, err := signFn(accounts.Account{Address: signer}, sigHash(header).Bytes())// signFn\u51FD\u6570\u89C1\u4E0B\u65B9
 if err != nil {
  return nil, err
 }
 copy(header.Extra[len(header.Extra)-extraSeal:], sighash)//\u5C06\u7B7E\u540D\u7ED3\u679C\u66FF\u6362\u533A\u5757\u5934\u7684Extra\u5B57\u6BB5\uFF08\u4E13\u95E8\u652F\u6301\u8BB0\u5F55\u989D\u5916\u4FE1\u606F\u7684\uFF09

 return block.WithSeal(header), nil //\u901A\u8FC7\u533A\u5757\u5934\u91CD\u65B0\u7EC4\u88C5\u4E00\u4E2A\u533A\u5757
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Clique\u5BF9\u8C61\u7684\u5206\u6790</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Clique\u662FPOA\u5171\u8BC6\u5F15\u64CE\uFF0C\u8BA1\u5212\u5728Ropsten\u653B\u51FB\u4EE5\u540E\uFF0C\u7528\u6765\u652F\u6301\u4EE5\u592A\u574A\u79C1\u6D4B\u8BD5\u94FEtestnet\uFF08\u4E5F\u53EF\u4EE5\u81EA\u5DF1\u642D\u5EFA\u8054\u76DF\u94FE\u6216\u8005\u79C1\u6709\u94FE\uFF09
type Clique struct {
 config *params.CliqueConfig // \u5171\u8BC6\u5F15\u64CE\u914D\u7F6E\u53C2\u6570\uFF0C\u89C1\u4E0B\u65B9CliqueConfig\u6E90\u7801\u4ECB\u7ECD
 db     ethdb.Database       // \u6570\u636E\u5E93\uFF0C\u7528\u6765\u5B58\u50A8\u4EE5\u53CA\u83B7\u53D6\u5FEB\u7167\u68C0\u67E5\u70B9

 recents    *lru.ARCCache // \u6700\u8FD1\u533A\u5757\u7684\u5FEB\u7167\uFF0C\u7528\u6765\u52A0\u901F\u5FEB\u7167\u91CD\u7EC4
 signatures *lru.ARCCache // \u6700\u8FD1\u533A\u5757\u7684\u7B7E\u540D\uFF0C\u7528\u6765\u52A0\u901F\u6316\u77FF

 proposals map[common.Address]bool // \u76EE\u524D\u6211\u4EEC\u6B63\u5728\u63A8\u52A8\u7684\u63D0\u6848\u6E05\u5355\uFF0C\u5B58\u7684\u662F\u5730\u5740\u548C\u5E03\u5C14\u503C\u7684\u952E\u503C\u5BF9\u6620\u5C04

 signer common.Address // \u7B7E\u540D\u8005\u7684\u4EE5\u592A\u574A\u5730\u5740
 signFn SignerFn       // \u7B7E\u540D\u65B9\u6CD5\uFF0C\u7528\u6765\u6388\u6743\u54C8\u5E0C
 lock   sync.RWMutex   // \u9501\uFF0C\u4FDD\u62A4\u7B7E\u540D\u5B57\u6BB5
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CliqueConfig\u6E90\u7801\u5206\u6790</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// CliqueConfig\u662FPOA\u6316\u77FF\u7684\u5171\u8BC6\u5F15\u64CE\u7684\u914D\u7F6E\u5B57\u6BB5\u3002
type CliqueConfig struct {
 Period uint64 \`json:&quot;period&quot;\` // \u5728\u533A\u5757\u4E4B\u95F4\u6267\u884C\u7684\u79D2\u6570(\u53EF\u4EE5\u7406\u89E3\u4E3A\u8DDD\u79BB\u4E0A\u4E00\u5757\u51FA\u5757\u540E\u7684\u6D41\u901D\u65F6\u95F4\u79D2\u6570)
 Epoch  uint64 \`json:&quot;epoch&quot;\`  // Epoch[&#39;i\u02D0p\u0252k]\u957F\u5EA6\uFF0C\u91CD\u7F6E\u6295\u7968\u548C\u68C0\u67E5\u70B9
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>snapshot\u51FD\u6570\u5206\u6790</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// snapshot\u51FD\u6570\u53EF\u901A\u8FC7\u7ED9\u5B9A\u70B9\u83B7\u53D6\u8BA4\u8BC1\u5FEB\u7167
func (c *Clique) snapshot(chain consensus.ChainReader, number uint64, hash common.Hash, parents []*types.Header) (*Snapshot, error) {
 // \u5728\u5185\u5B58\u6216\u78C1\u76D8\u4E0A\u641C\u7D22\u4E00\u4E2A\u5FEB\u7167\u4EE5\u68C0\u67E5\u68C0\u67E5\u70B9\u3002
 var (
  headers []*types.Header// \u533A\u5757\u5934
  snap    *Snapshot// \u5FEB\u7167\u5BF9\u8C61\uFF0C\u89C1\u4E0B\u65B9
 )
 for snap == nil {
  // \u5982\u679C\u627E\u5230\u4E00\u4E2A\u5185\u5B58\u91CC\u7684\u5FEB\u7167\uFF0C\u4F7F\u7528\u4EE5\u4E0B\u65B9\u6848\uFF1A
  if s, ok := c.recents.Get(hash); ok {
   snap = s.(*Snapshot)
   break
  }
  // \u5982\u679C\u4E00\u4E2A\u5728\u78C1\u76D8\u68C0\u67E5\u70B9\u7684\u5FEB\u7167\u88AB\u627E\u5230\uFF0C\u4F7F\u7528\u4EE5\u4E0B\u65B9\u6848\uFF1A
  if number%checkpointInterval == 0 {// checkpointInterval = 1024 // \u533A\u5757\u53F7\uFF0C\u5728\u6570\u636E\u5E93\u4E2D\u4FDD\u5B58\u6295\u7968\u5FEB\u7167\u7684\u533A\u5757\u3002
   if s, err := loadSnapshot(c.config, c.signatures, c.db, hash); err == nil {// loadSnapshot\u51FD\u6570\u89C1\u4E0B\u65B9
    log.Trace(&quot;Loaded voting snapshot form disk&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash)
    snap = s
    break
   }
  }
  // \u5982\u679C\u6211\u4EEC\u5728\u521B\u4E16\u5757\uFF0C\u5219\u505A\u4E00\u4E2A\u5FEB\u7167
  if number == 0 {
   genesis := chain.GetHeaderByNumber(0)
   if err := c.VerifyHeader(chain, genesis, false); err != nil {
    return nil, err
   }
   signers := make([]common.Address, (len(genesis.Extra)-extraVanity-extraSeal)/common.AddressLength)
   for i := 0; i &lt; len(signers); i++ {
    copy(signers[i][:], genesis.Extra[extraVanity+i*common.AddressLength:])
   }
   snap = newSnapshot(c.config, c.signatures, 0, genesis.Hash(), signers)// \u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u5FEB\u7167\u7684\u51FD\u6570\uFF0C\u89C1\u4E0B\u65B9
   if err := snap.store(c.db); err != nil {
    return nil, err
   }
   log.Trace(&quot;Stored genesis voting snapshot to disk&quot;)
   break
  }
  // \u6CA1\u6709\u9488\u5BF9\u8FD9\u4E2A\u533A\u5757\u5934\u7684\u5FEB\u7167\uFF0C\u5219\u6536\u96C6\u533A\u5757\u5934\u5E76\u5411\u540E\u79FB\u52A8
  var header *types.Header
  if len(parents) &gt; 0 {
   // \u5982\u679C\u6211\u4EEC\u6709\u660E\u786E\u7684\u7236\u7C7B\uFF0C\u4ECE\u8FD9\u91CC\u5F3A\u5236\u6311\u62E3\u51FA\u6765\u3002
   header = parents[len(parents)-1]
   if header.Hash() != hash || header.Number.Uint64() != number {
    return nil, consensus.ErrUnknownAncestor
   }
   parents = parents[:len(parents)-1]
  } else {
   // \u5982\u679C\u6CA1\u6709\u660E\u786E\u7236\u7C7B\uFF08\u6216\u8005\u6CA1\u6709\u66F4\u591A\u7684\uFF09\uFF0C\u5219\u8F6C\u5230\u6570\u636E\u5E93
   header = chain.GetHeader(hash, number)
   if header == nil {
    return nil, consensus.ErrUnknownAncestor
   }
  }
  headers = append(headers, header)
  number, hash = number-1, header.ParentHash
 }
 // \u627E\u5230\u4E86\u5148\u524D\u7684\u5FEB\u7167\uFF0C\u90A3\u4E48\u5C06\u6240\u6709pending\u7684\u533A\u5757\u5934\u90FD\u653E\u5728\u5B83\u7684\u4E0A\u9762\u3002
 for i := 0; i &lt; len(headers)/2; i++ {
  headers[i], headers[len(headers)-1-i] = headers[len(headers)-1-i], headers[i]
 }
 snap, err := snap.apply(headers)//\u901A\u8FC7\u533A\u5757\u5934\u751F\u6210\u4E00\u4E2A\u65B0\u7684snapshot\u5BF9\u8C61
 if err != nil {
  return nil, err
 }
 c.recents.Add(snap.Hash, snap)//\u5C06\u5F53\u524D\u5FEB\u7167\u533A\u5757\u7684hash\u5B58\u5230recents\u4E2D\u3002

 // \u5982\u679C\u6211\u4EEC\u751F\u6210\u4E86\u4E00\u4E2A\u65B0\u7684\u68C0\u67E5\u70B9\u5FEB\u7167\uFF0C\u4FDD\u5B58\u5230\u78C1\u76D8\u4E0A\u3002
 if snap.Number%checkpointInterval == 0 &amp;&amp; len(headers) &gt; 0 {
  if err = snap.store(c.db); err != nil {
   return nil, err
  }
  log.Trace(&quot;Stored voting snapshot to disk&quot;, &quot;number&quot;, snap.Number, &quot;hash&quot;, snap.Hash)
 }
 return snap, err
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Snapshot\u5BF9\u8C61\u6E90\u7801\u5206\u6790\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Snapshot\u5BF9\u8C61\u662F\u5728\u7ED9\u5B9A\u70B9\u7684\u4E00\u4E2A\u8BA4\u8BC1\u6295\u7968\u7684\u72B6\u6001
type Snapshot struct {
 config   *params.CliqueConfig // \u914D\u7F6E\u53C2\u6570
 sigcache *lru.ARCCache        // \u7B7E\u540D\u7F13\u5B58\uFF0C\u6700\u8FD1\u7684\u533A\u5757\u7B7E\u540D\u52A0\u901F\u6062\u590D\u3002

 Number  uint64                      \`json:&quot;number&quot;\`  // \u5FEB\u7167\u5EFA\u7ACB\u7684\u533A\u5757\u53F7
 Hash    common.Hash                 \`json:&quot;hash&quot;\`    // \u5FEB\u7167\u5EFA\u7ACB\u7684\u533A\u5757\u54C8\u5E0C
 Signers map[common.Address]struct{} \`json:&quot;signers&quot;\` // \u5F53\u4E0B\u8BA4\u8BC1\u7B7E\u540D\u8005\u7684\u96C6\u5408
 Recents map[uint64]common.Address   \`json:&quot;recents&quot;\` // \u6700\u8FD1\u7B7E\u540D\u533A\u5757\u5730\u5740\u7684\u96C6\u5408
 Votes   []*Vote                     \`json:&quot;votes&quot;\`   // \u6309\u65F6\u95F4\u987A\u5E8F\u6392\u5217\u7684\u6295\u7968\u540D\u5355\u3002
 Tally   map[common.Address]Tally    \`json:&quot;tally&quot;\`   // \u5F53\u524D\u7684\u6295\u7968\u7ED3\u679C\uFF0C\u907F\u514D\u91CD\u65B0\u8BA1\u7B97\u3002
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>loadSnapshot\u51FD\u6570\u6E90\u7801\u5206\u6790\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// loadSnapshot\u51FD\u6570\u7528\u6765\u4ECE\u6570\u636E\u5E93\u4E2D\u52A0\u8F7D\u4E00\u4E2A\u73B0\u5B58\u7684\u5FEB\u7167\uFF0C\u53C2\u6570\u5217\u8868\u4E2D\u5F88\u591A\u90FD\u662FSnapshot\u5BF9\u8C61\u7684\u5173\u952E\u5B57\u6BB5\u5C5E\u6027\u3002
func loadSnapshot(config *params.CliqueConfig, sigcache *lru.ARCCache, db ethdb.Database, hash common.Hash) (*Snapshot, error) {
 blob, err := db.Get(append([]byte(&quot;clique-&quot;), hash[:]...))// ethdb\u4F7F\u7528\u7684\u662Fleveldb\uFF0C\u5BF9\u5916\u5F00\u653E\u63A5\u53E3Dababase\u89C1\u4E0B\u65B9
 if err != nil {
  return nil, err
 }
 snap := new(Snapshot)
 if err := json.Unmarshal(blob, snap); err != nil {
  return nil, err
 }
 snap.config = config
 snap.sigcache = sigcache

 return snap, nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ethdb\u6570\u636E\u5E93\u5BF9\u5916\u5F00\u653E\u63A5\u53E3\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Database\u63A5\u53E3\u5305\u88F9\u4E86\u6240\u6709\u7684\u6570\u636E\u5E93\u76F8\u5173\u64CD\u4F5C\uFF0C\u6240\u6709\u7684\u65B9\u6CD5\u90FD\u662F\u7EBF\u7A0B\u5B89\u5168\u7684\u3002
type Database interface {
 Putter
 Get(key []byte) ([]byte, error)//\u901A\u8FC7\u67D0key\u83B7\u53D6\u503C
 Has(key []byte) (bool, error)//\u67D0key\u662F\u5426\u5305\u542B\u6709\u6548\u503C
 Delete(key []byte) error
 Close()
 NewBatch() Batch
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>newSnapshot\u51FD\u6570\u6E90\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// newSnapshot\u51FD\u6570\u521B\u5EFA\u4E86\u4E00\u4E2A\u65B0\u7684\u5FEB\u7167\uFF0C\u901A\u8FC7\u7ED9\u51FA\u7684\u7279\u5B9A\u7684\u542F\u52A8\u53C2\u6570\u3002\u8FD9\u4E2A\u65B9\u6CD5\u6CA1\u6709\u521D\u59CB\u5316\u6700\u8FD1\u7B7E\u540D\u8005\u7684\u96C6\u5408\uFF0C\u6240\u4EE5\u53EA\u6709\u4F7F\u7528\u521B\u4E16\u5757\u3002
func newSnapshot(config *params.CliqueConfig, sigcache *lru.ARCCache, number uint64, hash common.Hash, signers []common.Address) *Snapshot {
 snap := &amp;Snapshot{// \u5C31\u662F\u7EC4\u88C5\u4E00\u4E2ASnapshot\u5BF9\u8C61\uFF0C\u5B89\u88C5\u76F8\u5E94\u53C2\u6570
  config:   config,
  sigcache: sigcache,
  Number:   number,
  Hash:     hash,
  Signers:  make(map[common.Address]struct{}),
  Recents:  make(map[uint64]common.Address),
  Tally:    make(map[common.Address]Tally),
 }
 for _, signer := range signers {
  snap.Signers[signer] = struct{}{}
 }
 return snap
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>signFn\u51FD\u6570\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// SignerFn\u662F\u4E00\u4E2A\u7B7E\u540D\u8005\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u7528\u6765\u8BF7\u6C42\u4E00\u4E2A\u80FD\u591F\u88AB\u540E\u53F0\u8D26\u6237\u7B7E\u540D\u751F\u6210\u7684\u54C8\u5E0C
type SignerFn func(accounts.Account, []byte) ([]byte, error)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>clique\u5E38\u91CF\u914D\u7F6E\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>blockPeriod = uint64(15)    // clique\u89C4\u5B9A\uFF0C\u4E24\u4E2A\u533A\u5757\u7684\u751F\u6210\u65F6\u95F4\u81F3\u5C11\u95F4\u969415\u79D2\uFF0Ctimestamp\u7C7B\u578B\u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="clique\u5E95\u5C42\u673A\u5236" tabindex="-1"><a class="header-anchor" href="#clique\u5E95\u5C42\u673A\u5236" aria-hidden="true">#</a> Clique\u5E95\u5C42\u673A\u5236</h2><p>\u5728\u8FDB\u5165\u5171\u8BC6\u5F15\u64CE\u4E4B\u524D\uFF0C\u5F53\u524D\u7ED3\u70B9\u5DF2\u7ECF\u751F\u6210\u4E86\u4E00\u4E2A\u5B8C\u6574\u7684\u533A\u5757\uFF0C\u5305\u62EC\u533A\u5757\u5934\u548C\u5BC6\u5C01\u7684\u4EA4\u6613\u5217\u8868\uFF0C\u7136\u540E\u8FDB\u5165seal\u51FD\u6570\uFF0C\u901A\u8FC7ethash\u6216\u8005clique\u7B97\u6CD5\u5F15\u64CE\u6765\u64CD\u4F5C\u51FA\u5757\u786E\u6743\u3002\u672C\u6587\u91CD\u70B9\u8BB2\u8FF0\u4E86\u9488\u5BF9clique\u7B97\u6CD5\u7684\u6E90\u7801\u5206\u6790\uFF0Cclique\u7B97\u6CD5\u57FA\u4E8EPOA\u5171\u8BC6\uFF0C\u662F\u5728\u7ED3\u70B9\u4E2D\u627E\u51FA\u6709\u6743\u529B\u7684\u51E0\u4E2A\u201C\u8D85\u7EA7\u7ED3\u70B9\u201D\uFF0C\u53EA\u6709\u8FD9\u4E9B\u7ED3\u70B9\u53EF\u4EE5\u751F\u6210\u5408\u6CD5\u533A\u5757\uFF0C\u5176\u4ED6\u7ED3\u70B9\u7684\u51FA\u5757\u90FD\u4F1A\u76F4\u63A5\u4E22\u5F03\u3002</p><h3 id="\u4E00-clique\u662F\u5982\u4F55\u786E\u5B9A\u7B7E\u540D\u8005\u4EE5\u53CA\u7B7E\u540D\u65B9\u6CD5\u7684" tabindex="-1"><a class="header-anchor" href="#\u4E00-clique\u662F\u5982\u4F55\u786E\u5B9A\u7B7E\u540D\u8005\u4EE5\u53CA\u7B7E\u540D\u65B9\u6CD5\u7684" aria-hidden="true">#</a> \u4E00\uFF1Aclique\u662F\u5982\u4F55\u786E\u5B9A\u7B7E\u540D\u8005\u4EE5\u53CA\u7B7E\u540D\u65B9\u6CD5\u7684\uFF1F</h3><p>\u6211\u5728clique\u6587\u4EF6\u4E2D\u641C\u7D22\uFF0C\u53D1\u73B0\u6709\u4E00\u4E2A\u65B9\u6CD5\u505A\u4E86\u8FD9\u4E2A\u5DE5\u4F5C\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Authorize\u51FD\u6570\u6CE8\u5165\u5171\u8BC6\u5F15\u64CEclique\u4E00\u4E2A\u79C1\u94A5\u5730\u5740\uFF08\u7B7E\u540D\u8005\uFF09\u4EE5\u53CA\u7B7E\u540D\u65B9\u6CD5signFn\uFF0C\u7528\u6765\u6316\u77FF\u65B0\u5757
func (c *Clique) Authorize(signer common.Address, signFn SignerFn) {
 c.lock.Lock()
 defer c.lock.Unlock()

 c.signer = signer
 c.signFn = signFn
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u90A3\u4E48\u7EE7\u7EED\u641C\u7D22\uFF0C\u8BE5\u51FD\u6570\u662F\u5728\u4F55\u65F6\u88AB\u8C03\u7528\u7684\uFF0C\u627E\u5230\u4E86\u4F4D\u4E8E/eth/backend.go\u4E2D\u7684\u51FD\u6570StartMining\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func (s *Ethereum) StartMining(local bool) error {
 eb, err := s.Etherbase()// \u7528\u6237\u5730\u5740
 if err != nil {
  log.Error(&quot;Cannot start mining without etherbase&quot;, &quot;err&quot;, err)//\u672A\u627E\u5230\u4EE5\u592A\u8D26\u6237\u5730\u5740\uFF0C\u62A5\u9519
  return fmt.Errorf(&quot;etherbase missing: %v&quot;, err)
 }
 // \u5982\u679C\u662Fclique\u5171\u8BC6\u7B97\u6CD5\uFF0C\u5219\u8D70if\u5206\u652F\uFF0C\u5982\u679C\u662Fethash\u5219\u8DF3\u8FC7if\u3002
 if clique, ok := s.engine.(*clique.Clique); ok {// Comma-ok\u65AD\u8A00\u8BED\u6CD5\u89C1\u4E0B\u65B9\u5206\u6790\u3002
  wallet, err := s.accountManager.Find(accounts.Account{Address: eb})// \u901A\u8FC7\u7528\u6237\u5730\u5740\u83B7\u5F97wallet\u5BF9\u8C61
  if wallet == nil || err != nil {
   log.Error(&quot;Etherbase account unavailable locally&quot;, &quot;err&quot;, err)
   return fmt.Errorf(&quot;signer missing: %v&quot;, err)
  }
  clique.Authorize(eb, wallet.SignHash)//\u5728\u8FD9\u91CC\uFF01\u6CE8\u5165\u4E86\u7B7E\u540D\u8005\u4EE5\u53CA\u901A\u8FC7wallet\u5BF9\u8C61\u83B7\u53D6\u5230\u7B7E\u540D\u65B9\u6CD5
 }
 if local {
  // \u5982\u679C\u672C\u5730CPU\u6316\u77FF\u5DF2\u542F\u52A8\uFF0C\u6211\u4EEC\u53EF\u4EE5\u7981\u6B62\u6CE8\u5165\u673A\u5236\u4EE5\u52A0\u901F\u540C\u6B65\u65F6\u95F4\u3002
  // CPU\u6316\u77FF\u5728\u4E3B\u7F51\u662F\u8352\u8BDE\u7684\uFF0C\u6240\u4EE5\u6CA1\u6709\u4EBA\u80FD\u78B0\u5230\u8FD9\u4E2A\u8DEF\u5F84\uFF0C\u7136\u800C\u4E00\u65E6CPU\u6316\u77FF\u540C\u6B65\u6807\u5FD7\u5B8C\u6210\u4EE5\u540E\uFF0C\u5C06\u4FDD\u8BC1\u79C1\u7F51\u5DE5\u4F5C\u4E5F\u5728\u4E00\u4E2A\u72EC\u7ACB\u77FF\u5DE5\u7ED3\u70B9\u3002
  atomic.StoreUint32(&amp;s.protocolManager.acceptTxs, 1)
 }
 go s.miner.Start(eb)//\u5E76\u53D1\u542F\u52A8\u6316\u77FF\u5DE5\u4F5C
 return nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u7EC8\uFF0C\u901A\u8FC7miner.Start(eb)\uFF0C\u8C03\u7528\u5230work -&gt; agent -&gt; CPUAgent -&gt; update -&gt; seal\uFF0C\u56DE\u5230\u6700\u4E0A\u65B9\u6211\u4EEC\u7684\u5165\u53E3\u3002</p>`,27),A={href:"http://www.cnblogs.com/Evsward/p/miner.html",target:"_blank",rel:"noopener noreferrer"},C=l(`<h3 id="go\u8BED\u6CD5\u8865\u5145-comma-ok\u65AD\u8A00" tabindex="-1"><a class="header-anchor" href="#go\u8BED\u6CD5\u8865\u5145-comma-ok\u65AD\u8A00" aria-hidden="true">#</a> Go\u8BED\u6CD5\u8865\u5145\uFF1AComma-ok\u65AD\u8A00</h3><blockquote><p>if clique, ok := s.engine.(*clique.Clique); ok {</p></blockquote><p>\u8FD9\u6BB5\u8BED\u53E5\u5F88\u4EE4\u4EBA\u8FF7\u60D1\uFF0C\u7ECF\u8FC7\u641C\u67E5\uFF0C\u4EE5\u4E0A\u8BED\u6CD5\u88AB\u79F0\u4F5CComma-ok\u65AD\u8A00\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>value, ok = element.(T)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>value\u662Felement\u53D8\u91CF\u7684\u503C\uFF0Cok\u662F\u5E03\u5C14\u7C7B\u578B\u7528\u6765\u8868\u8FBE\u65AD\u8A00\u7ED3\u679C\uFF0Celement\u662F\u63A5\u53E3\u53D8\u91CF\uFF0CT\u662F\u65AD\u8A00\u7C7B\u578B\u3002</p><p>\u5957\u5165\u4EE5\u4E0A\u4EE3\u7801\u6BB5\uFF0C\u7FFB\u8BD1\u8FC7\u6765\u5373\uFF1A</p><blockquote><p>\u5982\u679Cs.engine\u662FClique\u7C7B\u578B\uFF0C\u5219ok\u4E3Atrue\uFF0C\u540C\u65F6clique\u5C31\u7B49\u4E8Es.engine\u3002</p></blockquote><h3 id="\u4E8C-snapshot\u8D77\u5230\u7684\u4F5C\u7528\u662F\u4EC0\u4E48" tabindex="-1"><a class="header-anchor" href="#\u4E8C-snapshot\u8D77\u5230\u7684\u4F5C\u7528\u662F\u4EC0\u4E48" aria-hidden="true">#</a> \u4E8C\uFF1ASnapshot\u8D77\u5230\u7684\u4F5C\u7528\u662F\u4EC0\u4E48\uFF1F</h3><p>Snapshot\u5BF9\u8C61\u5728Seal\u65B9\u6CD5\u4E2D\u662F\u901A\u8FC7\u8C03\u7528snapshot\u6784\u9020\u51FD\u6570\u6765\u83B7\u53D6\u5230\u7684\u3002\u800Csnapshot\u6784\u9020\u51FD\u6570\u5185\u90E8\u6709\u8F83\u957F\u7684\u51FD\u6570\u4F53\uFF0C\u5305\u62ECnewSnapshot\u65B9\u6CD5\u4EE5\u53CAloadSnapshot\u65B9\u6CD5\u7684\u5904\u7406\u3002\u4ECE\u8FD9\u4E2A\u5206\u6790\u6765\u770B\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u77E5\u9053Snapshot\u662F\u5FEB\u7167\uFF0C\u4E5F\u662F\u7F13\u5B58\u7684\u4E00\u79CD\u673A\u5236\uFF0C\u540C\u65F6\u5B83\u4E5F\u4E0D\u4EC5\u4EC5\u662F\u7F13\u5B58\uFF0C\u56E0\u4E3A\u5B83\u5B58\u50A8\u4E86\u6700\u8FD1\u7B7E\u540D\u8005\u7684map\u96C6\u5408\u3002</p><blockquote><p>Snapshot\u53EF\u4EE5\u4ECE\u5185\u5B58\uFF08\u5373\u7A0B\u5E8F\u4E2D\u7684\u53D8\u91CF\uFF09\u6216\u662F\u78C1\u76D8\u4E0A\uFF08\u5373\u901A\u8FC7\u6570\u636E\u5E93leveldb\uFF09\u83B7\u53D6\u6216\u8005\u5B58\u50A8\uFF0C\u5B9E\u9645\u4E0A\u8FD9\u5C31\u662F\u4E8C\u7EA7\u7F13\u5B58\u7684\u6982\u5FF5\u4E86\u3002</p></blockquote><h3 id="\u4E09-\u8BA4\u8BC1\u7ED3\u70B9\u7684\u51FA\u5757\u673A\u4F1A\u5747\u7B49" tabindex="-1"><a class="header-anchor" href="#\u4E09-\u8BA4\u8BC1\u7ED3\u70B9\u7684\u51FA\u5757\u673A\u4F1A\u5747\u7B49" aria-hidden="true">#</a> \u4E09\uFF1A\u8BA4\u8BC1\u7ED3\u70B9\u7684\u51FA\u5757\u673A\u4F1A\u5747\u7B49</h3><p>\u9996\u5148\u5C06\u4E0A\u6587Seal\u65B9\u6CD5\u7684\u6E90\u7801\u9057\u7559\u4EE3\u7801\u6BB5\u5C55\u793A\u5982\u4E0B\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>for seen, recent := range snap.Recents {
 if recent == signer {
  if limit := uint64(len(snap.Signers)/2 + 1); number &lt; limit || seen &gt; number-limit {
   log.Info(&quot;Signed recently, must wait for others&quot;)
   &lt;-stop
   return nil, nil
  }
 }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>if recent == signer {
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5982\u679C\u5F53\u524D\u7ED3\u70B9\u6700\u8FD1\u7B7E\u540D\u8FC7\uFF0C\u5219\u8DF3\u8FC7\uFF0C\u4E3A\u4FDD\u8BC1<strong>\u673A\u4F1A\u5747\u7B49</strong>\uFF0C\u907F\u514D\u67D0\u4E2A\u8BA4\u8BC1\u7ED3\u70B9\u53EF\u4EE5\u8FDE\u7EED\u51FA\u5757\uFF0C\u4ECE\u800C\u4F5C\u6076\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>if limit := uint64(len(snap.Signers)/2 + 1); number &lt; limit || seen &gt; number-limit {
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5B9E\u9645\u4E0A\u5230\u4E86\u8FD9\u91CC\u5C31\u5DF2\u7ECF\u5728\u51B3\u5B9A\u51FA\u5757\u6743\u4E86\u3002\u6211\u4EEC\u4F9D\u6B21\u6765\u770B\uFF0C</p><ul><li>snap.Signers\u662F\u6240\u6709\u7684\u8BA4\u8BC1\u7ED3\u70B9\u3002</li><li>limit\u7684\u503C\u662F\u6240\u6709\u8BA4\u8BC1\u7ED3\u70B9\u7684\u6570\u91CF\u7684\u4E00\u534A\u52A01\uFF0C\u4E5F\u5C31\u662F\u8BF4\u53EF\u4EE5\u4FDD\u8BC1limit&gt;50%\u597D\u7684\u8BA4\u8BC1\u7ED3\u70B9\u4E2A\u6570\uFF08\u5B89\u5168\u6027\u8003\u8651\uFF1A\u638C\u63E1\u5927\u4E8E50%\u7684\u63A7\u5236\u6743\uFF09\u3002<strong>\u7ED3\u5408\u4E0A\u9762\u7684\u673A\u4F1A\u5747\u7B49\uFF0Cclique\u8981\u6C42\u8BA4\u8BC1\u7ED3\u70B9\u5728\u6BCF\u8F6Elimit\u4E2A\u533A\u5757\u4E2D\u53EA\u80FD\u751F\u6210\u4E00\u4E2A\u533A\u5757\u3002</strong></li><li>number\u662F\u5F53\u524D\u533A\u5757\u53F7</li><li>seen\u662F \u201Cfor seen, recent := range snap.Recents {\u201D \u4E2DRecents\u7684index\uFF0C\u4ECE0\u5F00\u59CB\uFF0C\u6700\u5927\u503C\u4E3ARecents\u7684\u603B\u6570-1\u3002</li></ul><p>\u63A5\u7740\uFF0C\u6211\u4EEC\u6765\u5206\u6790\u63A7\u5236\u7A0B\u5E8F\u4E2D\u6B62\u7684\u6761\u4EF6\u8868\u8FBE\u5F0F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>number &lt; limit || seen &gt; number-limit
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>number &lt; limit, \u5982\u679C\u533A\u5757\u9AD8\u5EA6\u5C0F\u4E8Elimit</li><li>seen &gt; number - limit\uFF0C\u7F13\u5B58\u4E2D\u6700\u8FD1\u7B7E\u53D1\u8005\u5E8F\u53F7\u5DF2\u7ECF\u8D85\u8FC7\u4E86\u533A\u5757\u9AD8\u5EA6\u4E0Elimit\u4E4B\u5DEE\u3002number-limit\u662F\u6700\u591A\u7684\u574F\u8282\u70B9\uFF0C\u7D22\u5F15seen\u5927\u4E8E\u574F\u8282\u70B9\u4E5F\u8981\u4E2D\u65AD\uFF08<strong>TODO: number\u533A\u5757\u9AD8\u5EA6\u4E0E\u8BA4\u8BC1\u7ED3\u70B9\u7684\u5173\u7CFB</strong>\uFF09</li></ul><p>\u5728\u8FD9\u4E24\u79CD\u60C5\u51B5\u4E0B\uFF0C\u4F1A\u4E2D\u65AD\u7A0B\u5E8F\uFF0C\u505C\u6B62\u7B7E\u540D\u4EE5\u53CA\u51FA\u5757\u64CD\u4F5C\u3002</p><h3 id="\u56DB-\u51FA\u5757\u96BE\u5EA6" tabindex="-1"><a class="header-anchor" href="#\u56DB-\u51FA\u5757\u96BE\u5EA6" aria-hidden="true">#</a> \u56DB\uFF1A\u51FA\u5757\u96BE\u5EA6</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// inturn\u51FD\u6570\u901A\u8FC7\u7ED9\u5B9A\u7684\u533A\u5757\u9AD8\u5EA6\u548C\u7B7E\u53D1\u8005\u8FD4\u56DE\u8BE5\u7B7E\u53D1\u8005\u662F\u5426\u5728\u8F6E\u6B21\u5185
func (s *Snapshot) inturn(number uint64, signer common.Address) bool {
    // \u65B9\u6CD5\u4F53\u7684\u5185\u5BB9\u5C31\u662F\u533A\u5757\u9AD8\u5EA6\u4E0E\u8BA4\u8BC1\u7B7E\u53D1\u8005\u96C6\u5408\u957F\u5EA6\u7684\u4F59\u6570\u662F\u5426\u7B49\u4E8E\u8BE5\u7B7E\u53D1\u8005\u7684\u4E0B\u6807\u503C
 signers, offset := s.signers(), 0
 for offset &lt; len(signers) &amp;&amp; signers[offset] != signer {
  offset++
 }
 return (number % uint64(len(signers))) == uint64(offset)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u4E00\u53E5\u8BDD\uFF0Cclique\u8981\u6C42\u7B7E\u53D1\u8005\u5FC5\u987B\u6309\u7167\u5176\u5728snapshot\u4E2D\u7684\u8BA4\u8BC1\u7B7E\u53D1\u8005\u96C6\u5408\u6309\u7167\u5B57\u5178\u6392\u5E8F\u7684\u987A\u5E8F\u51FA\u5757\u3002</p></blockquote><p>\u7B26\u5408\u4EE5\u4E0A\u6761\u4EF6\u7684\u8BDD\uFF0C\u96BE\u5EA6\u4E3A2\uFF0C\u5426\u5219\u4E3A1\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>diffInTurn = big.NewInt(2) // \u7B7E\u540D\u5728\u8F6E\u6B21\u5185\u7684\u533A\u5757\u96BE\u5EA6\u4E3A2\u3002
diffNoTurn = big.NewInt(1) // \u7B7E\u540D\u672A\u5728\u8F6E\u6B21\u5185\u7684\u533A\u5757\u96BE\u5EA6\u4E3A1\u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>clique\u7684\u51FA\u5757\u96BE\u5EA6\u6BD4\u8F83\u5BB9\u6613\u7406\u89E3\uFF0C\u8FD9\u662F\u5728POW\u4E2D\u5927\u4E66\u7279\u4E66\u7684\u90E8\u5206\u4F46\u5728clique\u4E2D\u5374\u5341\u5206\u7B80\u5355\uFF0C\u5F53inturn\u7684\u7ED3\u70B9\u79BB\u7EBF\u65F6\uFF0C\u5176\u4ED6\u7ED3\u70B9\u4F1A\u6765\u7ADE\u4E89\uFF0C\u96BE\u5EA6\u503C\u964D\u4E3A1\u3002\u7136\u800C\u6B63\u5E38\u51FA\u5757\u65F6\uFF0Climit\u4E2D\u7684\u6240\u6709\u8BA4\u8BC1\u7ED3\u70B9\u5305\u62EC\u4E00\u4E2Ainturn\u548C\u5176\u4ED6noturn\u7684\u7ED3\u70B9\uFF0Cclique\u662F\u91C7\u7528\u4E86\u7ED9noturn\u52A0\u5EF6\u8FDF\u65F6\u95F4\u7684\u65B9\u5F0F\u6765\u652F\u6301inturn\u9996\u5148\u51FA\u5757\uFF0C\u907F\u514Dnoturn\u7684\u7ED3\u70B9\u65E0\u8C13\u751F\u6210\u533A\u5757\u3002\u8FD9\u90E8\u5206\u4EE3\u7801\u5728\u4E0B\u9762\u518D\u8D34\u4E00\u6B21\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>wiggle := time.Duration(len(snap.Signers)/2+1) * wiggleTime // wiggleTime = 500 * time.Millisecond // \u968F\u673A\u63A8\u5EF6\uFF0C\u4ECE\u800C\u5141\u8BB8\u5E76\u53D1\u7B7E\u540D\uFF08\u9488\u5BF9\u6BCF\u4E2A\u7B7E\u540D\u8005\uFF09
delay += time.Duration(rand.Int63n(int64(wiggle)))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>clique\u8BA4\u53EF\u96BE\u5EA6\u503C\u6700\u9AD8\u7684\u94FE\u4E3A\u4E3B\u94FE\uFF0C\u6240\u4EE5\u5B8C\u5168inturn\u7ED3\u70B9\u51FA\u7684\u5757\u7EC4\u6210\u7684\u94FE\u4F1A\u662F\u6700\u7406\u60F3\u7684\u4E3B\u94FE\u3002</p></blockquote><h3 id="\u4E94-\u533A\u5757\u6821\u9A8C" tabindex="-1"><a class="header-anchor" href="#\u4E94-\u533A\u5757\u6821\u9A8C" aria-hidden="true">#</a> \u4E94\uFF1A\u533A\u5757\u6821\u9A8C</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// \u540C\u6837\u4F4D\u4E8Eclique\u6587\u4EF6\u4E2D\u7684verifySeal\u51FD\u6570\uFF0C\u987E\u540D\u601D\u4E49\u662F\u7ED3\u70B9\u7528\u6765\u6821\u9A8C\u522B\u7684\u7ED3\u70B9\u5E7F\u64AD\u8FC7\u6765\u7684\u533A\u5757\u4FE1\u606F\u7684\u3002
func (c *Clique) verifySeal(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {
 // \u521B\u4E16\u5757\u7684\u8BDD\u4E0D\u6821\u9A8C
 number := header.Number.Uint64()
 if number == 0 {
  return errUnknownBlock
 }
 // \u53D6\u5230\u6240\u9700snapshot\u5BF9\u8C61\uFF0C\u7528\u6765\u6821\u9A8C\u533A\u5757\u5934\u5E76\u4E14\u5C06\u5176\u7F13\u5B58\u3002
 snap, err := c.snapshot(chain, number-1, header.ParentHash, parents)
 if err != nil {
  return err
 }

 // \u5904\u7406\u6388\u6743\u79D8\u94A5\uFF0C\u68C0\u67E5\u662F\u5426\u8FDD\u80CC\u8BA4\u8BC1\u7B7E\u540D\u8005\u96C6\u5408
 signer, err := ecrecover(header, c.signatures)// \u4ECE\u533A\u5757\u5934\u4E2D\u89E3\u5BC6\u51FAExtra\u5B57\u6BB5\uFF0C\u627E\u5230\u7B7E\u540D\u5B57\u7B26\u4E32\uFF0C\u83B7\u5F97\u7B7E\u540D\u8005\u5730\u5740\u4FE1\u606F\u3002\u53EF\u4EE5\u8DF3\u8F6C\u5230\u4E0B\u9762ecrecover\u51FD\u6570\u7684\u6E90\u7801\u5206\u6790\u3002
 if err != nil {
  return err
 }
 if _, ok := snap.Signers[signer]; !ok {
  return errUnauthorized
 }
    // \u4E0ESeal\u76F8\u540C\u7684\u5904\u7406\uFF0C\u673A\u4F1A\u5747\u7B49
 for seen, recent := range snap.Recents {
  if recent == signer {
   if limit := uint64(len(snap.Signers)/2 + 1); seen &gt; number-limit {
    return errUnauthorized
   }
  }
 }
 // \u533A\u5206\u662F\u5426inturn\uFF0C\u8BBE\u7F6E\u533A\u5757\u56F0\u96BE\u5EA6\uFF0C\u4E0A\u9762\u4E5F\u4ECB\u7ECD\u8FC7\u4E86\u3002
 inturn := snap.inturn(header.Number.Uint64(), signer)
 if inturn &amp;&amp; header.Difficulty.Cmp(diffInTurn) != 0 {
  return errInvalidDifficulty
 }
 if !inturn &amp;&amp; header.Difficulty.Cmp(diffNoTurn) != 0 {
  return errInvalidDifficulty
 }
 return nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ecrecover\u51FD\u6570\u7684\u6E90\u7801\u5206\u6790\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// ecrecover\u51FD\u6570\u4ECE\u4E00\u4E2A\u7B7E\u540D\u7684\u533A\u5757\u5934\u4E2D\u89E3\u538B\u51FA\u4EE5\u592A\u574A\u8D26\u6237\u5730\u5740
func ecrecover(header *types.Header, sigcache *lru.ARCCache) (common.Address, error) {
 // \u5982\u679C\u7B7E\u540D\u5DF2\u7ECF\u88AB\u7F13\u5B58\uFF0C\u8FD4\u56DE\u5B83\u3002
 hash := header.Hash()
 if address, known := sigcache.Get(hash); known {
  return address.(common.Address), nil
 }
 // \u4ECE\u533A\u5757\u5934\u7684Extra\u5B57\u6BB5\u53D6\u5F97\u7B7E\u540D\u5185\u5BB9\u3002
 if len(header.Extra) &lt; extraSeal {
  return common.Address{}, errMissingSignature
 }
 signature := header.Extra[len(header.Extra)-extraSeal:]

 // \u901A\u8FC7\u5BC6\u7801\u5B66\u6280\u672F\u4ECE\u7B7E\u540D\u5185\u5BB9\u4E2D\u89E3\u5BC6\u51FA\u516C\u94A5\u548C\u4EE5\u592A\u574A\u5730\u5740\u3002
 pubkey, err := crypto.Ecrecover(sigHash(header).Bytes(), signature)// \u5177\u4F53\u6E90\u7801\u89C1\u4E0B\u65B9
 if err != nil {
  return common.Address{}, err
 }
 var signer common.Address
 copy(signer[:], crypto.Keccak256(pubkey[1:])[12:])//\u5C06\u516C\u94A5\u5229\u7528keccak256\u89E3\u5BC6\u8D4B\u503C\u7ED9signer\u3002

 sigcache.Add(hash, signer)//\u52A0\u5165\u7F13\u5B58
 return signer, nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>crypto\u5305\u7684Ecrecover\u51FD\u6570\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func Ecrecover(hash, sig []byte) ([]byte, error) {
 return secp256k1.RecoverPubkey(hash, sig)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ecrecover\u51FD\u6570\u662F\u4F7F\u7528secp256k1\u6765\u89E3\u5BC6\u516C\u94A5\u3002</p><p>\u4E0B\u9762\u6211\u4EEC\u4ECEVerifySeal\u51FD\u6570\u53CD\u63A8\uFF0C\u627E\u51FA\u8C03\u7528\u8BE5\u51FD\u6570\u7684\u4F4D\u7F6E\u5728miner/remote_agent.go\uFF0C</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// SubmitWork\u51FD\u6570\u5C1D\u8BD5\u6CE8\u5165\u4E00\u4E2Apow\u89E3\u51B3\u65B9\u6848\uFF08\u5171\u8BC6\u5F15\u64CE\uFF09\u5230\u8FDC\u7A0B\u4EE3\u7406\uFF0C\u8FD4\u56DE\u8FD9\u4E2A\u89E3\u51B3\u65B9\u6848\u662F\u5426\u88AB\u63A5\u53D7\u3002\uFF08\u4E0D\u80FD\u540C\u65F6\u662F\u4E00\u4E2A\u574F\u7684pow\u4E5F\u4E0D\u80FD\u6709\u5176\u4ED6\u4EFB\u4F55\u9519\u8BEF\uFF0C\u4F8B\u5982\u6CA1\u6709\u5DE5\u4F5C\u88ABpending
func (a *RemoteAgent) SubmitWork(nonce types.BlockNonce, mixDigest, hash common.Hash) bool {
 a.mu.Lock()
 defer a.mu.Unlock()

 // \u4FDD\u8BC1\u88AB\u63D0\u4EA4\u7684\u5DE5\u4F5C\u4E0D\u662F\u7A7A
 work := a.work[hash]
 if work == nil {
  log.Info(&quot;Work submitted but none pending&quot;, &quot;hash&quot;, hash)
  return false
 }
 // \u4FDD\u8BC1\u5F15\u64CE\u662F\u771F\u5B9E\u6709\u6548\u7684\u3002
 result := work.Block.Header()
 result.Nonce = nonce
 result.MixDigest = mixDigest

 if err := a.engine.VerifySeal(a.chain, result); err != nil {//\u5728\u8FD9\u91CC\uFF0CVerifySeal\u65B9\u6CD5\u88AB\u8C03\u7528\u3002
  log.Warn(&quot;Invalid proof-of-work submitted&quot;, &quot;hash&quot;, hash, &quot;err&quot;, err)
  return false
 }
 block := work.Block.WithSeal(result)

 // \u89E3\u51B3\u65B9\u6848\u770B\u4E0A\u53BB\u662F\u6709\u6548\u7684\uFF0C\u8FD4\u56DE\u5230\u77FF\u5DE5\u5E76\u4E14\u901A\u77E5\u63A5\u53D7\u7ED3\u679C\u3002
 a.returnCh &lt;- &amp;Result{work, block}
 delete(a.work, hash)

 return true
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E2ASubmitWork\u4F4D\u4E8E\u6316\u77FF\u7684pkg\u4E2D\uFF0C\u4E3B\u8981\u5DE5\u4F5C\u662F\u5BF9work\u7684\u6821\u9A8C\uFF0C\u5305\u62ECwork\u672C\u8EAB\u662F\u5426\u4E3A\u7A7A\uFF0Cwork\u4E2D\u7684\u533A\u5757\u5934\u4EE5\u53CA\u533A\u5757\u5934\u4E2D\u5305\u542B\u7684\u5B57\u6BB5\u7684\u6709\u6548\u6027\uFF0C\u7136\u540E\u662F\u5BF9\u533A\u5757\u5934\u7684VerifySeal\uFF08\u8BE5\u51FD\u6570\u7684\u529F\u80FD\u5728\u4E0A\u9762\u5DF2\u7ECF\u4ECB\u7ECD\u5230\u4E86\uFF0C\u4E3B\u8981\u662F\u5BF9\u533A\u5757\u7B7E\u540D\u8005\u7684\u8BA4\u8BC1\uFF0C\u533A\u5757\u96BE\u5EA6\u503C\u7684\u786E\u8BA4\uFF09</p><p>\u7EE7\u7EED\u53CD\u63A8\u627E\u5230SubmitWork\u51FD\u6570\u88AB\u8C03\u7528\u7684\u4F4D\u7F6E\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// SubmitWork\u51FD\u6570\u80FD\u591F\u88AB\u5916\u90E8\u77FF\u5DE5\u7528\u6765\u63D0\u4EA4\u4ED6\u4EEC\u7684POW\u3002
func (api *PublicMinerAPI) SubmitWork(nonce types.BlockNonce, solution, digest common.Hash) bool {
 return api.agent.SubmitWork(nonce, digest, solution)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u603B\u7ED3</strong></p><p>\u533A\u5757\u7684\u6821\u9A8C\u662F\u5916\u90E8\u7ED3\u70B9\u81EA\u52A8\u6267\u884CPublicMinerAPI\u7684SubmitWork\u65B9\u6CD5\uFF0C\u4ECE\u800C\u5C42\u5C42\u8C03\u7528\uFF0C\u901A\u8FC7\u68C0\u67E5\u533A\u5757\u5934\u5185\u7684\u7B7E\u540D\u5185\u5BB9\uFF0C\u901A\u8FC7secp256k1\u65B9\u6CD5\u6062\u590D\u516C\u94A5\uFF0C\u7136\u540E\u5229\u7528Keccak256\u5C06\u516C\u94A5\u52A0\u5BC6\u4E3A\u4E00\u4E2A\u4EE5\u592A\u5730\u5740\u4F5C\u4E3A\u7B7E\u540D\u5730\u5740\uFF0C\u83B7\u5F97\u7B7E\u540D\u5730\u5740\u4EE5\u540E\uFF0C\u53BB\u672C\u5730\u8BA4\u8BC1\u7ED3\u70B9\u7F13\u5B58\u4E2D\u68C0\u67E5\uFF0C\u770B\u8BE5\u7B7E\u540D\u5730\u5740\u662F\u5426\u7B26\u5408\u8981\u6C42\u3002\u6700\u7EC8\u53EA\u8981\u901A\u8FC7\u5C42\u5C42\u6821\u9A8C\uFF0C\u5C31\u4E0D\u4F1A\u62A5\u51FAerrUnauthorized\u7684\u9519\u8BEF\u3002</p><blockquote><p>\u6CE8\u610F\uFF1A\u7B7E\u540D\u8005\u5730\u5740common.Address\u5728Seal\u65F6\u88AB\u7B7E\u540Dsignature\u5B58\u5728\u533A\u5757\u5934\u7684Extra\u5B57\u6BB5\u4E2D\uFF0C\u7136\u540E\u5728VerifySeal\u4E2D\u88AB\u4ECE\u533A\u5757\u5934\u4E2D\u53D6\u51FA\u7B7E\u540Dsignature\u3002\u8BE5\u7B7E\u540D\u7684\u89E3\u5BC6\u65B9\u5F0F\u6BD4\u8F83\u590D\u6742\uFF1A\u8981\u5148\u901A\u8FC7secp256k1\u6062\u590D\u4E00\u4E2A\u516C\u94A5\uFF0C\u7136\u540E\u5229\u7528\u8FD9\u4E2A\u516C\u94A5\u548CKeccak256\u52A0\u5BC6\u51FA\u7B7E\u540D\u8005\u5730\u5740common.Address\u3002</p></blockquote><p>common.Address\u672C\u8EAB\u5C31\u662F\u7ED3\u70B9\u516C\u94A5\u7684Keccak256\u52A0\u5BC6\u7ED3\u679C\u3002\u8BF7\u53C2\u7167common/types.go\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Hex\u51FD\u6570\u8FD4\u56DE\u4E86\u4E00\u4E2A\u5341\u516D\u7981\u6B62\u7684\u5B57\u7B26\u4E32\uFF0C\u4EE3\u8868\u4E86\u4EE5\u592A\u574A\u5730\u5740\u3002
func (a Address) Hex() string {
 unchecksummed := hex.EncodeToString(a[:])
 sha := sha3.NewKeccak256()//\u8FD9\u91CC\u5C31\u4E0D\u5C55\u5F00\u4E86\uFF0C\u53EF\u4EE5\u770B\u51FA\u662F\u901A\u8FC7Keccak256\u65B9\u6CD5\u5C06\u672A\u68C0\u67E5\u7684\u660E\u6587Address\u52A0\u5BC6\u4E3A\u4E00\u4E2A\u6807\u51C6\u4EE5\u592A\u574A\u5730\u5740
 sha.Write([]byte(unchecksummed))
 hash := sha.Sum(nil)

 result := []byte(unchecksummed)
 for i := 0; i &lt; len(result); i++ {
  hashByte := hash[i/2]
  if i%2 == 0 {
   hashByte = hashByte &gt;&gt; 4
  } else {
   hashByte &amp;= 0xf
  }
  if result[i] &gt; &#39;9&#39; &amp;&amp; hashByte &gt; 7 {
   result[i] -= 32
  }
 }
 return &quot;0x&quot; + string(result)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u516D-\u57FA\u4E8E\u6295\u7968\u7684\u8BA4\u8BC1\u7ED3\u70B9\u7684\u8FD0\u884C\u673A\u5236" tabindex="-1"><a class="header-anchor" href="#\u516D-\u57FA\u4E8E\u6295\u7968\u7684\u8BA4\u8BC1\u7ED3\u70B9\u7684\u8FD0\u884C\u673A\u5236" aria-hidden="true">#</a> \u516D\uFF1A \u57FA\u4E8E\u6295\u7968\u7684\u8BA4\u8BC1\u7ED3\u70B9\u7684\u8FD0\u884C\u673A\u5236</h3><p>\u4E0A\u9762\u6211\u4EEC\u5206\u6790\u4E86clique\u7684\u8BA4\u8BC1\u7ED3\u70B9\u7684\u51FA\u5757\uFF0C\u6821\u9A8C\u7B49\u7EC6\u8282\uFF0C\u90A3\u4E48\u8FD9\u91CC\u5F15\u51FA\u7EC8\u6781\u95EE\u9898\uFF1A\u5982\u4F55\u786E\u8BA4\u4E00\u4E2A\u666E\u901A\u7ED3\u70B9\u662F\u5426\u662F\u8BA4\u8BC1\u7ED3\u70B9\u5462\uFF1F</p><blockquote><p>\u7B54\uFF1Aclique\u662F\u57FA\u4E8E\u6295\u7968\u673A\u5236\u6765\u786E\u8BA4\u8BA4\u8BC1\u7ED3\u70B9\u7684\u3002</p></blockquote><p>\u5148\u6765\u770B\u6295\u7968\u5B9E\u4F53\u7C7B\uFF0C\u5B58\u5728\u4E8Esnapshot\u6E90\u7801\u4E2D\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Vote\u4EE3\u8868\u4E86\u4E00\u4E2A\u72EC\u7ACB\u7684\u6295\u7968\uFF0C\u8FD9\u4E2A\u6295\u7968\u53EF\u4EE5\u6388\u6743\u4E00\u4E2A\u7B7E\u540D\u8005\uFF0C\u66F4\u6539\u6388\u6743\u5217\u8868\u3002
type Vote struct {
 Signer    common.Address \`json:&quot;signer&quot;\`    // \u5DF2\u6388\u6743\u7684\u7B7E\u540D\u8005\uFF08\u901A\u8FC7\u6295\u7968\uFF09
 Block     uint64         \`json:&quot;block&quot;\`     // \u6295\u7968\u533A\u5757\u53F7
 Address   common.Address \`json:&quot;address&quot;\`   // \u88AB\u6295\u7968\u7684\u8D26\u6237\uFF0C\u4FEE\u6539\u5B83\u7684\u6388\u6743
 Authorize bool           \`json:&quot;authorize&quot;\` // \u5BF9\u4E00\u4E2A\u88AB\u6295\u7968\u8D26\u6237\u662F\u5426\u6388\u6743\u6216\u89E3\u6388\u6743
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E2AVote\u662F\u5B58\u5728\u4E8ESnapshot\u7684\u5C5E\u6027\u5B57\u6BB5\u4E2D\uFF0C\u6240\u4EE5\u6295\u7968\u673A\u5236\u79BB\u4E0D\u5F00Snapshot\uFF0C\u6211\u4EEC\u5728\u8FD9\u91CC\u518D\u6B21\u5C06Snapshot\u5B9E\u4F53\u6E90\u7801\u91CD\u65B0\u5206\u6790\u4E00\u904D\uFF0C\u4E0A\u9762\u6CE8\u91CA\u8FC7\u7684\u5185\u5BB9\u6211\u4E0D\u518D\u590D\u8FF0\uFF0C\u800C\u662F\u76F4\u63A5\u5173\u6CE8\u5728\u6295\u7968\u673A\u5236\u76F8\u5173\u5B57\u6BB5\u5185\u5BB9\u4E0A\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>type Snapshot struct {
 config   *params.CliqueConfig
 sigcache *lru.ARCCache       

 Number  uint64                      \`json:&quot;number&quot;\`  
 Hash    common.Hash                 \`json:&quot;hash&quot;\`    
 Signers map[common.Address]struct{} \`json:&quot;signers&quot;\` // \u8BA4\u8BC1\u8282\u70B9\u96C6\u5408
 Recents map[uint64]common.Address   \`json:&quot;recents&quot;\` 
 Votes   []*Vote                     \`json:&quot;votes&quot;\`   // \u4E0A\u9762\u7684Vote\u5BF9\u8C61\u6570\u7EC4
 Tally   map[common.Address]Tally    \`json:&quot;tally&quot;\`   // \u4E5F\u662F\u4E00\u4E2A\u81EA\u5B9A\u4E49\u7C7B\u578B\uFF0C\u89C1\u4E0B\u65B9
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Tally\u7ED3\u6784\u4F53\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Tally\u662F\u4E00\u4E2A\u7B80\u5355\u7684\u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6295\u7968\u5206\u6570\u7684\u8BA1\u5206\u5668
type Tally struct {
 Authorize bool \`json:&quot;authorize&quot;\` // \u6388\u6743true\u6216\u79FB\u9664false
 Votes     int  \`json:&quot;votes&quot;\`     // \u8BE5\u63D0\u6848\u5DF2\u83B7\u7968\u6570
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53E6\u5916Clique\u5B9E\u4F53\u4E2D\u8FD8\u6709\u4E2A\u6709\u4E89\u8BAE\u7684\u5B57\u6BB5proposals\uFF0C\u5F53\u65F6\u5E76\u6CA1\u6709\u5206\u6790\u6E05\u695A\uFF0C\u4F55\u8C13\u63D0\u6848\uFF1F</p><blockquote><p>proposal\u662F\u53EF\u4EE5\u901A\u8FC7rpc\u7533\u8BF7\u52A0\u5165\u6216\u79FB\u9664\u4E00\u4E2A\u8BA4\u8BC1\u8282\u70B9\uFF0C\u7ED3\u6784\u4E3A\u5F85\u64CD\u4F5C\u5730\u5740\uFF08\u8282\u70B9\u5730\u5740\uFF09\u548C\u72B6\u6001\uFF08\u52A0\u5165\u6216\u79FB\u9664\uFF09</p></blockquote><h4 id="\u6295\u7968\u4E2D\u67D0\u4E9B\u6982\u5FF5\u7684\u786E\u5B9A" tabindex="-1"><a class="header-anchor" href="#\u6295\u7968\u4E2D\u67D0\u4E9B\u6982\u5FF5\u7684\u786E\u5B9A" aria-hidden="true">#</a> \u6295\u7968\u4E2D\u67D0\u4E9B\u6982\u5FF5\u7684\u786E\u5B9A</h4><ul><li>\u6295\u7968\u7684\u8303\u56F4\u662F\u5728\u59D4\u5458\u4F1A\uFF0C\u59D4\u5458\u4F1A\u7684\u610F\u601D\u5C31\u662F\u6240\u6709\u77FF\u5DE5\u3002</li><li>\u6982\u5FF5\u4ECB\u7ECD\uFF1Acheckpoint\uFF0CcheckpointInterval = 1024 \uFF0C\u6BCF\u8FC71024\u4E2A\u533A\u5757\uFF0C\u5219\u4FDD\u5B58snapshot\u5230\u6570\u636E\u5E93</li><li>\u6982\u5FF5\u4ECB\u7ECD\uFF1AEpoch\uFF0C\u4E0Eethash\u4E00\u6837\uFF0C\u4E00\u4E2AEpoch\u662F\u4E09\u4E07\u4E2A\u533A\u5757</li></ul><h4 id="\u6295\u7968\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#\u6295\u7968\u6D41\u7A0B" aria-hidden="true">#</a> \u6295\u7968\u6D41\u7A0B</h4><ul><li>\u9996\u5148\u59D4\u5458\u4F1A\u67D0\u4E2A\u6210\u5458\uFF08\u5373\u8282\u70B9\u77FF\u5DE5\uFF09\u901A\u8FC7rpc\u8C03\u7528consensus/clique/api.go\u4E2D\u7684propose\u65B9\u6CD5</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// Propose\u6CE8\u5165\u4E00\u4E2A\u65B0\u7684\u6388\u6743\u63D0\u6848\uFF0C\u53EF\u4EE5\u6388\u6743\u4E00\u4E2A\u7B7E\u540D\u8005\u6216\u8005\u79FB\u9664\u4E00\u4E2A\u3002
func (api *API) Propose(address common.Address, auth bool) {
 api.clique.lock.Lock()
 defer api.clique.lock.Unlock()

 api.clique.proposals[address] = auth// true:\u6388\u6743\uFF0Cfalse:\u79FB\u9664
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u4E0A\u9762rpc\u63D0\u4EA4\u8FC7\u6765\u7684propose\u4F1A\u5199\u5165Clique.proposals\u96C6\u5408\u4E2D\u3002</li><li>\u5728\u6316\u77FF\u5F00\u59CB\u4EE5\u540E\uFF0C\u4F1A\u5728miner.start()\u4E2D\u63D0\u4EA4\u4E00\u4E2AcommitNewWork\uFF0C\u5176\u4E2D\u6D89\u53CA\u5230\u51C6\u5907\u533A\u5757\u5934Prepare\u7684\u65B9\u6CD5\uFF0C\u6211\u4EEC\u8FDB\u5165\u5230clique\u7684\u5B9E\u73B0\uFF0C\u5176\u4E2D\u6D89\u53CA\u5230\u5BF9\u4E0A\u9762\u7684Clique.proposals\u7684\u5904\u7406\uFF1A</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// \u5982\u679C\u5B58\u5728pending\u7684proposals\uFF0C\u5219\u6295\u7968
if len(addresses) &gt; 0 {
 header.Coinbase = addresses[rand.Intn(len(addresses))]//\u5C06\u6295\u7968\u8282\u70B9\u7684\u5730\u5740\u8D4B\u503C\u7ED9\u533A\u5757\u5934\u7684Coinbase\u5B57\u6BB5\u3002
 // \u4E0B\u9762\u662F\u901A\u8FC7\u63D0\u6848\u5185\u5BB9\u6765\u7EC4\u88C5\u533A\u5757\u5934\u7684\u968F\u673A\u6570\u5B57\u6BB5\u3002
 if c.proposals[header.Coinbase] {
  copy(header.Nonce[:], nonceAuthVote)
 } else {
  copy(header.Nonce[:], nonceDropVote)
 }
}

// nonceAuthVote\u548CnonceDropVote\u5E38\u91CF\u7684\u58F0\u660E\u4E0E\u521D\u59CB\u5316
nonceAuthVote = hexutil.MustDecode(&quot;0xffffffffffffffff&quot;) // \u6388\u6743\u7B7E\u540D\u8005\u7684\u5FC5\u8981\u968F\u673A\u6570
nonceDropVote = hexutil.MustDecode(&quot;0x0000000000000000&quot;) // \u79FB\u9664\u7B7E\u540D\u8005\u7684\u5FC5\u8981\u968F\u673A\u6570
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u6574\u4E2A\u533A\u5757\u7EC4\u88C5\u597D\u4EE5\u540E\uFF08\u5176\u4ED6\u7684\u5185\u5BB9\u4E0D\u518D\u590D\u8FF0\uFF09\uFF0C\u4F1A\u88AB\u5E7F\u64AD\u5230\u5916\u90E8\u7ED3\u70B9\u6821\u9A8C\uFF0C\u5982\u679C\u6CA1\u6709\u95EE\u9898\u8BE5\u5757\u88AB\u6210\u529F\u51FA\u4E86\uFF0C\u5219\u533A\u5757\u5934\u4E2D\u7684\u8FD9\u4E2A\u63D0\u6848\u4E5F\u4F1A\u88AB\u8BB0\u5F55\u5728\u4E3B\u94FE\u4E0A\u3002</li><li>\u533A\u5757\u5728\u751F\u6210\u65F6\uFF0C\u4F1A\u521B\u5EFASnapshot\uFF0C\u5728snapshot\u6784\u9020\u51FD\u6570\u4E2D\uFF0C\u4F1A\u6D89\u53CA\u5230\u5BF9proposal\u7684\u5904\u7406apply\u65B9\u6CD5\u3002</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// apply\u901A\u8FC7\u63A5\u53D7\u4E00\u4E2A\u7ED9\u5B9A\u533A\u5757\u5934\u521B\u5EFA\u4E86\u4E00\u4E2A\u65B0\u7684\u6388\u6743
func (s *Snapshot) apply(headers []*types.Header) (*Snapshot, error) {
 if len(headers) == 0 {
  return s, nil
 }
 for i := 0; i &lt; len(headers)-1; i++ {
  if headers[i+1].Number.Uint64() != headers[i].Number.Uint64()+1 {
   return nil, errInvalidVotingChain
  }
 }
 if headers[0].Number.Uint64() != s.Number+1 {
  return nil, errInvalidVotingChain
 }
 snap := s.copy()
    // \u6295\u7968\u7684\u5904\u7406\u6838\u5FC3\u4EE3\u7801
 for _, header := range headers {
  // Remove any votes on checkpoint blocks
  number := header.Number.Uint64()
  // \u5982\u679C\u533A\u5757\u9AD8\u5EA6\u6B63\u597D\u5728Epoch\u7ED3\u675F\uFF0C\u5219\u6E05\u7A7A\u6295\u7968\u548C\u8BA1\u5206\u5668
  if number%s.config.Epoch == 0 {
   snap.Votes = nil
   snap.Tally = make(map[common.Address]Tally)
  }
  if limit := uint64(len(snap.Signers)/2 + 1); number &gt;= limit {
   delete(snap.Recents, number-limit)
  }
  // \u4ECE\u533A\u5757\u5934\u4E2D\u89E3\u5BC6\u51FA\u6765\u7B7E\u540D\u8005\u5730\u5740
  signer, err := ecrecover(header, s.sigcache)
  if err != nil {
   return nil, err
  }
  if _, ok := snap.Signers[signer]; !ok {
   return nil, errUnauthorized
  }
  for _, recent := range snap.Recents {
   if recent == signer {
    return nil, errUnauthorized
   }
  }
  snap.Recents[number] = signer

  // \u533A\u5757\u5934\u8BA4\u8BC1\uFF0C\u4E0D\u7BA1\u8BE5\u7B7E\u540D\u8005\u4E4B\u524D\u7684\u4EFB\u4F55\u6295\u7968
  for i, vote := range snap.Votes {
   if vote.Signer == signer &amp;&amp; vote.Address == header.Coinbase {
    // \u4ECE\u7F13\u5B58\u8BA1\u6570\u5668\u4E2D\u79FB\u9664\u8BE5\u6295\u7968
    snap.uncast(vote.Address, vote.Authorize)

    // \u4ECE\u6309\u65F6\u95F4\u6392\u5E8F\u7684\u5217\u8868\u4E2D\u79FB\u9664\u6295\u7968
    snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
    break // only one vote allowed
   }
  }
  // \u4ECE\u7B7E\u540D\u8005\u4E2D\u8BA1\u6570\u65B0\u7684\u6295\u7968
  var authorize bool
  switch {
  case bytes.Equal(header.Nonce[:], nonceAuthVote):
   authorize = true
  case bytes.Equal(header.Nonce[:], nonceDropVote):
   authorize = false
  default:
   return nil, errInvalidVote
  }
  if snap.cast(header.Coinbase, authorize) {
   snap.Votes = append(snap.Votes, &amp;Vote{
    Signer:    signer,
    Block:     number,
    Address:   header.Coinbase,
    Authorize: authorize,
   })
  }
  // \u5224\u65AD\u7968\u6570\u662F\u5426\u8D85\u8FC7\u4E00\u534A\u7684\u6295\u7968\u8005\uFF0C\u5982\u679C\u6295\u7968\u901A\u8FC7\uFF0C\u66F4\u65B0\u7B7E\u540D\u8005\u5217\u8868
  if tally := snap.Tally[header.Coinbase]; tally.Votes &gt; len(snap.Signers)/2 {
   if tally.Authorize {
    snap.Signers[header.Coinbase] = struct{}{}
   } else {
    delete(snap.Signers, header.Coinbase)

    if limit := uint64(len(snap.Signers)/2 + 1); number &gt;= limit {
     delete(snap.Recents, number-limit)
    }
    for i := 0; i &lt; len(snap.Votes); i++ {
     if snap.Votes[i].Signer == header.Coinbase {
      snap.uncast(snap.Votes[i].Address, snap.Votes[i].Authorize)

      snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)

      i--
     }
    }
   }
   // \u4E0D\u7BA1\u4E4B\u524D\u7684\u4EFB\u4F55\u6295\u7968\uFF0C\u76F4\u63A5\u6539\u53D8\u8D26\u6237
   for i := 0; i &lt; len(snap.Votes); i++ {
    if snap.Votes[i].Address == header.Coinbase {
     snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
     i--
    }
   }
   delete(snap.Tally, header.Coinbase)
  }
 }
 snap.Number += uint64(len(headers))
 snap.Hash = headers[len(headers)-1].Hash()

 return snap, nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5173\u952E\u63A7\u5236\u7684\u4EE3\u7801\u662Ftally.Votes &gt; len(snap.Signers)/2\uFF0C\u610F\u601D\u662F\u8BA1\u5206\u5668\u4E2D\u7684\u7968\u6570\u5927\u4E8E\u4E00\u534A\u7684\u7B7E\u540D\u8005\uFF0C\u5C31\u8868\u793A\u8BE5\u6295\u7968\u901A\u8FC7\uFF0C\u4E0B\u9762\u5C31\u662F\u8981\u66F4\u6539snapshot\u4E2D\u7684\u8BA4\u8BC1\u7B7E\u540D\u8005\u5217\u8868\u7F13\u5B58\uFF0C\u540C\u65F6\u8981\u540C\u6B65\u7ED9\u5176\u4ED6\u8282\u70B9\uFF0C\u5E76\u5220\u9664\u8BE5\u6295\u7968\u76F8\u5173\u4FE1\u606F\u3002</p><h2 id="\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#\u603B\u7ED3" aria-hidden="true">#</a> \u603B\u7ED3</h2><p>\u672C\u4EE5\u4E3Aclique\u6BD4\u8F83\u7B80\u5355\uFF0C\u4E0D\u5FC5\u8C03\u67E5\u8FD9\u4E48\u957F\uFF0C\u7136\u800CPOA\u7684\u5171\u8BC6\u7B97\u6CD5\u8FD8\u662F\u6BD4\u8F83\u6709\u96BE\u5EA6\u7684\uFF0C\u5B83\u548CPOW\u662F\u57FA\u4E8E\u5B8C\u5168\u4E0D\u540C\u7684\u4E24\u79CD\u573A\u666F\u7684\u5B9E\u73B0\u65B9\u5F0F\uFF0C\u51FA\u5757\u65B9\u5F0F\u4E5F\u5B8C\u5168\u4E0D\u540C\u3002\u4E0B\u9762\u6211\u5C1D\u8BD5\u7528\u7B80\u77ED\u7684\u8BED\u8A00\u6765\u603B\u7ED3Clique\u7684\u5171\u8BC6\u673A\u5236\u3002</p><blockquote><p>clique\u5171\u8BC6\u662F\u57FA\u4E8E\u59D4\u5458\u4F1A\u9009\u4E3E\u8BA4\u8BC1\u8282\u70B9\u6765\u786E\u8BA4\u51FA\u5757\u6743\u529B\u7684\u65B9\u5F0F\u5B9E\u73B0\u7684\u3002\u6295\u7968\u65B9\u5F0F\u901A\u8FC7rpc\u8BF7\u6C42propose\uFF0Csnapshot\u4E8C\u7EA7\u7F13\u5B58\u673A\u5236\uFF0C\u5531\u7968\uFF0C\u6267\u884C\u6295\u7968\u7ED3\u679C\u3002\u8BA4\u8BC1\u8282\u70B9\u51FA\u5757\u673A\u4F1A\u5747\u7B49\uFF0C\u56F0\u96BE\u5EA6\u901A\u8FC7\u8F6E\u6B21\uFF08\u662F\u5426\u6309\u7167\u7F13\u5B58\u8BA4\u8BC1\u987A\u5E8F\u51FA\u5757\uFF09\u786E\u5B9A\uFF0C\u533A\u5757\u5934Extra\u5B58\u50A8\u7B7E\u540D\uFF0Ckeccak256\u52A0\u5BC6\u4EE5\u592A\u5730\u5740\uFF0Csecp256k1\u89E3\u5BC6\u7B7E\u540D\u4E3A\u516C\u94A5\uFF0C\u901A\u8FC7\u8BA4\u8BC1\u7ED3\u70B9\u51FA\u5757\u7684\u903B\u8F91\u53EF\u4EE5\u53CD\u63A8\u533A\u5757\u6821\u9A8C\u3002</p></blockquote><p>\u5230\u76EE\u524D\u4E3A\u6B62\uFF0C\u6211\u4EEC\u5BF9POA\u5171\u8BC6\u673A\u5236\uFF0C\u4EE5\u53CA\u4EE5\u592A\u574Aclique\u7684\u5B9E\u73B0\u6709\u4E86\u6DF1\u523B\u7684\u7406\u89E3\u4E0E\u8BA4\u8BC6\uFF0C\u76F8\u4FE1\u5982\u679C\u8BA9\u6211\u4EEC\u53BB\u5B9E\u73B0\u4E00\u5957POA\uFF0C\u4E5F\u662F\u5B8C\u5168\u6709\u80FD\u529B\u7684\u3002\u5927\u5BB6\u5728\u9605\u8BFB\u672C\u6587\u65F6\u6709\u4EFB\u4F55\u7591\u95EE\u5747\u53EF\u7559\u8A00\u7ED9\u6211\uFF0C\u6211\u4E00\u5B9A\u4F1A\u53CA\u65F6\u56DE\u590D\u3002</p><hr><h2 id="\u603B\u7ED3-\u53C2\u8003" tabindex="-1"><a class="header-anchor" href="#\u603B\u7ED3-\u53C2\u8003" aria-hidden="true">#</a> \u603B\u7ED3&amp;\u53C2\u8003</h2>`,75),w={href:"https://eth.wiki/concepts/ethash/design-rationale",target:"_blank",rel:"noopener noreferrer"},E={href:"https://eth.wiki/concepts/ethash/dag",target:"_blank",rel:"noopener noreferrer"},_={href:"https://www.vijaypradeep.com/blog/2017-04-28-ethereums-memory-hardness-explained/",target:"_blank",rel:"noopener noreferrer"};function V(B,H){const i=u("ExternalLinkIcon");return d(),a("div",null,[e("blockquote",null,[c,e("p",null,[n("\u4EE3\u7801\u5206\u652F\uFF1A"),e("a",t,[n("https://github.com/ethereum/go-ethereum/tree/v1.9.9"),s(i)])])]),o,m,b,p,h,g,e("p",null,[e("a",f,[n("\u5EFA\u7ACB\u79C1\u94FE"),s(i)])]),q,x,k,e("p",null,[n("\u5165\u53E3\u4ECD\u7136\u9009\u62E9"),e("a",y,[n("seal\u65B9\u6CD5"),s(i)]),n("\uFF0C\u8FD9\u91CC\u4E0E\u524D\u6587\u5206\u6790ethash\u7B97\u6CD5\u7684\u5165\u53E3\u662F\u4FDD\u6301\u4E00\u81F4\u7684\uFF0C\u56E0\u4E3A\u4ED6\u4EEC\u662FSeal\u7684\u4E0D\u540C\u5B9E\u73B0\u3002")]),S,e("blockquote",null,[e("p",null,[n("\u8FD9\u91CC\u8981\u8865\u5145\u4E00\u70B9\uFF0C"),e("a",A,[n("\u6316\u77FF\u673A\u5236"),s(i)]),n("\u662F\u4ECEminer.start()\u4F5C\u4E3A\u5165\u53E3\u5F00\u59CB\u5206\u6790\u7684\uFF0C\u800C\u4E0A\u9762\u7684StartMining\u51FD\u6570\u662F\u5728miner.start()\u4E4B\u524D\u7684\u3002\u8FD9\u6837\u5C31\u628A\u6574\u4E2A\u8FD9\u4E00\u6761\u7EBF\u4E32\u8D77\u6765\u4E86\u3002")])]),C,e("blockquote",null,[e("p",null,[e("a",w,[n("https://eth.wiki/concepts/ethash/design-rationale"),s(i)])]),e("p",null,[e("a",E,[n("https://eth.wiki/concepts/ethash/dag"),s(i)])]),e("p",null,[e("a",_,[n("https://www.vijaypradeep.com/blog/2017-04-28-ethereums-memory-hardness-explained/"),s(i)])])])])}const T=r(v,[["render",V],["__file","Etheric_fang_clique_algorithm.html.vue"]]);export{T as default};
